/* dop@0.8.0 - (c) 2016 Josema Gonzalez - MIT Licensed */
!function a(b){function c(a){return"function"==typeof a}function d(a){return null!==a&&"object"==typeof a}function e(a){return Array.isArray(a)}var f={name:"dop",create:a,data:{node_inc:0,node:{},object_inc:1,object:{},collectors:[[],[]]},util:{},core:{},protocol:{},transports:{listen:{},connect:{}},cons:{TOKEN:"~TOKEN_DOP",DOP:"~DOP",SEND:"~SEND",DISCONNECT:"~DISCONNECT",REMOTE_FUNCTION:"$DOP_REMOTE_FUNCTION"}};f.connect=function(a){var b=Array.prototype.slice.call(arguments,0);return"object"!=f.util.typeof(b[0])&&(a=b[0]={}),"function"!=typeof a.transport&&(a.transport=f.transports.connect.websocket),f.core.connector(b)},f.util.emitter=function(){this._events={}},f.util.emitter.prototype.on=function(a,b,e){return c(b)&&(d(this._events)||(this._events={}),d(this._events[a])||(this._events[a]=[]),this._events[a].push(e===!0?[b,!0]:[b])),this},f.util.emitter.prototype.once=function(a,b){return this.on(a,b,!0)},f.util.emitter.prototype.emit=function(a){if(d(this._events[a])&&this._events[a].length>0){for(var b=0,c=[],e=Array.prototype.slice.call(arguments,1);b<this._events[a].length;b++)c.push(this._events[a][b][0]),this._events[a][b][1]===!0&&(this._events[a].splice(b,1),b-=1);for(b=0;b<c.length;b++)c[b].apply(this,e)}return this},f.util.emitter.prototype.removeListener=function(a,b){if(d(this._events[a])&&this._events[a].length>0)for(var c=0;c<this._events[a].length;c++)this._events[a][c][0]===b&&(this._events[a].splice(c,1),c-=1);return this},f.listen=function(a){var b=Array.prototype.slice.call(arguments,0);return"object"!=f.util.typeof(b[0])&&(a=b[0]={}),"function"!=typeof a.transport&&(a.transport=f.transports.listen.local),("number"!=typeof a.try_connects||a.try_connects<0)&&(a.try_connects=99),new f.core.listener(b)},function(a){function b(a,b,f){function j(a){w.readyState===g&&u===i?w.send(a):x.push(a)}function k(){if(w.readyState===g)for(;x.length>0;)w.send(x.shift())}function l(){u===h?w.send(b.tokenServer):(w.send(""),u=g),a.core.emitOpen(b,w,f.transport)}function m(c){u===h&&c.data===b.tokenServer?(u=i,a.core.setSocketToNode(b,w),a.core.emitReconnect(b,oldSocket),k()):a.core.emitMessage(b,c.data,c)}function n(){u=e,a.core.emitClose(b,w)}function o(){u===h&&(a.core.emitDisconnect(b),a.core.setSocketToNode(b,w)),u=i,a.core.emitConnect(b),k()}function p(){u=e,w.close()}function q(){u===e&&(oldSocket=w,w=new v(r),u=h,c(w,l,m,n),d(oldSocket,l,m,n))}var r="ws://localhost:4444/"+a.name;if("string"==typeof f.url)r=f.url.replace("http","ws");else if("undefined"!=typeof window&&/http/.test(window.location.href)){var s=/(ss|ps)?:\/\/([^\/]+)\/?(.+)?/.exec(window.location.href),t=s[1]?"wss":"ws";r=t+"://"+s[2].toLocaleLowerCase()+"/"+a.name}var u,v=f.transport.getApi(),w=new v(r),x=[];return a.core.setSocketToNode(b,w),u=e,b.reconnect=q,b.on(a.cons.CONNECT,o),b.on(a.cons.SEND,j),b.on(a.cons.DISCONNECT,p),c(w,l,m,n),w}function c(a,b,c,d){a.addEventListener("open",b),a.addEventListener("message",c),a.addEventListener("close",d)}function d(a,b,c,d){a.removeEventListener("open",b),a.removeEventListener("message",c),a.removeEventListener("close",d)}"undefined"==typeof f&&"object"==typeof module&&module.exports?module.exports=b:(b.getApi=function(){return window.WebSocket},"undefined"!=typeof f?f.transports.connect.websocket=b:a.dopTransportsConnectWebsocket=b);var e=0,g=1,h=2,i=3}(this),f.util.get=function(a,b){if(0===b.length)return a;for(var c=0,e=b.length;c<e;c++){if(!(c+1<e&&d(a[b[c]])))return a.hasOwnProperty(b[c])?a[b[c]]:void 0;a=a[b[c]]}return a[b[c]]},f.util.invariant=function(a){if(!a){var b=f.util.sprintf.apply(this,Array.prototype.slice.call(arguments,1));throw new Error("[dop] Invariant failed: "+b)}},f.util.merge=function(a,b){var c=arguments;return c.length>2?(Array.prototype.splice.call(c,0,2,f.util.merge.call(this,a,b)),f.util.merge.apply(this,c)):f.util.path(b,this,a,f.util.mergeMutator)},f.util.mergeMutator=function(a,b,c,d){"object"==d||"array"==d?a.hasOwnProperty(b)?a[b]:a[b]="array"==d?[]:{}:a[b]=c},f.util.path=function(a,b,e,g){var h=c(b),i=d(e);return f.util.pathRecursive(a,b,e,g,[],[],h,i),e},f.util.pathRecursive=function(a,b,c,d,e,g,h,i){var j,k,l,m;for(j in a)m=!1,k=a[j],g.push(j),h&&(m=b(a,j,k,c,g,this)),m!==!0&&(l=f.util.typeof(k),i&&(m=d(c,j,k,l,g)),"object"!=l&&"array"!=l||m===!0||k===a||e.indexOf(k)!=-1||(e.push(k),f.util.pathRecursive(k,b,i?c[j]:void 0,d,e,g,h,i)),g.pop())},f.util.sprintf=function(){var a,b=-1,c=arguments[0],d=Array.prototype.slice.call(arguments,1);return c.replace(/"/g,"'").replace(/%([0-9]+)|%s/g,function(){return a=d[void 0===arguments[1]||""===arguments[1]?++b:arguments[1]],void 0===a&&(a=arguments[0]),a})},f.util.typeof=function(a){var b=typeof a;return"object"==b&&(a?e(a)?b="array":a instanceof Date?b="date":a instanceof RegExp&&(b="regexp"):b="null"),b},f.util.uuid=function(){for(var a,b=0,c="";b<32;b++)a=16*Math.random()|0,8!==b&&12!==b&&16!==b&&20!==b||(c+="-"),c+=(12===b?4:16===b?3&a|8:a).toString(16);return c},f.collect=function(a){return f.util.invariant(0===arguments.length||arguments.length>0&&c(a),"dop.collect only accept one argument as function"),f.core.createCollector(f.data.collectors[0],f.data.collectors[0].length,a)},f.collectFirst=function(a){return f.util.invariant(0===arguments.length||arguments.length>0&&c(a),"dop.collectFirst only accept one argument as function"),f.core.createCollector(f.data.collectors[0],0,a)},f.decode=function(a,b){var c,d=[],e=0,g=JSON.parse(a,function(a,c){return f.core.decode.call(this,a,c,b,d)});for(c=d.length,e=0;e<c;++e)d[e][0][d[e][1]]=void 0;return g},f.del=function(a,b){return f.isRegistered(a)?void 0!==f.core.delete(a,b):delete a[b]},f.emit=function(a,b){a.length>0&&f.core.emitObservers(a)&&(void 0===b&&(b=f.getAction(a)),f.core.emitNodes(b))},f.encode=function(a,b){return"function"!=typeof b&&(b=f.core.encode),JSON.stringify(a,b)},f.encodeFunction=function(a){return JSON.stringify(a,f.core.encodeFunction)},f.getAction=function(a){for(var b,c,d={},e=0,g=a.length;e<g;++e)b=a[e],f.core.objectIsStillStoredOnPath(b.object)&&(c=f.getObjectId(b.object),void 0===d[c]&&(d[c]={object:f.getObjectRoot(b.object),action:{}}),f.core.injectMutationInAction(d[c].action,b));return d},f.getNodeBySocket=function(a){return f.data.node[a[f.cons.TOKEN]]},f.getObjectDop=function(a){if(d(a))return a[f.cons.DOP]},f.getObjectId=function(a){var b=f.getObjectDop(a);return b?b[0]:void 0},f.getObjectParent=function(a){var b=f.getObjectDop(a);return b?b._:void 0},f.getObjectProperty=function(a){var b=f.getObjectDop(a);return b[b.length-1]},f.getObjectProxy=function(a){return f.getObjectDop(a).p},f.getObjectRoot=function(a){for(;void 0!==f.getObjectParent(a);)a=f.getObjectParent(a);return f.getObjectProxy(a)},f.getObjectTarget=function(a){return f.getObjectDop(a).t},f.getUnaction=function(a){for(var b,c,d={},e=a.length-1;e>-1;--e)c=a[e],b=f.getObjectId(c.object),void 0===d[b]&&(d[b]={object:f.getObjectRoot(c.object),action:{}}),f.core.injectMutationInAction(d[b].action,c,!0);return d},f.isObjectRegistrable=function(a){var b=f.util.typeof(a);return"object"===b||"array"==b},f.isProxy=function(a){return f.isRegistered(a)&&f.getObjectProxy(a)===a},f.isRegistered=function(a){if(d(a)){var b=f.getObjectDop(a);if(e(b)&&b.hasOwnProperty("p"))return!0}return!1},f.isRemoteFunction=function(a){return c(a)&&a.name===f.cons.REMOTE_FUNCTION},f.isTarget=function(a){return f.isRegistered(a)&&f.getObjectTarget(a)===a},f.observe=function(a,b){if(f.util.invariant(f.isRegistered(a),"dop.observe needs a registered object as first parameter"),f.util.invariant(c(b),"dop.observe needs a callback as second parameter"),f.getObjectDop(a).o.indexOf(b)==-1)return f.getObjectDop(a).o.push(b),function(){return f.unobserve(a,b)}},f.observeProperty=function(a,b,d){f.util.invariant(f.isRegistered(a),"dop.observeProperty needs a registered object as first parameter"),f.util.invariant(c(d),"dop.observeProperty needs a callback as third parameter"),"object"!=f.util.typeof(f.getObjectDop(a).op)&&(f.getObjectDop(a).op={});var e="array"!=f.util.typeof(f.getObjectDop(a).op[b])?f.getObjectDop(a).op[b]=[]:f.getObjectDop(a).op[b];if(e.indexOf(d)==-1)return e.push(d),function(){return f.unobserveProperty(a,b,d)}},f.onsubscribe=function(a){f.util.invariant(c(a),"dop.onsubscribe only accept a function as parameter"),f.data.onsubscribe=a},f.register=function(a,b){if(f.util.invariant(f.isObjectRegistrable(a),"dop.register needs a regular object as first parameter"),f.isRegistered(a))return f.getObjectProxy(a);var c=f.data.object_inc++;return a=f.core.configureObject(a,[c])},f.set=function(a,b,c){return f.isRegistered(a)?f.core.set(a,b,c):a[b]=c,c},f.setAction=function(a){var b,c=f.collectFirst();for(b in a)f.core.setAction(a[b].object,a[b].action);return c},f.unobserve=function(a,b){f.util.invariant(f.isRegistered(a),"dop.unobserve needs a registered object as first parameter"),f.util.invariant(c(b),"dop.unobserve needs a callback as second parameter");var d,e=f.getObjectDop(a).o;return"array"==f.util.typeof(e)&&(d=e.indexOf(b),d!=-1&&(e.splice(d,1),0==e.length&&delete f.getObjectDop(a).o,!0))},f.unobserveProperty=function(a,b,d){f.util.invariant(f.isRegistered(a),"dop.unobserveProperty needs a registered object as first parameter"),f.util.invariant(c(d),"dop.unobserveProperty needs a callback as second parameter");var e,g=f.getObjectDop(a).op;return"object"==f.util.typeof(g)&&"array"==f.util.typeof(g[b])&&(g=g[b],e=g.indexOf(d),e!=-1&&(g.splice(e,1),0==g.length&&delete f.getObjectDop(a).op[b],!0))},f.core.emitClose=function(a,b){a.listener&&a.listener.emit("close",b),a.emit("close",b)},f.core.emitConnect=function(a){a.connected=!0,a.listener&&a.listener.emit("connect",a),a.emit("connect"),f.core.sendMessages(a)},f.core.emitDisconnect=function(a){a.connected=!1,a.listener&&(f.core.unregisterNode(a),a.listener.emit("disconnect",a)),a.emit("disconnect")},f.core.emitMessage=function(a,b,g){a.listener&&a.listener.emit("message",a,b,g),a.emit("message",b,g);var h;if("string"==typeof b&&"["==b.substr(0,1))try{h=f.decode(b,a)}catch(a){}else h=b;if(e(h)){"number"==typeof h[0]&&(h=[h]);for(var i,j,k,l,m,n,o,p=0,q=h.length;p<q;p++)if(i=h[p],l=i[0],"number"==typeof l&&0!==l){o=f.util.typeof(i[1]),j="number"==o&&"array"!=o||l<0?[l,i.slice(1)]:j=i;for(var r,s=1,t=j.length;s<t;++s)k=j[s],"array"==f.util.typeof(k)&&("number"==typeof k[0]&&l>0||l<0)&&(n=k[0],r="on"+f.protocol.instructions[n],l>0&&c(f.protocol[r])?f.protocol[r](a,l,k):(l*=-1,d(a.requests[l])&&(m=k,k=a.requests[l],n=k[1],r="_on"+f.protocol.instructions[n],c(f.protocol[r])&&f.protocol[r](a,l,k,m),delete a.requests[l])))}}},f.core.emitOpen=function(a,b,c){var d;return a instanceof f.core.node?d=a:(d=new f.core.node,d.listener=a,d.try_connects=a.options.try_connects),d.transport=c,f.core.registerNode(d),a.emit("open",b),d},f.core.emitReconnect=function(a,b,c){a.listener&&(f.core.unregisterNode(c),a.listener.emit("reconnect",a,b)),a.emit("reconnect",b),f.core.sendMessages(a)},f.core.collector=function(a,b){this.active=!0,this.shallWeGenerateAction=!0,this.shallWeGenerateUnaction=!0,this.mutations=[],this.queue=a,a.splice(b,0,this)},f.core.collector.prototype.add=function(a){return!(!this.active||void 0!==this.filter&&this.filter(a)!==!0)&&(this.shallWeGenerateAction=!0,this.shallWeGenerateUnaction=!0,this.mutations.push(a),!0)},f.core.collector.prototype.emit=function(){var a=this.mutations;return f.emit(a,this.action),this.mutations=[],a},f.core.collector.prototype.destroy=function(){this.active=!1,this.queue.splice(this.queue.indexOf(this),1)},f.core.collector.prototype.emitAndDestroy=function(){return this.destroy(),this.emit()},f.core.collector.prototype.getAction=function(){return this.shallWeGenerateAction&&(this.shallWeGenerateAction=!1,this.action=f.getAction(this.mutations)),this.action},f.core.collector.prototype.getUnaction=function(){return this.shallWeGenerateUnaction&&(this.shallWeGenerateUnaction=!1,this.unaction=f.getUnaction(this.mutations)),this.unaction},f.core.listener=function(a){f.util.merge(this,new f.util.emitter),a.unshift(f,this),this.options=a[2],this.transport=this.options.transport,this.listener=this.options.transport.apply(this,a)},f.core.node=function(){f.util.merge(this,new f.util.emitter),this.connected=!1,this.request_inc=1,this.requests={},this.message_queue=[],this.subscriber={},this.owner={};do this.token=f.util.uuid();while("object"==typeof f.data.node[this.token])},f.core.node.prototype.send=function(a){this.emit(f.cons.SEND,a)},f.core.node.prototype.disconnect=function(){this.emit(f.cons.DISCONNECT)},f.core.node.prototype.subscribe=function(){return f.protocol.subscribe(this,arguments)},f.core.node.prototype.unsubscribe=function(a){return f.protocol.unsubscribe(this,a)},f.core.error={reject_local:{OBJECT_NOT_FOUND:"Object not found",NODE_NOT_FOUND:"Node not found"},reject_remote:{OBJECT_NOT_FOUND:1,1:"Remote object not found or not permissions to be subscribed",SUBSCRIPTION_NOT_FOUND:2,2:"Subscription not found to unsubscribe this object",FUNCTION_NOT_FOUND:3,3:"Remote function not found to be called",CUSTOM_REJECTION:4}},f.core.delete=function(a,b){var c=Object.getOwnPropertyDescriptor(a,b);if(c&&c.configurable){var d=f.getObjectTarget(a),e=f.getObjectProxy(a);if(d===e||a===e){var g={object:f.getObjectProxy(d),name:b,oldValue:d[b]};f.core.storeMutation(g)}return delete d[b]}},f.core.pop=function(a){if(0!==a.length){var b=f.core.splice(a,[a.length-1,1]);return b[0]}},f.core.push=function(a,b){if(0===b.length)return a.length;b.unshift(a.length,0);f.core.splice(a,b);return a.length},f.core.reverse=function(a){for(var b,c=f.getObjectTarget(a),d=f.getObjectProxy(a),e=c.length/2,g=0,h=[],i=c===d||a===d;g<e;++g)b=c.length-g-1,g!==b&&(tempItem=c[b],c[b]=c[g],c[g]=tempItem,i&&h.push(g,b),f.core.updatePathArray(c,g),f.core.updatePathArray(c,b));return i&&h.length>0&&f.core.storeMutation({object:d,swaps:h}),a},f.core.set=function(a,b,c){if(a[b]!==c){var d=Object.getOwnPropertyDescriptor(a,b);if(!d||d&&d.writable){var g=f.getObjectTarget(a),h=f.getObjectProxy(a),i=g[b],j=g.length,k=g.hasOwnProperty(b);if(g[b]=c,f.isObjectRegistrable(c)&&(g[b]=f.core.configureObject(c,f.getObjectDop(g).concat(b),g)),g===h||a===h){var l={object:h,name:b,value:c};return k&&(l.oldValue=i),e(g)&&(l.length=j),e(c)&&(l.valueOriginal=f.util.merge([],c)),f.core.storeMutation(l),l}}}},f.core.shift=function(a){if(0!==a.length){var b=f.core.splice(a,[0,1]);return b[0]}},f.core.sort=function(a,b){var c,d,e=f.getObjectTarget(a),g=f.getObjectProxy(a),h=e.slice(0);return c=Array.prototype.sort.call(e,b),d=f.core.sortDiff(e,h),d.length>1&&(e===g||a===g)&&f.core.storeMutation({object:g,swaps:d}),c},f.core.sortDiff=function(a,b){for(var c,d,e=b.length,g=[],h=0;h<e;++h)a[h]!==b[h]&&(c=b.indexOf(a[h]),d=b[h],b[h]=b[c],b[c]=d,g.push(h,c),f.core.updatePathArray(b,h),f.core.updatePathArray(b,c));return g},f.core.splice=function(a,b){var c,d=a.length,e=f.getObjectTarget(a),g=f.getObjectProxy(a);if(c=Array.prototype.splice.apply(e,b),e===g||a===g){var h,i,j,k=b.length,l=e.length,m=Number(b[0]),n=Number(b[1])>0?b[1]:0,o=b.length>2?b.length-2:0;for(isNaN(m)?m=0:m<0?m=l+m<0?0:l+m:m>d&&(m=d),h=1===k?0:k>2&&n===o?m+n:e.length;m<h;++m)i=e[m],f.isObjectRegistrable(i)&&(j=f.getObjectDop(i),void 0!==j&&j._===e?j[j.length-1]=m:e[m]=f.core.configureObject(i,f.getObjectDop(e).concat(m),e));if(d!==l||o>0){b[0]<0&&(b[0]=a.length+b[0]);var p={object:g,splice:b};c.length>0&&(p.spliced=c),f.core.storeMutation(p)}}return c},f.core.swap=function(a,b){if(b.length>1){for(var c,d,e,g=f.getObjectTarget(a),h=f.getObjectProxy(a),i=0,j=b.length-1;i<j;i+=2)d=b[i],e=b[i+1],c=g[d],g[d]=g[e],g[e]=c,f.core.updatePathArray(g,d),f.core.updatePathArray(g,e);return g!==h&&a!==h||f.core.storeMutation({object:h,swaps:b}),a}},f.core.unshift=function(a,b){if(0===b.length)return a.length;b.unshift(0,0);f.core.splice(a,b);return a.length};var g="function"==typeof Proxy;f.core.configureObject=function(a,b,h){if(f.isRegistered(a))return f.core.configureObject(f.util.merge(e(a)?[]:{},a),b,h);delete a[f.cons.DOP];var i,j,k;for(i in a)j=a[i],c(j)&&j.name==f.core.createRemoteFunction.name?a[i]=j(b[0],b.slice(1).concat(i)):f.isObjectRegistrable(j)&&(a[i]=f.core.configureObject(j,b.concat(i),a));if(Object.defineProperty(a,f.cons.DOP,{value:b.slice(0)}),k=f.getObjectDop(a),k.m=[],k.o=[],k.op={},d(h)&&(k._=f.isRegistered(h)?f.getObjectTarget(h):h),g){var l=a;a=new Proxy(a,f.core.proxyObjectHandler),k.p=a,k.t=l}else k.p=k.t=a;return"array"==f.util.typeof(a)&&Object.defineProperties(a,f.core.proxyArrayHandler),a},f.core.createCollector=function(a,b,c){var d=new f.core.collector(a,b);return d.filter=c,d},f.core.emitObservers=function(a){for(var b,c,d,e,g,h,i,j=[],k=0,l=a.length,m=!1;k<l;++k){if(b=a[k],c=b.object,g=f.getObjectDop(c),m||(m=!0),h=g.op[b.name],"array"==f.util.typeof(h)&&h.length>0)for(d=0,e=h.length;d<e;++d)h[d](b);if(j.indexOf(c)===-1){for(j.push(c),i=g.o,d=0,e=i.length;d<e;++d)i[d](g.m.slice(0));g.m=[]}}return m},f.core.injectMutationInAction=function(a,b,c){var g,h=void 0!==b.splice||void 0!==b.swaps,i=f.getObjectDop(b.object).slice(0),j=b.name,k=c?b.oldValue:b.value,l=f.util.typeof(k),m=1;for(h||i.push(j);m<i.length-1;++m)g=a,j=i[m],a=d(a[j])?a[j]:a[j]={};if(j=i[m],h||e(b.object)){i.length>1&&(h&&!d(a[j])&&(a[j]={}),h&&(a=a[j])),d(a[f.cons.DOP])||(a[f.cons.DOP]=[]);var n=a[f.cons.DOP];if(void 0!==b.swaps){var o=b.swaps.slice(0);c&&o.reverse();var p=o[0]>0?0:1;o[p]=o[p]*-1,n.push(o)}else if(void 0!==b.splice){var q;c?(q=b.spliced?b.spliced.slice(0):[],q.unshift(b.splice[0],b.splice.length-2)):q=b.splice.slice(0),n.push(q)}else n.push([j,1,k]);c&&void 0!==b.length&&b.length!==b.object.length&&(a.length=b.length)}else a[j]="object"==l||"array"==l?f.util.merge("array"==l?[]:{},k):k},f.core.objectIsStillStoredOnPath=function(a){for(var b,c=f.getObjectDop(a),d=c.length-1;d>0;--d)if(d>1){if(b=f.getObjectParent(a),b[c[d]]!==a)return!1;a=f.getObjectProxy(b)}return!0},f.core.proxyArrayHandler={splice:{value:function(){return f.core.splice(this,Array.prototype.slice.call(arguments,0))}},shift:{value:function(){return f.core.shift(this,Array.prototype.slice.call(arguments,0))}},pop:{value:function(){return f.core.pop(this,Array.prototype.slice.call(arguments,0))}},push:{value:function(){return f.core.push(this,Array.prototype.slice.call(arguments,0))}},unshift:{value:function(){return f.core.unshift(this,Array.prototype.slice.call(arguments,0))}},reverse:{value:function(){return f.core.reverse(this)}},sort:{value:function(a){return f.core.sort(this,a)}}},f.core.proxyObjectHandler={set:function(a,b,c){return void 0!==f.core.set(f.getObjectProxy(a),b,c)},deleteProperty:function(a,b){return void 0!==f.core.delete(f.getObjectProxy(a),b)}},f.core.setAction=function(a,b){return f.util.path({a:b},null,{a:a},f.core.setActionMutator),a},f.core.setActionFunction=function(a,b){return f.util.path({a:b},null,{a:a},function(b,d,e,g,h){return c(e)&&e.name==f.core.createRemoteFunction.name?void f.set(b,d,e(f.getObjectDop(a)[0],h.slice(1))):f.core.setActionMutator(b,d,e,g,h)}),a},f.core.setActionMutator=function(a,b,c,d,e){var g=f.util.typeof(a[b]);if("object"==d&&"array"==g&&c.hasOwnProperty(f.cons.DOP)){for(var h,i=c[f.cons.DOP],j=0,k=i.length;j<k;++j)h=i[j],h[0]<0||h[1]<0?(h=h.slice(0),h[0]<0?h[0]=h[0]*-1:h[1]=h[1]*-1,f.core.swap(a[b],h)):(a[b].length<h[0]&&(f.getObjectTarget(a[b]).length=h[0]),3===h.length&&1===h[1]?void 0===h[2]?f.del(a[b],h[0]):f.set(a[b],h[0],h[2]):f.core.splice(a[b],h));return"number"==typeof c.length&&c.length>-1&&(a[b].length=c.length),!0}if("object"!=d||a.hasOwnProperty(b))if("undefined"==d)f.del(a,b);else{if("array"==d)return f.set(a,b,f.util.merge([],c)),!0;if("object"==d&&"object"!=g&&"array"!=g)return f.set(a,b,f.util.merge({},c)),!0;"object"!=d&&f.set(a,b,c)}else f.set(a,b,{})},f.core.storeMutation=function(a){var b,c=f.data.collectors,d=0,e=c.length,g=0;for(f.getObjectDop(a.object).m.push(a);d<e;d++)if(c[d].length>0)for(g=0,b=c[d].length;g<b;g++)if(c[d][g].add(a))return;return f.emit([a])},f.core.updatePathArray=function(a,b){var c=a[b];if(f.isRegistered(c)){var e=f.getObjectDop(c),g=e.length-1;e[g]!==b&&(e[g]=b,f.util.path(c,function(a,c,e){d(e)&&(f.getObjectDop(e)[g]=b)}))}return!1},f.core.connector=function(a){var b=new f.core.node;return a.unshift(f,b),b.options=a[2],b.transport=b.options.transport,b.options.transport.apply(this,a),b},f.core.createAsync=function(){var a,b,c=new Promise(function(c,d){a=c,b=d});return c.resolve=a,c.reject=b,c},f.core.createRemoteFunction=function(a){return function(b,c){return function(){return f.protocol.call(a,b,c,arguments)}}},f.core.createRequest=function(a,b){var c=a.request_inc++,d=Array.prototype.slice.call(arguments,1);return a.requests[c]=d,d.unshift(c),d.promise=f.core.createAsync(),d},f.core.createResponse=function(){return arguments[0]=arguments[0]*-1,Array.prototype.slice.call(arguments,0)};var h=/^\d\d\d\d-\d\d-\d\dT\d\d:\d\d:\d\d.\d\d\dZ$/,i=/\/(.+)\/([gimuy]{0,5})/;f.core.decode=function(a,b,c,e){if("string"==typeof b){if("~F"===b)return f.core.createRemoteFunction(c);if("~U"==b&&d(e))return void e.push([this,a]);if("~I"===b)return 1/0;if("~i"===b)return-(1/0);if("~N"===b)return NaN;if(h.exec(b))return new Date(b);if("~R"==b.substr(0,2)){var g=i.exec(b.substr(2));return new RegExp(g[1],g[2])}if("~"===b[0])return b.substring(1)}return b},f.core.emitNodes=function(a){},f.core.encode=function(a,b){var c=typeof b;return"undefined"==c?"~U":"string"==c&&"~"==b[0]?"~"+b:"number"==c&&isNaN(b)?"~N":"object"==c&&b instanceof RegExp?"~R"+b.toString():b===1/0?"~I":b===-(1/0)?"~i":b},f.core.encodeFunction=function(a,b){return c(b)?"~F":f.core.encode(a,b)},f.core.getRejectError=function(a){if("number"==typeof a&&void 0!==f.core.error.reject_remote[a]){var b=Array.prototype.slice.call(arguments,1);return b.unshift(f.core.error.reject_remote[a]),f.util.sprintf.apply(this,b)}return a},f.core.localProcedureCall=function(a,b,d,e,g,h){var i,j=f.core.createAsync();c(g)&&(j=g(j)),b.push(j),j.then(d).catch(e),i=a.apply(h||j,b),i!==j&&j.resolve(i)},f.core.registerNode=function(a){f.data.node[a.token]=a},f.core.registerObjectToNode=function(a,b){var c,d=f.getObjectId(b);return void 0===f.data.object[d]&&(f.data.object[d]={object:b,nodes_total:0,node:{}}),c=f.data.object[d],void 0===c.node[a.token]&&(c.nodes_total+=1,c.node[a.token]={subscriber:0,owner:0,subscriber_version:0,owner_version:0}),c},f.core.registerOwner=function(a,b,c){var d=f.core.registerObjectToNode(a,b),e=f.getObjectId(d.object);d.node[a.token].owner=c,a.owner[c]=e},f.core.registerSubscriber=function(a,b){var c=f.core.registerObjectToNode(a,b),d=f.getObjectId(c.object);return a.subscriber[d]=!0,!c.node[a.token].subscriber&&(c.node[a.token].subscriber=1,!0)},f.core.sendMessages=function(a){var b=a.message_queue.length;if(b>0&&a.connected){for(var c,d=0,e=[];d<b;++d)e.push(a.message_queue[d][1](a.message_queue[d][0]));c=d>1?"["+e.join(",")+"]":e[0],a.message_queue=[],a.send(c)}},f.core.setSocketToNode=function(a,b){a.socket=b,b[f.cons.TOKEN]=a.token},f.core.storeMessage=function(a,b,c){"function"!=typeof c&&(c=f.encode),a.message_queue.push([b,c])},f.core.storeSendMessages=function(a,b,c){f.core.storeMessage(a,b,c),f.core.sendMessages(a)},f.core.unregisterNode=function(a){var b,c,d;for(b in a.subscriber)d=f.data.object[b],void 0!==d.node[a.token]&&(d.nodes_total-=1,delete d.node[a.token]);for(c in a.owner)b=a.owner[c],d=f.data.object[b],void 0!==d.node[a.token]&&(d.nodes_total-=1,delete d.node[a.token]);void 0!==d&&0===d.nodes_total&&delete f.data.object[b],delete f.data.node[a.token]},f.protocol._onsubscribe=function(a,b,c,g){if(void 0!==g[0])if(0!==g[0])c.promise.reject(f.core.getRejectError(g[0]));else{var h,i,j="number"==typeof g[1]?[g[1]]:g[1],k=j[0],l=g[2];e(j)&&"number"==typeof k?(void 0===a.owner[k]?(i=f.collectFirst(),h=f.isRegistered(c.into)?f.core.setActionFunction(c.into,l):f.register(void 0===c.into?l:f.core.setAction(c.into,l)),f.core.registerOwner(a,h,k),i.emitAndDestroy()):h=f.data.object[a.owner[k]].object,h=f.util.get(h,j.slice(1)),d(h)?c.promise.resolve(f.getObjectProxy(h)):c.promise.reject(f.core.error.reject_local.OBJECT_NOT_FOUND)):c.promise.reject(f.core.error.reject_local.OBJECT_NOT_FOUND)}},f.protocol._onunsubscribe=function(a,b,c,e){if(void 0!==e[0])if(0!==e[0])c.promise.reject(e[0]);else{var g=c[2],h=a.owner[g],i=f.data.object[h];if(d(i)&&d(i.node[a.token])&&i.node[a.token].owner===g){var j=i.node[a.token];j.owner=0,0===j.subscriber&&(i.nodes_total-=1),0===i.nodes_total&&delete f.data.object[h],c.promise.resolve()}}},f.protocol.call=function(a,b,c,e){var g=f.data.object[b];if(d(g)&&d(g.node[a.token])&&g.node[a.token].owner>0){e=Array.prototype.slice.call(e,0);var h=f.core.createRequest(a,f.protocol.instructions.call,g.node[a.token].owner,c,e);return f.core.storeSendMessages(a,h),h.promise}return Promise.reject(f.core.error.reject_local.NODE_NOT_FOUND)},f.protocol.oncall=function(a,b,e){function g(c){var d=f.core.createResponse(b,0);return void 0!==c&&d.push(c),f.core.storeSendMessages(a,d),c}function h(c){f.core.storeSendMessages(a,f.core.createResponse(b,f.core.error.reject_remote.CUSTOM_REJECTION,c))}var i=e[1],j=e[2],k=e[3],l=f.data.object[i];if(d(l)&&d(l.node[a.token])&&l.node[a.token].subscriber){var m=j.pop(),n=f.util.get(l.object,j),o=n[m];if(c(o))return void(f.isRemoteFunction(o)?o.apply(null,k).then(g).catch(h):f.core.localProcedureCall(o,k,g,h,function(b){return b.node=a,b},n))}f.core.storeSendMessages(a,f.core.createResponse(b,f.core.error.reject_remote.FUNCTION_NOT_FOUND))},f.protocol._oncall=function(a,b,c,d){var e=d[0],g=c.promise;void 0!==e&&(0===e?g.resolve(d[1]):e===f.core.error.reject_remote.CUSTOM_REJECTION?g.reject(d[1]):g.reject(f.core.getRejectError(e)))},f.protocol.instructions={subscribe:1,unsubscribe:2,call:3,mutation:4};for(var j in f.protocol.instructions)f.protocol.instructions[f.protocol.instructions[j]]=j;return f.protocol.mutation=function(a,b,c){console.log(a.token,b,c)},f.protocol.onsubscribe=function(a,b,e){function g(c){var d=f.core.createResponse(b);c instanceof Error?console.log(c.stack):d.push(c),f.core.storeSendMessages(a,d,JSON.stringify)}if(c(f.data.onsubscribe)){var h=Array.prototype.slice.call(e,1);f.core.localProcedureCall(f.data.onsubscribe,h,function(c){if(d(c)){var e=f.register(c),g=(f.getObjectId(e),f.getObjectRoot(e)),h=f.getObjectDop(e),i=f.core.createResponse(b,0,1==h.length?h[0]:h);return f.core.registerSubscriber(a,g)&&i.push(g),f.core.storeSendMessages(a,i,f.encodeFunction),e}return void 0===c?Promise.reject(f.core.error.reject_remote.OBJECT_NOT_FOUND):void f.util.invariant(!1,"dop.onsubscribe callback must return or resolve a regular object")},g,function(b){return b.node=a,b})}else g(f.core.error.reject_remote.OBJECT_NOT_FOUND)},f.protocol.onunsubscribe=function(a,b,c){var e=c[1],g=f.data.object[e],h=f.core.createResponse(b);if(d(g)&&d(g.node[a.token])&&g.node[a.token].subscriber){var i=g.node[a.token];i.subscriber=0,0===i.owner&&(g.nodes_total-=1),0===g.nodes_total&&delete f.data.object[e],h.push(0)}else h.push(f.core.error.reject_remote.SUBSCRIPTION_NOT_FOUND);f.core.storeSendMessages(a,h)},f.protocol.subscribe=function(a,b){b=Array.prototype.slice.call(b,0),b.unshift(a,f.protocol.instructions.subscribe);var c=f.core.createRequest.apply(a,b);return c.promise.into=function(a){return f.isObjectRegistrable(a)&&(c.into=a),c.promise},f.core.storeSendMessages(a,c),c.promise},f.protocol.unsubscribe=function(a,b){var c=f.getObjectId(b),e=f.data.object[c];if(d(e)&&d(e.node[a.token])&&e.node[a.token].owner>0){var g=f.core.createRequest(a,f.protocol.instructions.unsubscribe,e.node[a.token].owner);return f.core.storeSendMessages(a,g),g.promise}return Promise.reject(f.core.error.reject_remote[2])},void 0===b?f:void("function"==typeof define&&define.amd?define([],function(){return f}):"object"==typeof module&&module.exports?module.exports=f:window&&"object"==typeof window?window.dop=f:b.dop=f)}(this);