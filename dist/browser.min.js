/* dop@0.20.0 - (c) 2016 Josema Gonzalez - MIT Licensed */
!function a(b){function c(a){return"function"==typeof a}function d(a){return null!==a&&"object"==typeof a}function e(a){return Array.isArray(a)}function f(a){return"number"==typeof a}var g={name:"dop",create:a,data:{node_inc:0,node:{},object_inc:1,object:{},collectors:[[],[]],observers:{},observers_inc:0},util:{},core:{},protocol:{},transports:{listen:{},connect:{}},cons:{TOKEN:"~TOKEN_DOP",DOP:"~DOP",SEND:"~SEND",DISCONNECT:"~DISCONNECT",REMOTE_FUNCTION:"$DOP_REMOTE_FUNCTION",BROADCAST_FUNCTION:"$DOP_BROADCAST_FUNCTION"}};g.connect=function(a){var b=Array.prototype.slice.call(arguments,0);return"object"!=g.util.typeof(b[0])&&(a=b[0]={}),"function"!=typeof a.transport&&(a.transport=g.transports.connect.websocket),g.core.connector(b)},g.util.emitter=function(){this._events={}},g.util.emitter.prototype.on=function(a,b,e){return c(b)&&(d(this._events)||(this._events={}),d(this._events[a])||(this._events[a]=[]),this._events[a].push(!0===e?[b,!0]:[b])),this},g.util.emitter.prototype.once=function(a,b){return this.on(a,b,!0)},g.util.emitter.prototype.emit=function(a){if(d(this._events[a])&&this._events[a].length>0){for(var b=0,c=[],e=Array.prototype.slice.call(arguments,1);b<this._events[a].length;b++)c.push(this._events[a][b][0]),!0===this._events[a][b][1]&&(this._events[a].splice(b,1),b-=1);for(b=0;b<c.length;b++)c[b].apply(this,e)}return this},g.util.emitter.prototype.removeListener=function(a,b){if(d(this._events[a])&&this._events[a].length>0)for(var c=0;c<this._events[a].length;c++)this._events[a][c][0]===b&&(this._events[a].splice(c,1),c-=1);return this},g.listen=function(a){var b=Array.prototype.slice.call(arguments,0);return"object"!=g.util.typeof(b[0])&&(a=b[0]={}),"function"!=typeof a.transport&&(a.transport=g.transports.listen.local),new g.core.listener(b)},function(b){function c(a,b,c){function g(a){x.readyState===h?x.send(a):y.push(a)}function k(){if(x.readyState===h)for(;y.length>0;)x.send(y.shift())}function l(){v===i?x.send(u):(x.send(""),v=h),a.core.emitOpen(b,x,c.transport)}function m(c){v===i&&c.data===u?(v=j,a.core.setSocketToNode(b,x),a.core.emitReconnect(b,q),k()):v!==j?(u=c.data,v=j,a.core.setSocketToNode(b,x),g(u),k(),a.core.emitConnect(b)):a.core.emitMessage(b,c.data,c)}function n(){v=f,a.core.emitClose(b,x),a.core.emitDisconnect(b)}function o(){v=f,x.close()}function p(){v===f&&(q=x,x=new w(r),v=i,d(x,l,m,n),e(q,l,m,n))}var q,r="ws://localhost:4444/"+a.name;if("string"==typeof c.url)r=c.url.replace("http","ws");else if("undefined"!=typeof window&&/http/.test(window.location.href)){var s=/(ss|ps)?:\/\/([^\/]+)\/?(.+)?/.exec(window.location.href),t=s[1]?"wss":"ws";r=t+"://"+s[2].toLocaleLowerCase()+"/"+a.name}var u,v,w=c.transport.getApi(),x=new w(r),y=[];return a.core.setSocketToNode(b,x),v=f,b.reconnect=p,b.on(a.cons.SEND,g),b.on(a.cons.DISCONNECT,o),d(x,l,m,n),x}function d(a,b,c,d){a.addEventListener("open",b),a.addEventListener("message",c),a.addEventListener("close",d)}function e(a,b,c,d){a.removeEventListener("open",b),a.removeEventListener("message",c),a.removeEventListener("close",d)}"object"!=typeof module||!module.exports||"object"==typeof g&&"function"==typeof a&&g.create===a?(c.getApi=function(){return window.WebSocket},void 0!==g?g.transports.connect.websocket=c:b.dopTransportsConnectWebsocket=c):module.exports=c;var f=0,h=1,i=2,j=3}(this),g.util.clone=function(a){return g.isObjectRegistrable(a)?g.util.merge(e(a)?[]:{},a):a},g.util.get=function(a,b){if(0===b.length)return a;for(var c=0,e=b.length;c<e;c++){if(!(c+1<e&&d(a[b[c]])))return a.hasOwnProperty(b[c])?a[b[c]]:void 0;a=a[b[c]]}return a[b[c]]},g.util.invariant=function(a){if(!a){var b=g.util.sprintf.apply(this,Array.prototype.slice.call(arguments,1));throw new Error("[dop] Invariant failed: "+b)}},g.util.merge=function(a,b){var c=arguments;return c.length>2?(Array.prototype.splice.call(c,0,2,g.util.merge.call(this,a,b)),g.util.merge.apply(this,c)):(g.util.path(b,this,a,g.util.mergeMutator),e(b)&&(a.length=b.length),a)},g.util.mergeMutator=function(a,b,c,d){"object"==d||"array"==d?a.hasOwnProperty(b)?a[b]:a[b]="array"==d?[]:{}:a[b]=c},g.util.path=function(a,b,e,f){var h=c(b),i=d(e);return g.util.pathRecursive(a,b,e,f,[],[],h,i),e},g.util.pathRecursive=function(a,b,c,d,e,f,h,i){var j,k,l,m;for(j in a)m=!1,k=a[j],f.push(j),h&&(m=b(a,j,k,c,f,this)),!0!==m&&(l=g.util.typeof(k),i&&(m=d(c,j,k,l,f)),"object"!=l&&"array"!=l||!0===m||k===a||-1!=e.indexOf(k)||(e.push(k),g.util.pathRecursive(k,b,i?c[j]:void 0,d,e,f,h,i)),f.pop())},g.util.sprintf=function(){var a,b=-1,c=arguments[0],d=Array.prototype.slice.call(arguments,1);return c.replace(/"/g,"'").replace(/%([0-9]+)|%s/g,function(){return a=d[void 0===arguments[1]||""===arguments[1]?++b:arguments[1]],void 0===a&&(a=arguments[0]),a})},g.util.swap=function(a,b,d){if(a.length>0&&b.length>1)for(var e,f,g,h=0,i=b.length-1,j=c(d);h<i;h+=2)f=b[h],g=b[h+1],e=a[f],a[f]=a[g],a[g]=e,j&&d(f,g);return a},g.util.typeof=function(a){var b=typeof a;return"object"==b&&(a?e(a)?b="array":a instanceof Date?b="date":a instanceof RegExp&&(b="regexp"):b="null"),b},g.util.uuid=function(){for(var a,b=0,c="";b<32;b++)a=16*Math.random()|0,8!==b&&12!==b&&16!==b&&20!==b||(c+="-"),c+=(12===b?4:16===b?3&a|8:a).toString(16);return c},g.collect=function(a){return g.util.invariant(0===arguments.length||arguments.length>0&&c(a),"dop.collect only accept one argument as function"),g.core.createCollector(g.data.collectors[0],g.data.collectors[0].length,a)},g.collectFirst=function(a){return g.util.invariant(0===arguments.length||arguments.length>0&&c(a),"dop.collectFirst only accept one argument as function"),g.core.createCollector(g.data.collectors[0],0,a)},g.createAsync=function(){var a,b,c=new Promise(function(c,d){a=c,b=d});return c.resolve=a,c.reject=b,c},g.createObserver=function(a){g.util.invariant(c(a),"dop.createObserver only accept one argument as function");var b,d,e,f=g.data.observers;for(b in f)if(f[b].callback===a)return f[b];return d=g.data.observers_inc++,e=new g.core.observer(a,d),f[d]=e},g.decode=function(a,b){var c,d=[],e=0,f=JSON.parse(a,function(a,c){return g.core.decode.call(this,a,c,b,d)});for(c=d.length,e=0;e<c;++e)d[e][0][d[e][1]]=void 0;return f},g.del=function(a,b){return g.isRegistered(a)?void 0!==g.core.delete(a,b):delete a[b]},g.encode=function(a,b){return"function"!=typeof b&&(b=g.core.encode),JSON.stringify(a,b)},g.encodeFunction=function(a){return JSON.stringify(a,g.core.encodeFunction)},g.getNodeBySocket=function(a){return g.data.node[a[g.cons.TOKEN]]},g.getObjectDop=function(a){if(d(a))return a[g.cons.DOP]},g.getObjectRoot=function(a){return g.getObjectDop(a).r},g.getObjectParent=function(a){return g.getObjectDop(a)._},g.getObjectProxy=function(a){return g.getObjectDop(a).p},g.getObjectTarget=function(a){return g.getObjectDop(a).t},g.getObjectProperty=function(a){return g.getObjectDop(a).pr},g.getObjectId=function(a){return g.getObjectProperty(g.getObjectRoot(a))},g.getObjectPath=function(a){for(var b,c,d=[],f=a[g.cons.DOP];void 0!==f._;)if(b=f.pr,c=f._,c[b]===f.p)d.unshift(b),f=c[g.cons.DOP];else{if(!e(c))return;if(-1===(b=c.indexOf(f.p)))return;f.pr=b}return d.unshift(f.pr),d},g.isBroadcastFunction=function(a){return c(a)&&a.name===g.cons.BROADCAST_FUNCTION},g.isObjectRegistrable=function(a){var b=g.util.typeof(a);return"object"===b||"array"==b},g.isRegistered=function(a){return void 0!==g.getObjectDop(a)&&!Object.getOwnPropertyDescriptor(a,g.cons.DOP).enumerable},g.isRemoteFunction=function(a){return c(a)&&a.name===g.cons.REMOTE_FUNCTION},g.observe=function(a,b){if(g.util.invariant(g.isRegistered(a),"dop.observe needs a registered object as first parameter"),g.util.invariant(c(b),"dop.observe needs a callback as second parameter"),-1==g.getObjectDop(a).o.indexOf(b))return g.getObjectDop(a).o.push(b),function(){return g.unobserve(a,b)}},g.observeProperty=function(a,b,d){g.util.invariant(g.isRegistered(a),"dop.observeProperty needs a registered object as first parameter"),g.util.invariant(c(d),"dop.observeProperty needs a callback as third parameter"),"object"!=g.util.typeof(g.getObjectDop(a).op)&&(g.getObjectDop(a).op={});var e="array"!=g.util.typeof(g.getObjectDop(a).op[b])?g.getObjectDop(a).op[b]=[]:g.getObjectDop(a).op[b];if(-1==e.indexOf(d))return e.push(d),function(){return g.unobserveProperty(a,b,d)}},g.onSubscribe=function(a){g.util.invariant(c(a),"dop.onSubscribe only accept a function as parameter"),g.data.onsubscribe=a},g.register=function(a){return g.util.invariant("object"==g.util.typeof(a),"dop.register needs a regular plain object as first parameter"),g.isRegistered(a)?g.getObjectProxy(a):g.core.configureObject(a,g.data.object_inc++)},g.set=function(a,b,c){return g.isRegistered(a)?g.core.set(a,b,c):a[b]=c,c},g.setBroadcastFunction=function(a,b){g.util.invariant(g.isRegistered(a),"Object passed to dop.setBroadcastFunction must be a registered object");var c=g.getObjectPath(a),d=c.shift();c.push(b),g.getObjectTarget(a)[b]=function(){return g.protocol.broadcast(d,c,arguments)}},g.unobserve=function(a,b){g.util.invariant(g.isRegistered(a),"dop.unobserve needs a registered object as first parameter"),g.util.invariant(c(b),"dop.unobserve needs a callback as second parameter");var d,e=g.getObjectDop(a).o;return"array"==g.util.typeof(e)&&(-1!=(d=e.indexOf(b))&&(e.splice(d,1),!0))},g.unobserveProperty=function(a,b,d){g.util.invariant(g.isRegistered(a),"dop.unobserveProperty needs a registered object as first parameter"),g.util.invariant(c(d),"dop.unobserveProperty needs a callback as second parameter");var e,f=g.getObjectDop(a).op;return"object"==g.util.typeof(f)&&"array"==g.util.typeof(f[b])&&(f=f[b],-1!=(e=f.indexOf(d))&&(f.splice(e,1),0==f.length&&delete g.getObjectDop(a).op[b],!0))},g.core.emitClose=function(a,b){a.listener&&a.listener.emit("close",b),a.emit("close",b)},g.core.emitConnect=function(a){a.connected=!0,a.listener&&a.listener.emit("connect",a),a.emit("connect"),g.core.sendMessages(a)},g.core.emitDisconnect=function(a){a.connected=!1,a.listener&&(g.core.unregisterNode(a),a.listener.emit("disconnect",a)),a.emit("disconnect")},g.core.emitMessage=function(a,b,f){a.listener&&a.listener.emit("message",a,b,f),a.emit("message",b,f);var h;if("string"==typeof b&&"["==b.substr(0,1))try{h=g.decode(b,a)}catch(a){}else h=b;if(e(h)){"number"==typeof h[0]&&(h=[h]);for(var i,j,k,l,m,n,o,p=0,q=h.length;p<q;p++)if(i=h[p],"number"==typeof(l=i[0])&&0!==l){o=g.util.typeof(i[1]),j="number"==o&&"array"!=o||l<0?[l,i.slice(1)]:j=i;for(var r,s=1,t=j.length;s<t;++s)k=j[s],"array"==g.util.typeof(k)&&("number"==typeof k[0]&&l>0||l<0)&&(n=k[0],r="on"+g.protocol.instructions[n],l>0&&c(g.protocol[r])?g.protocol[r](a,l,k):(l*=-1,d(a.requests[l])&&(m=k,k=a.requests[l],n=k[1],r="_on"+g.protocol.instructions[n],c(g.protocol[r])&&g.protocol[r](a,l,k,m),g.core.deleteRequest(a,l))))}}},g.core.emitOpen=function(a,b,c){var d;return a instanceof g.core.node?d=a:(d=new g.core.node,d.listener=a),d.transport=c,g.core.registerNode(d),a.emit("open",b),d},g.core.emitReconnect=function(a,b,c){a.listener&&(g.core.unregisterNode(c),a.listener.emit("reconnect",a,b)),a.emit("reconnect",b),g.core.sendMessages(a)},g.core.collector=function(a,b){this.active=!0,this.mutations=[],this.queue=a,a.splice(b,0,this)},g.core.collector.prototype.add=function(a){return!(!this.active||void 0!==this.filter&&!0!==this.filter(a))&&(this.mutations.push(a),!0)},g.core.collector.prototype.emit=function(){return this.destroy(),this.emitWithoutDestroy()},g.core.collector.prototype.emitWithoutDestroy=function(){var a=new g.core.snapshot(this.mutations);return a.emit(),this.mutations=[],a},g.core.collector.prototype.pause=function(){this.active=!1},g.core.collector.prototype.resume=function(){this.active=!0},g.core.collector.prototype.destroy=function(){this.active=!1,this.queue.splice(this.queue.indexOf(this),1)},g.core.listener=function(a){g.util.merge(this,new g.util.emitter),a.unshift(g,this),this.options=a[2],this.transport=this.options.transport,this.listener=this.options.transport.apply(this,a)},g.core.node=function(){g.util.merge(this,new g.util.emitter),this.connected=!1,this.request_inc=1,this.requests={},this.message_queue=[],this.subscriber={},this.owner={};do{this.token=g.util.uuid()}while("object"==typeof g.data.node[this.token])},g.core.node.prototype.send=function(a){this.emit(g.cons.SEND,a)},g.core.node.prototype.disconnect=function(){this.emit(g.cons.DISCONNECT)},g.core.node.prototype.subscribe=function(){return g.protocol.subscribe(this,arguments)},g.core.node.prototype.unsubscribe=function(a){return g.protocol.unsubscribe(this,a)},g.core.observer=function(a,b){this.callback=a,this.id=b,this.objects=[],this.properties={}},g.core.observer.prototype.observe=function(a){g.util.invariant(g.isRegistered(a),"observer.observe needs a registered object as first parameter");var b=g.getObjectDop(a);void 0===b.om[this.id]&&(b.om[this.id]=!0,this.objects.push(a))},g.core.observer.prototype.unobserve=function(a){g.util.invariant(g.isRegistered(a),"observer.unobserve needs a registered object as first parameter"),delete g.getObjectDop(a).om[this.id];var b=this.objects.indexOf(a);b>-1&&this.objects.splice(b,1)},g.core.observer.prototype.observeProperty=function(a,b){g.util.invariant(g.isRegistered(a),"observer.observeProperty needs a registered object as first parameter");var c=g.getObjectDop(a);void 0===c.omp[b]&&(c.omp[b]={}),void 0===c.omp[b][this.id]&&(c.omp[b][this.id]=!0,void 0===this.properties[b]&&(this.properties[b]=[]),this.properties[b].push(a))},g.core.observer.prototype.unobserveProperty=function(a,b){g.util.invariant(g.isRegistered(a),"observer.unobserveProperty needs a registered object as first parameter");var c,d=g.getObjectDop(a),e=this.properties[b];void 0!==d.omp[b]&&delete d.omp[b][this.id],void 0!==e&&(c=e.indexOf(a))>-1&&e.splice(c,1)},g.core.observer.prototype.destroy=function(){for(var a,b=0,c=this.objects,d=c.length;b<d;++b)delete g.getObjectDop(c[b]).om[this.id];c=this.properties;for(a in c)for(b=0,d=c[a].length;b<d;++b)delete g.getObjectDop(c[a][b]).omp[a][this.id];delete g.data.observers[this.id]},g.core.snapshot=function(a){this.mutations=a,this.forward=!0},g.core.snapshot.prototype.undo=function(){this.forward&&this.mutations.length>0&&(this.forward=!1,this.setPatch(this.getUnpatch()),this.emit())},g.core.snapshot.prototype.redo=function(){!this.forward&&this.mutations.length>0&&(this.forward=!0,this.setPatch(this.getPatch()),this.emit())},g.core.snapshot.prototype.emit=function(){this.mutations.length>0&&g.core.emitObservers(this.mutations)&&g.core.emitNodes(this.forward?this.getPatch():this.getUnpatch())},g.core.snapshot.prototype.getPatch=function(){return this.patch=void 0===this.patch?g.core.getPatch(this.mutations):this.patch},g.core.snapshot.prototype.getUnpatch=function(){return this.unpatch=void 0===this.unpatch?g.core.getUnpatch(this.mutations):this.unpatch},g.core.snapshot.prototype.setPatch=function(a){for(object_id in a)g.core.setPatch(a[object_id].object,a[object_id].chunks,g.core.setPatchMutator)},g.core.error={reject_local:{OBJECT_NOT_FOUND:"Object not found",NODE_NOT_FOUND:"Node not found",TIMEOUT_REQUEST:"Timeout waiting for response"},reject_remote:{OBJECT_NOT_FOUND:1,1:"Remote object not found or not permissions to use it",SUBSCRIPTION_NOT_FOUND:2,2:"Subscription not found to unsubscribe this object",FUNCTION_NOT_FOUND:3,3:"Remote function not found to be called",CUSTOM_REJECTION:4}},g.core.delete=function(a,b){var c=Object.getOwnPropertyDescriptor(a,b);if(c&&c.configurable){var d,e=g.getObjectTarget(a),f=g.getObjectProxy(a);return e!==f&&a!==f||!(d=g.getObjectPath(a))||g.core.storeMutation({object:g.getObjectProxy(e),prop:b,path:d,oldValue:g.util.clone(e[b])}),delete e[b]}},g.core.pop=function(a){if(0!==a.length){return g.core.splice(a,[a.length-1,1])[0]}},g.core.push=function(a,b){return 0===b.length?a.length:(b.unshift(a.length,0),g.core.splice(a,b),a.length)},g.core.reverse=function(a){var b,c=g.getObjectTarget(a),d=g.getObjectProxy(a);if(c!==d&&a!==d||!(b=g.getObjectPath(a)))Array.prototype.reverse.call(c);else{for(var e,f,h=c.length/2,i=0,j=[];i<h;++i)e=c.length-i-1,i!==e&&(f=c[e],c[e]=c[i],c[i]=f,j.push(i,e));j.length>0&&g.core.storeMutation({object:d,prop:g.getObjectProperty(a),path:b,swaps:j})}return a},g.core.set=function(a,b,d){if(a[b]!==d){var f=Object.getOwnPropertyDescriptor(a,b);if(!f||f&&f.writable){var h,i=g.getObjectTarget(a),j=g.getObjectProxy(a),k=i[b],l=i.length,m=!i.hasOwnProperty(b);if(i[b]=g.isObjectRegistrable(d)?g.core.configureObject(d,b,i):d,(i===j||a===j)&&(!c(k)||!c(d))&&(h=g.getObjectPath(a))){var n={object:j,prop:b,path:h,value:g.util.clone(d)};m||(n.oldValue=g.util.clone(k)),i.length!==l&&e(i)&&g.core.storeMutation({object:j,prop:"length",path:h,value:i.length,oldValue:l}),g.core.storeMutation(n)}}}},g.core.shift=function(a){if(0!==a.length){return g.core.splice(a,[0,1])[0]}},g.core.sort=function(a,b){var c,d,e,f=g.getObjectTarget(a),h=g.getObjectProxy(a),i=f.slice(0);return c=Array.prototype.sort.call(f,b),f!==h&&a!==h||!(e=g.getObjectPath(a))||(d=g.core.sortDiff(f,i),d.length>1&&g.core.storeMutation({object:g.getObjectProxy(a),prop:g.getObjectProperty(a),path:e,swaps:d})),c},g.core.sortDiff=function(a,b){for(var c,d,e=b.length,f=[],g=0;g<e;++g)a[g]!==b[g]&&(c=b.indexOf(a[g]),d=b[g],b[g]=b[c],b[c]=d,f.push(g,c));return f},g.core.splice=function(a,b){var c,d,e=a.length,f=g.getObjectTarget(a),h=g.getObjectProxy(a);if(c=Array.prototype.splice.apply(f,b),d=g.getObjectPath(a)){var i,j,k=b.length,l=f.length,m=Number(b[0]),n=Number(b[1])>0?b[1]:0,o=b.length>2?b.length-2:0;for(isNaN(m)?m=0:m<0?m=l+m<0?0:l+m:m>e&&(m=e),i=1===k?0:k>2&&n===o?m+n:f.length;m<i;++m)j=f[m],g.isObjectRegistrable(j)&&(f[m]=g.core.configureObject(j,m,f));if((f===h||a===h)&&(e!==l||o>0)){b[0]<0&&(b[0]=a.length+b[0]);var p={object:h,prop:g.getObjectProperty(a),path:d,splice:b};c.length>0&&(p.spliced=g.util.clone(c)),g.core.storeMutation(p)}}return c},g.core.swap=function(a,b){var c=g.getObjectTarget(a),d=g.getObjectProxy(a),e=g.util.swap(c,b);return c!==d&&a!==d||g.core.storeMutation({object:d,prop:g.getObjectProperty(a),path:g.getObjectPath(a),swaps:b.slice(0)}),e},g.core.unshift=function(a,b){return 0===b.length?a.length:(b.unshift(0,0),g.core.splice(a,b),a.length)};var h="function"==typeof Proxy;g.core.configureObject=function(a,b,d){if(g.isRegistered(a))return g.core.configureObject(g.util.clone(a),b,d);var f={};f.r=void 0===d?a:g.getObjectRoot(d),f._=d,f.pr=b,f.o=[],f.op={},f.om={},f.omp={},f.m=[],Object.defineProperty(a,g.cons.DOP,{value:f,enumerable:!1});var i,j,f,k,l=e(a);for(i in a)l&&(i=Number(i)),j=a[i],c(j)&&j.name==g.core.createRemoteFunction.name?(k=g.getObjectPath(a),a[i]=j(k[0],k.slice(1).concat(i))):g.isObjectRegistrable(j)&&(a[i]=g.core.configureObject(j,i,a));if(h){var m=a;a=new Proxy(a,g.core.proxyObjectHandler),f.p=a,f.t=m}else f.p=f.t=a;return"array"==g.util.typeof(a)&&Object.defineProperties(a,g.core.proxyArrayHandler),a},g.core.createCollector=function(a,b,c){var d=new g.core.collector(a,b);return d.filter=c,d},g.core.emitObservers=function(a){for(var b,c,f,h,i,j,k,l,m,n=0,o=a.length,p=[],q={},r=!1;n<o;++n){b=a[n],c=b.object,i=g.getObjectDop(c),j=g.getObjectId(c),!r&&d(g.data.object[j])&&(r=!0);for(m in i.om)void 0===q[m]&&(q[m]=[]),q[m].push(b);if(void 0!==i.omp[b.name])for(m in i.omp[b.name])void 0===i.om[m]&&(void 0===q[m]&&(q[m]=[]),q[m].push(b));if(k=i.op[b.name],e(k)&&k.length>0)for(f=0,h=k.length;f<h;++f)k[f](b);l=i.o,e(l)&&l.length>0&&(i.m.push(b),-1===p.indexOf(i)&&p.push(i))}for(n=0,o=p.length;n<o;++n){for(i=p[n],l=i.o,f=0,h=l.length;f<h;++f)l[f](i.m.slice(0));i.m=[]}for(m in q)g.data.observers[m].callback(q[m]);return r},g.core.getMutationInverted=function(a){var b={object:a.object,path:a.path,prop:a.prop};if(void 0!==a.splice){var c=a.splice,d=void 0===a.spliced?[]:a.spliced;b.splice=[c[0],c.length-2],Array.prototype.push.apply(b.splice,d),b.spliced=c.slice(2),0===b.spliced.length&&delete b.spliced}else void 0!==a.swaps?b.swaps=a.swaps.slice(0).reverse():a.hasOwnProperty("oldValue")?a.hasOwnProperty("value")?(b.oldValue=a.value,b.value=a.oldValue):b.value=a.oldValue:b.oldValue=a.value;return b},g.core.getPatch=function(a,b){for(var c,d,e={},f=0,h=a.length;f<h;++f)c=b?g.core.getMutationInverted(a[f]):a[f],d=g.getObjectId(c.object),void 0===e[d]&&(e[d]={chunks:[{}],object:g.getObjectRoot(c.object)}),g.core.injectMutationInPatch(e[d],c);return e},g.core.getUnpatch=function(a){return g.core.getPatch(a.slice(0).reverse(),!0)},g.core.injectMutationInPatch=function(a,b){for(var c,d,h,i,j,k=b.prop,l=b.path,m=b.value,n=void 0!==b.splice,o=void 0!==b.swaps,p=n||o,q=g.util.typeof(m),r=1,s=chunkParent=a.chunks[a.chunks.length-1],t=chunkNextParent=chunkNextRoot={},u=g.protocol.instructionsPatchs,v=!1,w=!1;r<l.length;++r)h=l[r],chunkParent=s,chunkNextParent=t,t=t[h]={},c=g.util.typeof(s[h]),"array"==c?(d=s[h],d[0]===u.object?(v=!0,s=d[1]):(!p||p&&r+1<l.length)&&(w=!0,s=t,a.chunks.push(chunkNextRoot))):!w&&p&&"object"==c?(chunkParent=chunkNextParent,s=t,a.chunks.push(chunkNextRoot)):s="object"==c?s[h]:s[h]={};"object"==q||"array"==q?(i=g.util.merge("array"==q?[]:{},m),s[k]=v?i:[u.object,i]):p?v?n?Array.prototype.splice.apply(s,b.splice.slice(0)):g.util.swap(s,b.swaps.slice(0)):(j=n?[u.splice,b.splice.slice(0)]:[u.swaps,b.swaps.slice(0)],e(chunkParent[k])?(f(chunkParent[k][0])&&(chunkParent[k]=[chunkParent[k]]),chunkParent[k].push(j)):chunkParent[k]=j):s[k]=m},g.core.proxyArrayHandler={splice:{value:function(){return g.core.splice(this,Array.prototype.slice.call(arguments,0))}},shift:{value:function(){return g.core.shift(this,Array.prototype.slice.call(arguments,0))}},pop:{value:function(){return g.core.pop(this,Array.prototype.slice.call(arguments,0))}},push:{value:function(){return g.core.push(this,Array.prototype.slice.call(arguments,0))}},unshift:{value:function(){return g.core.unshift(this,Array.prototype.slice.call(arguments,0))}},reverse:{value:function(){return g.core.reverse(this)}},sort:{value:function(a){return g.core.sort(this,a)}}},g.core.proxyObjectHandler={set:function(a,b,c){return g.core.set(g.getObjectProxy(a),b,c),!0},deleteProperty:function(a,b){return void 0!==g.core.delete(g.getObjectProxy(a),b)}},g.core.setPatch=function(a,b,c){e(b)||(b=[b]);for(var d=0,f=b.length;d<f;++d)g.util.path(b[d],null,a,c);return a},g.core.setPatchFunctionMutator=function(a,b,d,e,f){if(!c(d)||d.name!=g.core.createRemoteFunction.name)return g.core.setPatchMutator(a,b,d,e,f);g.set(a,b,d(g.getObjectId(a),f.slice(0)))},g.core.setPatchMutator=function(a,b,c,d,f){var h,i,j=(g.util.typeof(a),g.util.typeof(a[b]),g.protocol.instructionsPatchs);if("array"==d){if((h=c[0])===j.object)g.set(a,b,g.util.clone(c[1]));else{e(h)||(c=[c]);for(var k=0,l=c.length;k<l;++k)i=c[k],i[0]===j.splice?g.core.splice(a[b],i[1]):i[0]===j.swaps&&g.core.swap(a[b],i[1])}return!0}"undefined"==d?g.del(a,b):"object"!=d&&g.set(a,b,c)},g.core.storeMutation=function(a){for(var b,c=g.data.collectors,d=0,e=c.length,f=0;d<e;d++)if(c[d].length>0)for(f=0,b=c[d].length;f<b;f++)if(c[d][f].add(a))return;new g.core.snapshot([a]).emit()},g.core.connector=function(a){var b=new g.core.node;return a.unshift(g,b),b.options=a[2],b.transport=b.options.transport,b.options.transport.apply(this,a),b},g.core.createRemoteFunction=function(a){return function(b,c){return function(){return g.protocol.call(a,b,c,arguments)}}},g.core.createRequest=function(a){var b=a.request_inc++,c=Array.prototype.slice.call(arguments,1);return a.requests[b]=c,c.unshift(b),c.promise=g.createAsync(),c},g.core.createResponse=function(){return arguments[0]=-1*arguments[0],Array.prototype.slice.call(arguments,0)};var i=/^\d\d\d\d-\d\d-\d\dT\d\d:\d\d:\d\d.\d\d\dZ$/,j=/\/(.+)\/([gimuy]{0,5})/;g.core.decode=function(a,b,c,e){if("string"==typeof b){if(b==g.protocol.instructionsPatchs.function)return g.core.createRemoteFunction(c);if(b==g.protocol.instructionsPatchs.undefined&&d(e))return void e.push([this,a]);if(b==g.protocol.instructionsPatchs.infinity)return 1/0;if(b==g.protocol.instructionsPatchs._infinity)return-1/0;if(b==g.protocol.instructionsPatchs.nan)return NaN;if(i.exec(b))return new Date(b);if(b.substr(0,2)==g.protocol.instructionsPatchs.regex){var f=j.exec(b.substr(2));return new RegExp(f[1],f[2])}if("~"==b[0])return b.substring(1)}return b},g.core.deleteRequest=function(a,b){clearTimeout(a.requests[b].timeout),delete a.requests[b]},g.core.emitNodes=function(a){var b,c,e,f,h;for(b in a)if(d(g.data.object[b])){f=g.data.object[b];for(c in f.node)1===f.node[c].subscriber&&(e=g.data.node[c],h=a[b].chunks,g.protocol.patch(e,Number(b),h.length>1?h:h[0]))}},g.core.encode=function(a,b){var c=typeof b;return"undefined"==c?g.protocol.instructionsPatchs.undefined:"string"==c&&"~"==b[0]?"~"+b:"number"==c&&isNaN(b)?g.protocol.instructionsPatchs.nan:"object"==c&&b instanceof RegExp?g.protocol.instructionsPatchs.regex+b.toString():b===1/0?g.protocol.instructionsPatchs.infinity:b===-1/0?g.protocol.instructionsPatchs._infinity:b},g.core.encodeFunction=function(a,b){return c(b)&&!g.isBroadcastFunction(b)?g.protocol.instructionsPatchs.function:g.core.encode(a,b)},g.core.getRejectError=function(a){if("number"==typeof a&&void 0!==g.core.error.reject_remote[a]){var b=Array.prototype.slice.call(arguments,1);return b.unshift(g.core.error.reject_remote[a]),g.util.sprintf.apply(this,b)}return a},g.core.localProcedureCall=function(a,b,d,e,f,h){var i,j=g.createAsync();c(f)&&(j=f(j)),b.push(j),j.then(d).catch(e),(i=a.apply(h||j,b))!==j&&j.resolve(i)},g.core.registerNode=function(a){g.data.node[a.token]=a},g.core.registerObjectToNode=function(a,b){var c,d=g.getObjectId(b);return void 0===g.data.object[d]&&(g.data.object[d]={object:b,nodes_total:0,node:{}}),c=g.data.object[d],void 0===c.node[a.token]&&(c.nodes_total+=1,c.node[a.token]={subscriber:0,owner:0,version:0,pending:[],applied_version:0,applied:{}}),c},g.core.registerOwner=function(a,b,c){var d=g.core.registerObjectToNode(a,b),e=g.getObjectId(d.object);d.node[a.token].owner=c,a.owner[c]=e},g.core.registerSubscriber=function(a,b){var c=g.core.registerObjectToNode(a,b),d=g.getObjectId(c.object);return a.subscriber[d]=!0,!c.node[a.token].subscriber&&(c.node[a.token].subscriber=1,!0)},g.core.sendMessages=function(a){var b=a.message_queue.length;if(b>0&&a.connected){for(var c,d,e,f=0,h=[];f<b;++f)if(d=a.message_queue[f][0],h.push(a.message_queue[f][1](d)),(e=d[0])>0){var i=g.protocol.instructions[d[1]];d.timeout=setTimeout(function(){g.protocol["on"+i+"timeout"](a,e,d),delete a.requests[e]},g.protocol.timeouts[i])}c=f>1?"["+h.join(",")+"]":h[0],a.message_queue=[],a.send(c)}},g.core.setSocketToNode=function(a,b){a.socket=b,b[g.cons.TOKEN]=a.token},g.core.storeMessage=function(a,b,c){"function"!=typeof c&&(c=g.encode),a.message_queue.push([b,c])},g.core.storeSendMessages=function(a,b,c){g.core.storeMessage(a,b,c),g.core.sendMessages(a)},g.core.unregisterNode=function(a){var b,c,d;for(b in a.subscriber)void 0!==(d=g.data.object[b])&&void 0!==d.node[a.token]&&(d.nodes_total-=1,delete d.node[a.token]);for(c in a.owner)b=a.owner[c],void 0!==(d=g.data.object[b])&&void 0!==d.node[a.token]&&(d.nodes_total-=1,delete d.node[a.token]);void 0!==d&&0===d.nodes_total&&delete g.data.object[b],delete g.data.node[a.token]},g.protocol._onbroadcast=function(a,b,c,d){g.protocol._oncall(a,b,c,d)},g.protocol._oncall=function(a,b,c,d){var e=d[0],f=c.promise;void 0!==e&&(0===e?f.resolve(d[1]):e===g.core.error.reject_remote.CUSTOM_REJECTION?f.reject(d[1]):f.reject(g.core.getRejectError(e)))},g.protocol._onpatch=function(a,b,c,d){var e,f=d[0],h=c[2],i=g.data.object[h].node[a.token],j=c[3],k=i.pending,l=c.promise,m=0,n=k.length;if(void 0!==f)if(0===f){for(;m<n;m++){if((e=k[m][0])>=j){e===j&&k.splice(m,1);break}g.protocol.patchSend(a,h,e,k[m][1])}l.resolve(d[1])}else l.reject(g.core.getRejectError(f))},g.protocol._onsubscribe=function(a,b,c,f){if(void 0!==f[0])if(0!==f[0])c.promise.reject(g.core.getRejectError(f[0]));else{var h,i,j="number"==typeof f[1]?[f[1]]:f[1],k=j[0],l=f[2];e(j)&&"number"==typeof k?(void 0===a.owner[k]?(i=g.collect(),h=g.isRegistered(c.into)?g.core.setPatch(c.into,l,g.core.setPatchFunctionMutator):g.register(void 0===c.into?l:g.core.setPatch(c.into,l,g.core.setPatchMutator)),g.core.registerOwner(a,h,k),i.emit()):h=g.data.object[a.owner[k]].object,h=g.util.get(h,j.slice(1)),d(h)?c.promise.resolve(g.getObjectProxy(h)):c.promise.reject(g.core.error.reject_local.OBJECT_NOT_FOUND)):c.promise.reject(g.core.error.reject_local.OBJECT_NOT_FOUND)}},g.protocol._onunsubscribe=function(a,b,c,e){if(void 0!==e[0])if(0!==e[0])c.promise.reject(e[0]);else{var f=c[2],h=a.owner[f],i=g.data.object[h];if(d(i)&&d(i.node[a.token])&&i.node[a.token].owner===f){var j=i.node[a.token];j.owner=0,0===j.subscriber&&(i.nodes_total-=1),0===i.nodes_total&&delete g.data.object[h],c.promise.resolve()}}},g.protocol.broadcast=function(a,b,c){var e=g.data.object[a],f=[];if(d(e)&&d(e.node)){var h,i,j,k=e.node;c=Array.prototype.slice.call(c,0);for(h in k)1===k[h].subscriber&&(i=g.data.node[h],j=g.core.createRequest(i,g.protocol.instructions.broadcast,a,b,c),j.promise.node=i,g.core.storeSendMessages(i,j),f.push(j.promise))}return f},g.protocol.call=function(a,b,c,e){var f=g.data.object[b];if(d(f)&&d(f.node[a.token])&&f.node[a.token].owner>0){e=Array.prototype.slice.call(e,0);var h=g.core.createRequest(a,g.protocol.instructions.call,f.node[a.token].owner,c,e);return g.core.storeSendMessages(a,h),h.promise}return Promise.reject(g.core.error.reject_local.NODE_NOT_FOUND)},g.protocol.instructions={subscribe:1,unsubscribe:2,call:3,broadcast:4,patch:5};for(var k in g.protocol.instructions)g.protocol.instructions[g.protocol.instructions[k]]=k;if(g.protocol.instructionsPatchs={undefined:"~U",function:"~F",object:2,splice:3,swaps:4,nan:"~N",regex:"~R",infinity:"~I",_infinity:"~i"},g.protocol.onbroadcast=function(a,b,c){g.protocol.onfunction(a,b,c,a.owner[c[1]],function(a){return a.owner===c[1]})},g.protocol.oncall=function(a,b,c){g.protocol.onfunction(a,b,c,c[1],function(a){return 1===a.subscriber})},g.protocol.onfunction=function(a,b,e,f,h){function i(c){var d=g.core.createResponse(b,0);return void 0!==c&&d.push(c),g.core.storeSendMessages(a,d),c}function j(c){g.core.storeSendMessages(a,g.core.createResponse(b,g.core.error.reject_remote.CUSTOM_REJECTION,c))}var k=e[2],l=e[3],m=g.data.object[f];if(d(m)&&d(m.node[a.token])&&h(m.node[a.token])){var n=k.pop(),o=g.util.get(m.object,k),p=o[n];if(c(p)&&!g.isBroadcastFunction(p))return void(g.isRemoteFunction(p)?p.apply(null,l).then(i).catch(j):g.core.localProcedureCall(p,l,i,j,function(b){return b.node=a,b},g.getObjectProxy(o)))}g.core.storeSendMessages(a,g.core.createResponse(b,g.core.error.reject_remote.FUNCTION_NOT_FOUND))},g.protocol.onpatch=function(a,b,c){var e,f,h=c[1],i=a.owner[h],j=c[2],k=c[3],l=g.core.createResponse(b),m=g.data.object[i];if(d(m)&&d(m.node[a.token])&&m.node[a.token].owner===h){if(e=m.node[a.token],e.applied_version<j&&void 0===e.applied[j]){for(e.applied[j]=k,f=g.collect();e.applied[e.applied_version+1];)e.applied_version+=1,g.core.setPatch(m.object,e.applied[e.applied_version],g.core.setPatchFunctionMutator),delete e.applied[e.applied_version];f.emit()}l.push(0)}else l.push(g.core.error.reject_remote.OBJECT_NOT_FOUND);g.core.storeSendMessages(a,l)},g.protocol.onpatchtimeout=function(a,b,c){g.protocol.patchSend(a,c[2],c[3],c[4])},g.protocol.onsubscribe=function(a,b,d){function e(c){var d=g.core.createResponse(b);c instanceof Error?console.log(c.stack):d.push(c),g.core.storeSendMessages(a,d,JSON.stringify)}if(c(g.data.onsubscribe)){var f=Array.prototype.slice.call(d,1);g.core.localProcedureCall(g.data.onsubscribe,f,function(c){if(g.isObjectRegistrable(c)){var d=g.register(c),e=g.getObjectRoot(d),f=g.getObjectPath(d),h=f[0],i=g.core.createResponse(b,0);return g.core.registerSubscriber(a,e)?i.push(h,e):i.push(f),g.core.storeSendMessages(a,i,g.encodeFunction),d}if(void 0===c)return Promise.reject(g.core.error.reject_remote.OBJECT_NOT_FOUND)
;g.util.invariant(!1,"dop.onsubscribe callback must return or resolve a regular object")},e,function(b){return b.node=a,b})}else e(g.core.error.reject_remote.OBJECT_NOT_FOUND)},g.protocol.onsubscribetimeout=g.protocol.onunsubscribetimeout=g.protocol.oncalltimeout=g.protocol.onbroadcasttimeout=function(a,b,c){c.promise.reject(g.core.error.reject_local.TIMEOUT_REQUEST)},g.protocol.onunsubscribe=function(a,b,c){var e=c[1],f=g.data.object[e],h=g.core.createResponse(b);if(d(f)&&d(f.node[a.token])&&f.node[a.token].subscriber){var i=f.node[a.token];i.subscriber=0,0===i.owner&&(f.nodes_total-=1),0===f.nodes_total&&delete g.data.object[e],h.push(0)}else h.push(g.core.error.reject_remote.SUBSCRIPTION_NOT_FOUND);g.core.storeSendMessages(a,h)},g.protocol.patch=function(a,b,c){var d=g.data.object[b].node[a.token],e=++d.version;return d.pending.push([e,g.util.merge({},c)]),g.protocol.patchSend(a,b,e,c)},g.protocol.patchSend=function(a,b,c,d){var e=g.core.createRequest(a,g.protocol.instructions.patch,b,c,d);return g.core.storeSendMessages(a,e,g.encodeFunction),e.promise},g.protocol.subscribe=function(a,b){b=Array.prototype.slice.call(b,0),b.unshift(a,g.protocol.instructions.subscribe);var c=g.core.createRequest.apply(a,b);return c.promise.into=function(a){return g.isObjectRegistrable(a)&&(c.into=g.isRegistered(a)?g.getObjectProxy(a):a),c.promise},g.core.storeSendMessages(a,c),c.promise},g.protocol.timeouts={subscribe:5e3,unsubscribe:5e3,call:1e4,broadcast:1e4,patch:1e3},g.protocol.unsubscribe=function(a,b){var c=g.getObjectId(b),e=g.data.object[c];if(d(e)&&d(e.node[a.token])&&e.node[a.token].owner>0){var f=g.core.createRequest(a,g.protocol.instructions.unsubscribe,e.node[a.token].owner);return g.core.storeSendMessages(a,f),f.promise}return Promise.reject(g.core.error.reject_remote[2])},void 0===b)return g;"function"==typeof define&&define.amd?define([],function(){return g}):"object"==typeof module&&module.exports?module.exports=g:"object"==typeof window&&window?window.dop=g:b.dop=g}(this);