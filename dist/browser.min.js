/* dop@0.3.2 - Â© 2016 Josema Gonzalez - MIT Licensed */
!function a(b){function c(a){return"function"==typeof a}function d(a){return null!==a&&"object"==typeof a}var e={name:"dop",create:a,data:{node_inc:0,node:{},object_inc:1,object:{},object_data:{},collectors:[[],[]],lastGet:{}},util:{},core:{},protocol:{},transports:{listen:{},connect:{}},cons:{TOKEN:"~TOKEN_DOP",DOP:"~DOP",CONNECT:"~CONNECT",SEND:"~SEND",DISCONNECT:"~DISCONNECT"}};e.connect=function(a){var b=Array.prototype.slice.call(arguments,0);return"object"!=e.util.typeof(b[0])&&(a=b[0]={}),"function"!=typeof a.transport&&(a.transport=e.transports.connect.websocket),e.core.connector(b)},e.util.emitter=function(){this._events={}},e.util.emitter.prototype.on=function(a,b,e){return c(b)&&(d(this._events)||(this._events={}),d(this._events[a])||(this._events[a]=[]),this._events[a].push(e===!0?[b,!0]:[b])),this},e.util.emitter.prototype.once=function(a,b){return this.on(a,b,!0)},e.util.emitter.prototype.emit=function(a){if(d(this._events[a])&&this._events[a].length>0){for(var b=0,c=[],e=Array.prototype.slice.call(arguments,1);b<this._events[a].length;b++)c.push(this._events[a][b][0]),this._events[a][b][1]===!0&&(this._events[a].splice(b,1),b-=1);for(b=0;b<c.length;b++)c[b].apply(this,e)}return this},e.util.emitter.prototype.removeListener=function(a,b){if(d(this._events[a])&&this._events[a].length>0)for(var c=0;c<this._events[a].length;c++)this._events[a][c][0]===b&&(this._events[a].splice(c,1),c-=1);return this},function(a){function b(a,b,e){function j(a){w.readyState===w.constructor.OPEN&&u===i?w.send(a):x.push(a)}function k(){if(w.readyState===w.constructor.OPEN)for(;x.length>0;)w.send(x.shift())}function l(){u===h?w.send(b.tokenServer):(w.send(""),u=g),a.core.emitOpen(b,w,e.transport)}function m(c){u===h&&c.data===b.tokenServer?(u=i,a.core.setSocketToNode(b,w),a.core.emitReconnect(b,oldSocket),k()):a.core.emitMessage(b,c.data,c)}function n(){u=f,a.core.emitClose(b,w)}function o(c){u===h&&(a.core.emitDisconnect(b),a.core.setSocketToNode(b,w)),j(c),u=i,a.core.emitConnect(b),k()}function p(){u=f,w.close()}function q(){u===f&&(oldSocket=w,w=new v(r),u=h,c(w,l,m,n),d(oldSocket,l,m,n))}var r="ws://localhost:4444/"+a.name;if("string"==typeof e.url)r=e.url.replace("http","ws");else if("undefined"!=typeof window&&/http/.test(window.location.href)){var s=/(ss|ps)?:\/\/([^\/]+)\/?(.+)?/.exec(window.location.href),t=s[1]?"wss":"ws";r=t+"://"+s[2].toLocaleLowerCase()+"/"+a.name}var u,v=e.transport.getApi(),w=new v(r),x=[];return a.core.setSocketToNode(b,w),u=f,b.reconnect=q,b.on(a.cons.CONNECT,o),b.on(a.cons.SEND,j),b.on(a.cons.DISCONNECT,p),c(w,l,m,n),w}function c(a,b,c,d){a.addEventListener("open",b),a.addEventListener("message",c),a.addEventListener("close",d)}function d(a,b,c,d){a.removeEventListener("open",b),a.removeEventListener("message",c),a.removeEventListener("close",d)}"undefined"==typeof e&&"object"==typeof module&&module.exports?module.exports=b:(b.getApi=function(){return window.WebSocket},"undefined"!=typeof e?e.transports.connect.websocket=b:a.dopTransportsConnectWebsocket=b);var f=0,g=1,h=2,i=3}(this),e.util.get=function(a,b){if(0===b.length)return a;for(var c=0,e=b.length;c<e;c++){if(!(c+1<e&&d(a[b[c]])))return a.hasOwnProperty(b[c])?a[b[c]]:void 0;a=a[b[c]]}return a[b[c]]},e.util.invariant=function(a){if(!a){var b=e.util.sprintf.apply(this,Array.prototype.slice.call(arguments,1));throw new Error("[dop] Invariant failed: "+b)}},e.util.merge=function(a,b){var c=arguments;return c.length>2?(Array.prototype.splice.call(c,0,2,e.util.merge.call(this,a,b)),e.util.merge.apply(this,c)):e.util.path(b,this,a,e.util.mergeMutator)},e.util.mergeMutator=function(a,b,c,d){"object"==d||"array"==d?a.hasOwnProperty(b)?a[b]:a[b]="array"==d?[]:{}:a[b]=c},e.util.path=function(a,b,f,g){var h=c(b),i=d(f);return e.util.pathRecursive(a,b,f,g,[],[],h,i),f},e.util.pathRecursive=function(a,b,c,d,f,g,h,i){var j,k,l,m;for(j in a)m=!1,k=a[j],g.push(j),h&&(m=b(a,j,k,c,g,this)),m!==!0&&(l=e.util.typeof(k),i&&(m=d(c,j,k,l,g)),"object"!=l&&"array"!=l||m===!0||k===a||f.indexOf(k)!=-1||(f.push(k),e.util.pathRecursive(k,b,i?c[j]:void 0,d,f,g,h,i)),g.pop())},e.util.sprintf=function(){var a,b=-1,c=arguments[0],d=Array.prototype.slice.call(arguments,1);return c.replace(/"/g,"'").replace(/%([0-9]+)|%s/g,function(){return a=d[void 0===arguments[1]||""===arguments[1]?++b:arguments[1]],void 0===a&&(a=arguments[0]),a})},e.util.typeof=function(a){var b=typeof a;return"object"==b&&(a?Array.isArray(a)?b="array":a instanceof Date?b="date":a instanceof RegExp&&(b="regexp"):b="null"),b},e.util.uuid=function(){for(var a,b=0,c="";b<32;b++)a=16*Math.random()|0,8!==b&&12!==b&&16!==b&&20!==b||(c+="-"),c+=(12===b?4:16===b?3&a|8:a).toString(16);return c},e.collect=function(a){return e.util.invariant(0===arguments.length||arguments.length>0&&c(a),"dop.collect only accept one argument as function"),e.core.createCollector(e.data.collectors[0],e.data.collectors[0].length,a)},e.collectFirst=function(a){return e.util.invariant(0===arguments.length||arguments.length>0&&c(a),"dop.collectFirst only accept one argument as function"),e.core.createCollector(e.data.collectors[0],0,a)},e.decode=function(a){var b,c=[],d=0,f=JSON.parse(a,function(a,b){return e.core.decode.call(this,a,b,c)});for(b=c.length;d<b;++d)c[d][0][c[d][1]]=void 0;return f},e.del=function(a,b){return e.isRegistered(a)?void 0!==e.core.delete(a,b):delete a[b]},e.emit=function(a,b){a.length>0&&e.core.emitObservers(a)&&(void 0===b&&(b=e.getAction(a)),e.core.emitNodes(b))},e.encode=function(a){return JSON.stringify(a,e.core.encode)},e.getAction=function(a){for(var b={},c=0,d=a.length;c<d;++c)e.core.objectIsStillStoredOnPath(a[c].object)&&e.core.injectMutationInAction(b,a[c]);return b},e.getNodeBySocket=function(a){return e.data.node[a[e.cons.TOKEN]]},e.getObjectDop=function(a){return a[e.cons.DOP]},e.getObjectId=function(a){return e.getObjectDop(a)[0]},e.getObjectProperty=function(a){var b=e.getObjectDop(a);return b[b.length-1]},e.getObjectProxy=function(a){return e.getObjectDop(a).p},e.getObjectRoot=function(a){return e.data.object[e.getObjectId(a)]},e.getObjectRootById=function(a){return e.data.object[a]},e.getObjectTarget=function(a){return e.getObjectDop(a).t},e.isRegistered=function(a){return d(a)&&void 0!==e.getObjectDop(a)},e.getUnaction=function(a){for(var b={},c=a.length-1;c>-1;--c)e.core.injectMutationInAction(b,a[c],!0);return b},e.isObjectRegistrable=function(a){var b=e.util.typeof(a);return"object"===b||"array"==b},e.observe=function(a,b){if(e.util.invariant(e.isRegistered(a),"dop.observe needs a registered object as first parameter"),e.util.invariant(c(b),"dop.observe needs a callback as second parameter"),e.getObjectDop(a).o.indexOf(b)==-1)return e.getObjectDop(a).o.push(b),function(){return e.unobserve(a,b)}},e.observeProperty=function(a,b,d){e.util.invariant(e.isRegistered(a),"dop.observeProperty needs a registered object as first parameter"),e.util.invariant(c(d),"dop.observeProperty needs a callback as third parameter"),"object"!=e.util.typeof(e.getObjectDop(a).op)&&(e.getObjectDop(a).op={});var f="array"!=e.util.typeof(e.getObjectDop(a).op[b])?e.getObjectDop(a).op[b]=[]:e.getObjectDop(a).op[b];if(f.indexOf(d)==-1)return f.push(d),function(){return e.unobserveProperty(a,b,d)}},e.onsubscribe=function(a){e.util.invariant(c(a),"dop.onsubscribe only accept a function as parameter"),e.data.onsubscribe=a},e.register=function(a,b){if(e.util.invariant(e.isObjectRegistrable(a),"dop.register needs a regular object as first parameter"),e.isRegistered(a))return e.getObjectProxy(a);var c=e.data.object_inc++;return a=e.core.configureObject(a,[c]),e.data.object[c]=a,e.data.object_data[c]={node:{},nodes:0,options:b},a},e.set=function(a,b,c){return e.isRegistered(a)?e.core.set(a,b,c):a[b]=c,c},e.setAction=function(a){var b=e.collectFirst();return e.util.path(a,null,e.data.object,e.core.setAction),b},e.core.setAction=function(a,b,c,d,f){var g=e.util.typeof(a[b]);if("object"==d&&c.hasOwnProperty(e.cons.DOP)){var h,i=c[e.cons.DOP],j=0,k=i.length;for("array"!=g&&e.set(a,b,[]);j<k;++j)h=i[j],h[0]<0||h[1]<0?(h=h.slice(0),h[0]<0?h[0]=h[0]*-1:h[1]=h[1]*-1,e.core.swap(a[b],h)):(a[b].length<h[0]&&(e.getObjectTarget(a[b]).length=h[0]),3===h.length&&1===h[1]?void 0===h[2]?e.del(a[b],h[0]):e.set(a[b],h[0],h[2]):e.core.splice(a[b],h));return"number"==typeof c.length&&c.length>-1&&(a[b].length=c.length),!0}if("object"!=d||a.hasOwnProperty(b))if("undefined"==d)e.del(a,b);else{if("array"==d)return e.set(a,b,e.util.merge([],c)),!0;if("object"==d&&"object"!=g&&"array"!=g)return e.set(a,b,e.util.merge({},c)),!0;"object"!=d&&e.set(a,b,c)}else e.set(a,b,{})},e.unobserve=function(a,b){e.util.invariant(e.isRegistered(a),"dop.unobserve needs a registered object as first parameter"),e.util.invariant(c(b),"dop.unobserve needs a callback as second parameter");var d,f=e.getObjectDop(a).o;return"array"==e.util.typeof(f)&&(d=f.indexOf(b),d!=-1&&(f.splice(d,1),0==f.length&&delete e.getObjectDop(a).o,!0))},e.unobserveProperty=function(a,b,d){e.util.invariant(e.isRegistered(a),"dop.unobserveProperty needs a registered object as first parameter"),e.util.invariant(c(d),"dop.unobserveProperty needs a callback as second parameter");var f,g=e.getObjectDop(a).op;return"object"==e.util.typeof(g)&&"array"==e.util.typeof(g[b])&&(g=g[b],f=g.indexOf(d),f!=-1&&(g.splice(f,1),0==g.length&&delete e.getObjectDop(a).op[b],!0))},e.core.emitClose=function(a,b){a.listener&&a.listener.emit("close",b),a.emit("close",b)},e.core.emitConnect=function(a){a.listener&&a.listener.emit("connect",a),a.emit("connect")},e.core.emitDisconnect=function(a){a.listener&&(e.core.unregisterNode(a),a.listener.emit("disconnect",a)),a.emit("disconnect")},e.core.emitMessage=function(a,b,f){a.listener&&a.listener.emit("message",a,b,f),a.emit("message",b,f);var g;if("string"==typeof b&&"["==b.substr(0,1))try{g=e.decode(b)}catch(a){}else g=b;if("array"==e.util.typeof(g)){"number"==typeof g[0]&&(g=[g]);for(var h,i,j,k,l,m,n,o=0,p=g.length;o<p;o++)if(h=g[o],k=h[0],"number"==typeof k&&0!==k){n=e.util.typeof(h[1]),i="number"==n&&"array"!=n||k<0?[k,h.slice(1)]:i=h;for(var q,r=1,s=i.length;r<s;++r)j=i[r],"array"==e.util.typeof(j)&&("number"==typeof j[0]&&k>0||k<0)&&(m=j[0],q="on"+e.protocol.instructions[m],k>0&&c(e.protocol[q])?e.protocol[q](a,k,j):(k*=-1,d(a.requests[k])&&(l=j,j=a.requests[k],m=j[1],q="_on"+e.protocol.instructions[m],c(e.protocol[q])&&e.protocol[q](a,k,j,l),delete a.requests[k])))}}},e.core.emitOpen=function(a,b,c){var d;return a instanceof e.core.node?d=a:(d=new e.core.node,d.listener=a,d.try_connects=a.options.try_connects),d.transport=c,e.core.registerNode(d),a.emit("open",b),d},e.core.emitReconnect=function(a,b,c){a.listener&&(e.core.unregisterNode(c),a.listener.emit("reconnect",a,b)),a.emit("reconnect",b)},e.core.sendConnect=function(a){var b=e.core.createRequest(a,e.protocol.instructions.connect,a.token);e.core.storeRequest(a,b),e.core.emitRequests(a,JSON.stringify)},e.core.collector=function(a,b){this.active=!0,this.shallWeGenerateAction=!0,this.shallWeGenerateUnaction=!0,this.mutations=[],this.queue=a,a.splice(b,0,this)},e.core.collector.prototype.add=function(a){return!(!this.active||void 0!==this.filter&&this.filter(a)!==!0)&&(this.shallWeGenerateAction=!0,this.shallWeGenerateUnaction=!0,this.mutations.push(a),!0)},e.core.collector.prototype.emit=function(){var a=this.mutations;return e.emit(a,this.action),this.mutations=[],a},e.core.collector.prototype.destroy=function(){this.active=!1,this.queue.splice(this.queue.indexOf(this),1)},e.core.collector.prototype.emitAndDestroy=function(){return this.destroy(),this.emit()},e.core.collector.prototype.getAction=function(){return this.shallWeGenerateAction&&(this.shallWeGenerateAction=!1,this.action=e.getAction(this.mutations)),this.action},e.core.collector.prototype.getUnaction=function(){return this.shallWeGenerateUnaction&&(this.shallWeGenerateUnaction=!1,this.unaction=e.getUnaction(this.mutations)),this.unaction},e.core.listener=function(a){e.util.merge(this,new e.util.emitter),a.unshift(e,this),this.options=a[2],this.transport=this.options.transport,this.listener=this.options.transport.apply(this,a)},e.core.node=function(){e.util.merge(this,new e.util.emitter),this.object_owned={},this.object_subscribed={},this.request_inc=1,this.requests={},this.requests_queue=[];do this.token=e.util.uuid();while("object"==typeof e.data.node[this.token])},e.core.node.prototype.send=function(a){this.emit(e.cons.SEND,a)},e.core.node.prototype.disconnect=function(){this.emit(e.cons.DISCONNECT)},e.core.node.prototype.subscribe=function(){e.protocol.subscribe(this,arguments)},e.core.error={warning:{TOKEN_REJECTED:"User disconnected because is rejecting too many times the token assigned"},reject:{}},e.core.delete=function(a,b){var c=Object.getOwnPropertyDescriptor(a,b);if(c&&c.configurable){var d=e.getObjectTarget(a),f=e.getObjectProxy(a);if(d===f||a===f){var g={object:e.getObjectProxy(d),name:b,oldValue:d[b]};e.core.storeMutation(g)}return delete d[b]}},e.core.pop=function(a){if(0!==a.length){var b=e.core.splice(a,[a.length-1,1]);return b[0]}},e.core.push=function(a,b){if(0===b.length)return a.length;b.unshift(a.length,0);e.core.splice(a,b);return a.length},e.core.reverse=function(a){for(var b,c=e.getObjectTarget(a),d=e.getObjectProxy(a),f=c.length/2,g=0,h=[],i=c===d||a===d;g<f;++g)b=c.length-g-1,g!==b&&(tempItem=c[b],c[b]=c[g],c[g]=tempItem,i&&h.push(g,b),e.core.updatePathArray(c,g),e.core.updatePathArray(c,b));return i&&h.length>0&&e.core.storeMutation({object:d,swaps:h}),a},e.core.set=function(a,b,c){if(a[b]!==c){var d=Object.getOwnPropertyDescriptor(a,b);if(!d||d&&d.writable){var f=e.getObjectTarget(a),g=e.getObjectProxy(a),h=f[b],i=f.length,j=f.hasOwnProperty(b);if(f[b]=c,e.isObjectRegistrable(c)&&(f[b]=e.core.configureObject(c,e.getObjectDop(f).concat(b),f)),f===g||a===g){var k={object:g,name:b,value:c};return j&&(k.oldValue=h),Array.isArray(f)&&(k.length=i),Array.isArray(c)&&(k.valueOriginal=e.util.merge([],c)),e.core.storeMutation(k),k}}}},e.core.shift=function(a){if(0!==a.length){var b=e.core.splice(a,[0,1]);return b[0]}},e.core.sort=function(a,b){var c,d,f=e.getObjectTarget(a),g=e.getObjectProxy(a),h=f.slice(0);return c=Array.prototype.sort.call(f,b),d=e.core.sortDiff(f,h),d.length>1&&(f===g||a===g)&&e.core.storeMutation({object:g,swaps:d}),c},e.core.sortDiff=function(a,b){for(var c,d,f=b.length,g=[],h=0;h<f;++h)a[h]!==b[h]&&(c=b.indexOf(a[h]),d=b[h],b[h]=b[c],b[c]=d,g.push(h,c),e.core.updatePathArray(b,h),e.core.updatePathArray(b,c));return g},e.core.splice=function(a,b){var c,d=a.length,f=e.getObjectTarget(a),g=e.getObjectProxy(a);if(c=Array.prototype.splice.apply(f,b),f===g||a===g){var h,i,j,k=b.length,l=f.length,m=Number(b[0]),n=Number(b[1])>0?b[1]:0,o=b.length>2?b.length-2:0;for(isNaN(m)?m=0:m<0?m=l+m<0?0:l+m:m>d&&(m=d),h=1===k?0:k>2&&n===o?m+n:f.length;m<h;++m)i=f[m],e.isObjectRegistrable(i)&&(j=e.getObjectDop(i),void 0!==j&&j._===f?j[j.length-1]=m:f[m]=e.core.configureObject(i,e.getObjectDop(f).concat(m),f));if(d!==l||o>0){b[0]<0&&(b[0]=a.length+b[0]);var p={object:g,splice:b};c.length>0&&(p.spliced=c),e.core.storeMutation(p)}}return c},e.core.swap=function(a,b){if(b.length>1){for(var c,d,f,g=e.getObjectTarget(a),h=e.getObjectProxy(a),i=0,j=b.length-1;i<j;i+=2)d=b[i],f=b[i+1],c=g[d],g[d]=g[f],g[f]=c,e.core.updatePathArray(g,d),e.core.updatePathArray(g,f);return g!==h&&a!==h||e.core.storeMutation({object:h,swaps:b}),a}},e.core.unshift=function(a,b){if(0===b.length)return a.length;b.unshift(0,0);e.core.splice(a,b);return a.length};var f=c(Proxy);e.core.configureObject=function(a,b,c){if(e.isRegistered(a))return e.core.configureObject(e.util.merge(Array.isArray(a)?[]:{},a),b,c);var g,h,i;for(g in a)h=a[g],e.isObjectRegistrable(h)&&(a[g]=e.core.configureObject(h,b.concat(g),a));if(Object.defineProperty(a,e.cons.DOP,{value:b.slice(0)}),i=e.getObjectDop(a),i.m=[],i.o=[],i.op={},d(c)&&(i._=e.isRegistered(c)?e.getObjectTarget(c):c),f){var j=a;a=new Proxy(a,e.core.proxyObjectHandler),i.p=a,i.t=j}else i.p=i.t=a;return"array"==e.util.typeof(a)&&Object.defineProperties(a,e.core.proxyArrayHandler),a},e.core.createAsync=function(a,b){var c,d,e=new Promise(function(a,b){c=a,d=b});return e.resolve=c,e.reject=d,e},e.core.createCollector=function(a,b,c){var d=new e.core.collector(a,b);return d.filter=c,d},e.core.emitObservers=function(a){for(var b,c,d,f,g,h,i,j=[],k=0,l=a.length,m=!1;k<l;++k){if(b=a[k],c=b.object,g=e.getObjectDop(c),!m&&e.data.object_data[g[0]].nodes>0&&(m=!0),h=g.op[b.name],"array"==e.util.typeof(h)&&h.length>0)for(d=0,f=h.length;d<f;++d)h[d](b);if(j.indexOf(c)===-1){for(j.push(c),i=g.o,d=0,f=i.length;d<f;++d)i[d](g.m.slice(0));g.m=[]}}return m},e.core.injectMutationInAction=function(a,b,c){var f,g=void 0!==b.splice||void 0!==b.swaps,h=e.getObjectDop(b.object).slice(0),i=e.data.object,j=b.name,k=c?b.oldValue:b.value,l=e.util.typeof(k),m=0,n=Array.isArray;for(g||h.push(j);m<h.length-1;++m)f=a,j=h[m],void 0!==i&&(i=i[j]),a=d(a[j])?a[j]:a[j]={};if(j=h[m],g||n(i)){g&&!d(a[j])&&(a[j]={}),g&&(a=a[j]),d(a[e.cons.DOP])||(a[e.cons.DOP]=[]);var o=a[e.cons.DOP];if(void 0!==b.swaps){var p=b.swaps.slice(0);c&&p.reverse();var q=p[0]>0?0:1;p[q]=p[q]*-1,o.push(p)}else if(void 0!==b.splice){var r;c?(r=b.spliced?b.spliced.slice(0):[],r.unshift(b.splice[0],b.splice.length-2)):r=b.splice.slice(0),o.push(r)}else o.push([j,1,k]);c&&void 0!==b.length&&b.length!==i.length&&(a.length=b.length)}else a[j]="object"==l||"array"==l?e.util.merge("array"==l?[]:{},k):k},e.core.localProcedureCall=function(a,b,d,f,g){var h,i=e.core.createAsync();c(g)&&(i=g(i)),b.push(i),i.then(d).catch(f),h=a.apply(i,b),h!==i&&i.resolve(h)},e.core.objectIsStillStoredOnPath=function(a){for(var b,c=e.getObjectDop(a),d=c.length-1;d>0;--d){if(b=d>1?e.getObjectDop(a)._:e.data.object[c[0]],b[c[d]]!==a)return!1;a=e.getObjectProxy(b)}return!0},e.core.proxyArrayHandler={splice:{value:function(){return e.core.splice(this,Array.prototype.slice.call(arguments,0))}},shift:{value:function(){return e.core.shift(this,Array.prototype.slice.call(arguments,0))}},pop:{value:function(){return e.core.pop(this,Array.prototype.slice.call(arguments,0))}},push:{value:function(){return e.core.push(this,Array.prototype.slice.call(arguments,0))}},unshift:{value:function(){return e.core.unshift(this,Array.prototype.slice.call(arguments,0))}},reverse:{value:function(){return e.core.reverse(this)}},sort:{value:function(a){return e.core.sort(this,a)}}},e.core.proxyObjectHandler={set:function(a,b,c){return void 0!==e.core.set(e.getObjectProxy(a),b,c)},deleteProperty:function(a,b){return void 0!==e.core.delete(e.getObjectProxy(a),b)}},e.core.storeMutation=function(a){var b,c=e.data.collectors,d=0,f=c.length,g=0;for(e.getObjectDop(a.object).m.push(a);d<f;d++)if(c[d].length>0)for(g=0,b=c[d].length;g<b;g++)if(c[d][g].add(a))return;return e.emit([a])},e.core.updatePathArray=function(a,b){var c=a[b];if(e.isRegistered(c)){var f=e.getObjectDop(c),g=f.length-1;f[g]!==b&&(f[g]=b,e.util.path(c,function(a,c,f){d(f)&&(e.getObjectDop(f)[g]=b)}))}return!1},e.core.connector=function(a){var b=new e.core.node;return a.unshift(e,b),b.options=a[2],b.transport=b.options.transport,b.options.transport.apply(this,a),b},e.core.createRequest=function(a,b){var c=a.request_inc++,d=Array.prototype.slice.call(arguments,1);return d.unshift(c),d.promise=e.core.createAsync(),d},e.core.createResponse=function(){return arguments[0]=arguments[0]*-1,Array.prototype.slice.call(arguments,0)};var g=/^\d\d\d\d-\d\d-\d\dT\d\d:\d\d:\d\d.\d\d\dZ$/,h=/\/(.+)\/([gimuy]{0,5})/;e.core.decode=function(a,b,c){if("string"==typeof b){if("~F"===b)return e.core.remoteFunction(this,a);if("~U"==b&&d(c))return void c.push([this,a]);if("~I"===b)return 1/0;if("~i"===b)return-(1/0);if("~N"===b)return NaN;if(g.exec(b))return new Date(b);if("~R"==b.substr(0,2)){var f=h.exec(b.substr(2));return new RegExp(f[1],f[2])}if("~"===b[0])return b.substring(1)}return b},e.core.emitNodes=function(a){var b,c,d;for(b in a)if(e.data.object_data[b].nodes>0)for(c in e.data.object_data[b].node)d=e.data.node[c],e.protocol.merge(d,b,a[b])},e.core.emitRequests=function(a,b){"function"!=typeof b&&(b=e.encode);for(var c=a.requests_queue,d=0,f=c.length;d<f;++d)a.requests[c[d][0]]=c[d];a.requests_queue=[],a.send(b(f>1?c:c[0]))},e.core.encode=function(a,b){var c=typeof b;return"function"==c?"~F":"undefined"==c?"~U":b===1/0?"~I":b===-(1/0)?"~i":"number"==c&&isNaN(b)?"~N":"object"==c&&b instanceof RegExp?"~R"+b.toString():"string"==c&&"~"===b[0]?"~"+b:b},e.core.getRejectError=function(a){if("number"==typeof a&&void 0!==e.core.error.reject[a]){var b=Array.prototype.slice.call(arguments,1);return b.unshift(e.core.error.reject[a]),e.util.sprintf.apply(this,b)}return a},e.core.registerNode=function(a){e.data.node[a.token]=a},e.core.registerObjectToNode=function(a,b){var c=e.getObjectId(b),d=e.data.object_data[c];return void 0===d.node[a.token]&&(d.node[a.token]=!0,d.nodes+=1,a.object_subscribed[c]=!0,!0)},e.core.remoteFunction=function(a,b){return function(){console.log(e.getObjectDop(a),b,Array.prototype.slice.call(arguments,0))}},e.core.setSocketToNode=function(a,b){a.socket=b,b[e.cons.TOKEN]=a.token},e.core.storeRequest=function(a,b){a.requests_queue.push(b)},e.core.unregisterNode=function(a){var b,c;for(b in a.object_subscribed)c=e.data.object_data[b],c.nodes-=1,delete c.node[a.token];delete e.data.node[a.token]},e.protocol._onconnect=function(a,b,c,d){c[2];0===d[0]&&a.emit(e.cons.CONNECT,c,d)},e.protocol._onsubscribe=function(a,b,c,d){if(void 0!==d[0])if(0!==d[0])c.promise.reject(e.core.getRejectError(d[0],c[2]));else{var f,g,h=d[1],i=h[0],j=d[2];void 0===a.object_owned[i]?(f=e.register(j),g=e.getObjectId(f),a.object_owned[i]=g):(g=a.object_owned[i],f=e.getObjectRootById(g)),c.promise.resolve(e.util.get(f,h.slice(1)))}},e.protocol.instructions={connect:0,subscribe:1,unsubscribe:2,call:3,mutation:4};for(var i in e.protocol.instructions)e.protocol.instructions[e.protocol.instructions[i]]=i;return e.protocol.merge=function(a,b,c){console.log(a.token,b,c)},e.protocol.onconnect=function(a,b,c){var d=c[1],f=e.core.createResponse(b,0);a.tokenServer=d,a.emit(e.cons.CONNECT,JSON.stringify(f))},e.protocol.onsubscribe=function(a,b,f){if(c(e.data.onsubscribe)){var g,h,i=Array.prototype.slice.call(f,1);e.core.localProcedureCall(e.data.onsubscribe,i,function(c){if(d(c)){g=e.register(c);var f=e.getObjectId(g);return h=e.core.createResponse(b,0,e.getObjectDop(g)),e.core.registerObjectToNode(a,g)&&h.push(e.getObjectRootById(f)),a.send(e.encode(h)),g}e.util.invariant(!1,"dop.onsubscribe callback must return or resolve a regular object")},function(c){h=e.core.createResponse(b),c instanceof Error?console.log(c.stack):h.push(c),a.send(JSON.stringify(h))},function(b){return b.node=a,b})}},e.protocol.subscribe=function(a,b){b=Array.prototype.slice.call(b,0),b.unshift(a,e.protocol.instructions.subscribe);var c=e.core.createRequest.apply(a,b);return e.core.storeRequest(a,c),e.core.emitRequests(a),c.promise},void 0===b?e:void("function"==typeof define&&define.amd?define([],function(){return e}):"object"==typeof module&&module.exports?module.exports=e:window&&"object"==typeof window?window.dop=e:b.dop=e)}(this);