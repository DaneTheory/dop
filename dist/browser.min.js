var dop={version:"0.9.0",name:"dop",port:4444,key_user_token:"~TOKEN",key_object_path:"~PATH",stringify_function:"~F",stringify_undefined:"~U",stringify_regexp:"~R",name_remote_function:"$DOP_REMOTE_FUNCTION",util:{},on:{},_on:{},listener:{},connector:{},node_inc:0,node:{},object_inc:0,objects:{}};"object"==typeof module&&module&&(module.exports=dop),dop.listen=function(a){this.options="object"==dop.util["typeof"](a)?a:{},this.options.encode_params={},"function"!=typeof this.options.listener&&(this.options.listener=dop.listener.ws),"string"!=typeof this.options.namespace&&(this.options.namespace="/"+dop.name),this.options.namespace+=this.options.listener._name,"string"!=typeof this.options.encode_function?this.options.encode_function=synko.encode_function:this.options.encode_params[synko.encode_function]=this.options.encode_function,"string"!=typeof this.options.encode_undefined?this.options.encode_undefined=synko.encode_undefined:this.options.encode_params[synko.encode_undefined]=this.options.encode_undefined,"string"!=typeof this.options.encode_regexp?this.options.encode_regexp=synko.encode_regexp:this.options.encode_params[synko.encode_regexp]=this.options.encode_regexp;({open:dop.on.open.bind(this),message:dop.on.message.bind(this),close:dop.on.close.bind(this)})},dop.on.close=function(a){var b=this.users[a[dop.key_user_token]];if("string"==typeof a[dop.key_user_token]){var c,d;for(c in b.objects)d=b.objects[c][dop.key_object_path][0],1==dop.objects[d].subscribed?delete dop.objects[d]:(dop.objects[d].subscribed--,delete dop.objects[d].users[b.token]);this.emit("disconnect",b),delete this.users[b.token]}this.emit("close",a)},dop.on.message=function(a,b){var c,d="undefined"==typeof a[dop.key_user_token]?a:this.users[a[dop.key_user_token]];if("string"==typeof b)try{c=dop.parse.call(this,b)}catch(e){}else c=b;this.emit("message",d,c,b),"array"==dop.util["typeof"](c)&&dop.core.manage.call(this,d,c)},dop.on.open=function(a){this.emit("open",a)},dop.node.prototype.call=function(a,b){var c=[dop.protocol.call,a,b],d=dop.request.call(this.dop,c);return this.send(dop.stringify.call(this,d.data)),d.promise},dop.node.prototype.close=function(){return this.socket.close()},dop.node.prototype.request=function(){var a=[dop.protocol.request,Array.prototype.slice.call(arguments,0)],b=dop.request.call(this.dop,a);return this.send(dop.stringify.call(this,b.data)),b.promise},dop.node.prototype.send=function(a){return this.socket.send(a)},dop.node.prototype.sync=function(a,b,c){var d=this,e=this.dop;if(a=a.trim(),"object"==typeof d.objects[a])throw new TypeError(dop.error.SYNC_NO_REPEAT_NAME);if("object"!=typeof b)throw new TypeError(dop.error.SYNC_MUST_BE_OBJECT);if("object"!=typeof c&&(c={}),"boolean"!=typeof c.writable&&(c.writable=!1),"boolean"!=typeof c.observable&&(c.observable=!1),"array"!=dop.util["typeof"](b[dop.key_object_path]))f=dop.object_inc++,dop.configure.call(e,b,[f]),dop.objects[f]={object:b,users:{},subscribed:0,observable:c.observable};else{if(b[dop.key_object_path].length>1)throw new TypeError(dop.error.SYNC_NO_INNER);var f=b[dop.key_object_path][0];"undefined"==typeof dop.objects[f]&&(dop.objects[f]={object:b,users:{},subscribed:0,observable:c.observable})}dop.objects[f].users[d.token]=d,dop.objects[f].subscribed+=1,d.objects[a]=b,d.writables[f]=c.writable;var g=dop.request.call(e,[dop.protocol.sync,f,1*c.writable,b,a]);return d.send(dop.stringify.call(e,g.data)),g.promise},dop.util.arguments=function(a,b){for(var c=a;"function"==typeof c.callee.caller;){if(b(c.callee.caller.arguments))return a[0];c=c.callee.caller.arguments}return a[0]},dop.util.get=function(a,b,c){for(var d,e=0,f=b.length;f>e;e++)if(d=dop.util["typeof"](a[b[e]]),f>e+1&&null!==a[b[e]]&&("object"==d||"array"==d))a=a[b[e]];else{if(a.hasOwnProperty(b[e]))return a[b[e]];if(!c||!c(a,b[e],e))return;a[b[e]]={}}return a[b[e]]},dop.util.merge=function(){return function a(b,c){var d,e,f,g,h=arguments;if(h.length<2)return b;if(h.length>2)return Array.prototype.splice.call(h,0,2,a(b,c)),a.apply(this,h);for(d in c)d in c&&(f=b[d],e=c[d],e!==b&&(null===e||"object"!=typeof e&&!Array.isArray(e)||e instanceof Date||e instanceof RegExp?b[d]=e:"object"==typeof f&&null!==f?(g=f,b[d]=a(g,e)):(g=Array.isArray(e)?[]:{},b[d]=a(g,e))));return b}}(),dop.util.path=function(a,b){dop.util.path.recursive.call({circular:[]},a,b,[])},dop.util.path.recursive=function(a,b,c){for(var d in a){if(c.push(d),0==this.stop)return;this.stop=b(c,a[d],d,a),a[d]&&"object"==typeof a[d]&&a[d]!==a&&-1==this.circular.indexOf(a[d])&&(this.circular.push(a[d]),dop.util.path.recursive.call(this,a[d],b,c)),c.pop()}},dop.util.promise=function(a){function b(a,b){f.length>0?c.call(h,0,a,b):setTimeout(function(){c.call(h,0,a,b)},0)}function c(a,b,e){var g=a+1;if("object"==typeof f[a]&&"function"==typeof f[a][h.type]){try{e=[f[a][h.type].apply(f[a][h.type].hasToGoUp?h:b,e)],h.type&&!d&&(h.type=0)}catch(i){h.type=1,e=[i]}if(e[0]===h)h.type=1,e[0]=new TypeError("Promise resolved by its own instance");else if(e[0]instanceof h.constructor){var j=function(){h.type=this.type,c.call(h,g,b,arguments)};return j.hasToGoUp=!0,void e[0].then(j,j)}}g<f.length&&c(g,b,e)}var d,e,f=[],g=0,h=this;this.state=g,this.then=function(a,b){return"function"==typeof a&&f.push([a]),"function"==typeof b&&f.push([void 0,b]),this},this["catch"]=function(a){return h.then(0,a)},this.completed=function(a){return e=a,h},this.resolve=function(){return 3===g?h:(g=h.state=1,d=h.type=0,void b(this,arguments))},this.reject=function(){return 3===g?h:(g=h.state=2,d=h.type=1,void b(this,arguments))},h.onCompleted=function(){g=h.state=3,"function"==typeof e&&e.apply(this,arguments)},"function"==typeof a&&a(h.resolve,h.reject)},dop.util["typeof"]=function(a){var b=typeof a;return"object"==b&&(a?Array.isArray(a)?b="array":a instanceof Date?b="date":a instanceof RegExp&&(b="regexp"):b="null"),b},dop.connector.socketio=function(a,b){var c=dop.connector.socketio.api(a.url);return c.on("connect",function(){b.open()}),c.on("message",function(a){b.message(a)}),c.on("disconnect",function(){b.close()}),c.on("error",function(a){b.error(a)}),c},dop.connector.socketio._name="socketio",dop.connector.socketio.api=window.io,dop.connector.SockJS=function(a,b){var c=new dop.connector.SockJS.api(a.url,void 0,a);return c.addEventListener("open",function(){b.open()}),c.addEventListener("message",function(a){b.message(a.data)}),c.addEventListener("close",function(){b.close()}),c.addEventListener("error",function(a){b.error(a)}),c},dop.connector.SockJS._name="SockJS",dop.connector.SockJS.api=window.SockJS,dop.connector.ws=function(a,b){var c=a.ssl?"wss":"ws",d=new WebSocket(c+"://"+a.host+"/"+a.prefix);return d.addEventListener("open",function(){b.open()}),d.addEventListener("message",function(a){b.message(a.data)}),d.addEventListener("close",function(){b.close()}),d.addEventListener("error",function(a){b.error(a)}),d},dop.connector.ws._name="ws",dop.connector.ws.api=WebSocket;