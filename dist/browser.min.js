/* dop@0.6.0 - (c) 2016 Josema Gonzalez - MIT Licensed */
!function a(b){function c(a){return"function"==typeof a}function d(a){return null!==a&&"object"==typeof a}function e(a){return Array.isArray(a)}var f={name:"dop",create:a,data:{node_inc:0,node:{},object_inc:1,object:{},collectors:[[],[]]},util:{},core:{},protocol:{},transports:{listen:{},connect:{}},cons:{TOKEN:"~TOKEN_DOP",DOP:"~DOP",CONNECT:"~CONNECT",SEND:"~SEND",DISCONNECT:"~DISCONNECT"}};f.connect=function(a){var b=Array.prototype.slice.call(arguments,0);return"object"!=f.util.typeof(b[0])&&(a=b[0]={}),"function"!=typeof a.transport&&(a.transport=f.transports.connect.websocket),f.core.connector(b)},f.util.emitter=function(){this._events={}},f.util.emitter.prototype.on=function(a,b,e){return c(b)&&(d(this._events)||(this._events={}),d(this._events[a])||(this._events[a]=[]),this._events[a].push(e===!0?[b,!0]:[b])),this},f.util.emitter.prototype.once=function(a,b){return this.on(a,b,!0)},f.util.emitter.prototype.emit=function(a){if(d(this._events[a])&&this._events[a].length>0){for(var b=0,c=[],e=Array.prototype.slice.call(arguments,1);b<this._events[a].length;b++)c.push(this._events[a][b][0]),this._events[a][b][1]===!0&&(this._events[a].splice(b,1),b-=1);for(b=0;b<c.length;b++)c[b].apply(this,e)}return this},f.util.emitter.prototype.removeListener=function(a,b){if(d(this._events[a])&&this._events[a].length>0)for(var c=0;c<this._events[a].length;c++)this._events[a][c][0]===b&&(this._events[a].splice(c,1),c-=1);return this},f.listen=function(a){var b=Array.prototype.slice.call(arguments,0);return"object"!=f.util.typeof(b[0])&&(a=b[0]={}),"function"!=typeof a.transport&&(a.transport=f.transports.listen.local),("number"!=typeof a.try_connects||a.try_connects<0)&&(a.try_connects=99),new f.core.listener(b)},function(a){function b(a,b,f){function j(a){w.readyState===g&&u===i?w.send(a):x.push(a)}function k(){if(w.readyState===g)for(;x.length>0;)w.send(x.shift())}function l(){u===h?w.send(b.tokenServer):(w.send(""),u=g),a.core.emitOpen(b,w,f.transport)}function m(c){u===h&&c.data===b.tokenServer?(u=i,a.core.setSocketToNode(b,w),a.core.emitReconnect(b,oldSocket),k()):a.core.emitMessage(b,c.data,c)}function n(){u=e,a.core.emitClose(b,w)}function o(){u===h&&(a.core.emitDisconnect(b),a.core.setSocketToNode(b,w)),u=i,a.core.emitConnect(b),k()}function p(){u=e,w.close()}function q(){u===e&&(oldSocket=w,w=new v(r),u=h,c(w,l,m,n),d(oldSocket,l,m,n))}var r="ws://localhost:4444/"+a.name;if("string"==typeof f.url)r=f.url.replace("http","ws");else if("undefined"!=typeof window&&/http/.test(window.location.href)){var s=/(ss|ps)?:\/\/([^\/]+)\/?(.+)?/.exec(window.location.href),t=s[1]?"wss":"ws";r=t+"://"+s[2].toLocaleLowerCase()+"/"+a.name}var u,v=f.transport.getApi(),w=new v(r),x=[];return a.core.setSocketToNode(b,w),u=e,b.reconnect=q,b.on(a.cons.CONNECT,o),b.on(a.cons.SEND,j),b.on(a.cons.DISCONNECT,p),c(w,l,m,n),w}function c(a,b,c,d){a.addEventListener("open",b),a.addEventListener("message",c),a.addEventListener("close",d)}function d(a,b,c,d){a.removeEventListener("open",b),a.removeEventListener("message",c),a.removeEventListener("close",d)}"undefined"==typeof f&&"object"==typeof module&&module.exports?module.exports=b:(b.getApi=function(){return window.WebSocket},"undefined"!=typeof f?f.transports.connect.websocket=b:a.dopTransportsConnectWebsocket=b);var e=0,g=1,h=2,i=3}(this),f.util.get=function(a,b){if(0===b.length)return a;for(var c=0,e=b.length;c<e;c++){if(!(c+1<e&&d(a[b[c]])))return a.hasOwnProperty(b[c])?a[b[c]]:void 0;a=a[b[c]]}return a[b[c]]},f.util.invariant=function(a){if(!a){var b=f.util.sprintf.apply(this,Array.prototype.slice.call(arguments,1));throw new Error("[dop] Invariant failed: "+b)}},f.util.merge=function(a,b){var c=arguments;return c.length>2?(Array.prototype.splice.call(c,0,2,f.util.merge.call(this,a,b)),f.util.merge.apply(this,c)):f.util.path(b,this,a,f.util.mergeMutator)},f.util.mergeMutator=function(a,b,c,d){"object"==d||"array"==d?a.hasOwnProperty(b)?a[b]:a[b]="array"==d?[]:{}:a[b]=c},f.util.path=function(a,b,e,g){var h=c(b),i=d(e);return f.util.pathRecursive(a,b,e,g,[],[],h,i),e},f.util.pathRecursive=function(a,b,c,d,e,g,h,i){var j,k,l,m;for(j in a)m=!1,k=a[j],g.push(j),h&&(m=b(a,j,k,c,g,this)),m!==!0&&(l=f.util.typeof(k),i&&(m=d(c,j,k,l,g)),"object"!=l&&"array"!=l||m===!0||k===a||e.indexOf(k)!=-1||(e.push(k),f.util.pathRecursive(k,b,i?c[j]:void 0,d,e,g,h,i)),g.pop())},f.util.sprintf=function(){var a,b=-1,c=arguments[0],d=Array.prototype.slice.call(arguments,1);return c.replace(/"/g,"'").replace(/%([0-9]+)|%s/g,function(){return a=d[void 0===arguments[1]||""===arguments[1]?++b:arguments[1]],void 0===a&&(a=arguments[0]),a})},f.util.typeof=function(a){var b=typeof a;return"object"==b&&(a?e(a)?b="array":a instanceof Date?b="date":a instanceof RegExp&&(b="regexp"):b="null"),b},f.util.uuid=function(){for(var a,b=0,c="";b<32;b++)a=16*Math.random()|0,8!==b&&12!==b&&16!==b&&20!==b||(c+="-"),c+=(12===b?4:16===b?3&a|8:a).toString(16);return c},f.collect=function(a){return f.util.invariant(0===arguments.length||arguments.length>0&&c(a),"dop.collect only accept one argument as function"),f.core.createCollector(f.data.collectors[0],f.data.collectors[0].length,a)},f.collectFirst=function(a){return f.util.invariant(0===arguments.length||arguments.length>0&&c(a),"dop.collectFirst only accept one argument as function"),f.core.createCollector(f.data.collectors[0],0,a)},f.decode=function(a){var b,c=[],d=0,e=JSON.parse(a,function(a,b){return f.core.decode.call(this,a,b,c)});for(b=c.length;d<b;++d)c[d][0][c[d][1]]=void 0;return e},f.del=function(a,b){return f.isRegistered(a)?void 0!==f.core.delete(a,b):delete a[b]},f.emit=function(a,b){a.length>0&&f.core.emitObservers(a)&&(void 0===b&&(b=f.getAction(a)),f.core.emitNodes(b))},f.encode=function(a,b){var c;return function(a,b){return"function"!=typeof b&&(void 0===c&&(c=f.core.multiEncode(f.core.encodeSpecial,f.core.encodeProtocol,f.core.encodeUtil)),b=c),JSON.stringify(a,b)}}(),f.getAction=function(a){for(var b,c,d={},e=0,g=a.length;e<g;++e)b=a[e],f.core.objectIsStillStoredOnPath(b.object)&&(c=f.getObjectId(b.object),void 0===d[c]&&(d[c]={object:f.getObjectRoot(b.object),action:{}}),f.core.injectMutationInAction(d[c].action,b));return d},f.getNodeBySocket=function(a){return f.data.node[a[f.cons.TOKEN]]},f.getObjectDop=function(a){if(d(a))return a[f.cons.DOP]},f.getObjectId=function(a){var b=f.getObjectDop(a);return b?b[0]:void 0},f.getObjectParent=function(a){var b=f.getObjectDop(a);return b?b._:void 0},f.getObjectProperty=function(a){var b=f.getObjectDop(a);return b[b.length-1]},f.getObjectProxy=function(a){return f.getObjectDop(a).p},f.getObjectRoot=function(a){for(;void 0!==f.getObjectParent(a);)a=f.getObjectParent(a);return f.getObjectProxy(a)},f.getObjectTarget=function(a){return f.getObjectDop(a).t},f.getUnaction=function(a){for(var b,c,d={},e=a.length-1;e>-1;--e)c=a[e],b=f.getObjectId(c.object),void 0===d[b]&&(d[b]={object:f.getObjectRoot(c.object),action:{}}),f.core.injectMutationInAction(d[b].action,c,!0);return d},f.isObjectRegistrable=function(a){var b=f.util.typeof(a);return"object"===b||"array"==b},f.isProxy=function(a){return f.isRegistered(a)&&f.getObjectProxy(a)===a},f.isRegistered=function(a){if(d(a)){var b=f.getObjectDop(a);if(e(b)&&b.hasOwnProperty("p"))return!0}return!1},f.isTarget=function(a){return f.isRegistered(a)&&f.getObjectTarget(a)===a},f.observe=function(a,b){if(f.util.invariant(f.isRegistered(a),"dop.observe needs a registered object as first parameter"),f.util.invariant(c(b),"dop.observe needs a callback as second parameter"),f.getObjectDop(a).o.indexOf(b)==-1)return f.getObjectDop(a).o.push(b),function(){return f.unobserve(a,b)}},f.observeProperty=function(a,b,d){f.util.invariant(f.isRegistered(a),"dop.observeProperty needs a registered object as first parameter"),f.util.invariant(c(d),"dop.observeProperty needs a callback as third parameter"),"object"!=f.util.typeof(f.getObjectDop(a).op)&&(f.getObjectDop(a).op={});var e="array"!=f.util.typeof(f.getObjectDop(a).op[b])?f.getObjectDop(a).op[b]=[]:f.getObjectDop(a).op[b];if(e.indexOf(d)==-1)return e.push(d),function(){return f.unobserveProperty(a,b,d)}},f.onsubscribe=function(a){f.util.invariant(c(a),"dop.onsubscribe only accept a function as parameter"),f.data.onsubscribe=a},f.register=function(a,b){if(f.util.invariant(f.isObjectRegistrable(a),"dop.register needs a regular object as first parameter"),f.isRegistered(a))return f.getObjectProxy(a);var c=f.data.object_inc++;return a=f.core.configureObject(a,[c])},f.set=function(a,b,c){return f.isRegistered(a)?f.core.set(a,b,c):a[b]=c,c},f.setAction=function(a){var b,c=f.collectFirst();for(b in a)f.core.setAction(a[b].object,a[b].action);return c},f.unobserve=function(a,b){f.util.invariant(f.isRegistered(a),"dop.unobserve needs a registered object as first parameter"),f.util.invariant(c(b),"dop.unobserve needs a callback as second parameter");var d,e=f.getObjectDop(a).o;return"array"==f.util.typeof(e)&&(d=e.indexOf(b),d!=-1&&(e.splice(d,1),0==e.length&&delete f.getObjectDop(a).o,!0))},f.unobserveProperty=function(a,b,d){f.util.invariant(f.isRegistered(a),"dop.unobserveProperty needs a registered object as first parameter"),f.util.invariant(c(d),"dop.unobserveProperty needs a callback as second parameter");var e,g=f.getObjectDop(a).op;return"object"==f.util.typeof(g)&&"array"==f.util.typeof(g[b])&&(g=g[b],e=g.indexOf(d),e!=-1&&(g.splice(e,1),0==g.length&&delete f.getObjectDop(a).op[b],!0))},f.core.emitClose=function(a,b){a.listener&&a.listener.emit("close",b),a.emit("close",b)},f.core.emitConnect=function(a){a.connected=!0,a.listener&&a.listener.emit("connect",a),a.emit("connect")},f.core.emitDisconnect=function(a){a.connected=!1,a.listener&&(f.core.unregisterNode(a),a.listener.emit("disconnect",a)),a.emit("disconnect")},f.core.emitMessage=function(a,b,e){a.listener&&a.listener.emit("message",a,b,e),a.emit("message",b,e);var g;if("string"==typeof b&&"["==b.substr(0,1))try{g=f.decode(b)}catch(a){}else g=b;if("array"==f.util.typeof(g)){"number"==typeof g[0]&&(g=[g]);for(var h,i,j,k,l,m,n,o=0,p=g.length;o<p;o++)if(h=g[o],k=h[0],"number"==typeof k&&0!==k){n=f.util.typeof(h[1]),i="number"==n&&"array"!=n||k<0?[k,h.slice(1)]:i=h;for(var q,r=1,s=i.length;r<s;++r)j=i[r],"array"==f.util.typeof(j)&&("number"==typeof j[0]&&k>0||k<0)&&(m=j[0],q="on"+f.protocol.instructions[m],k>0&&c(f.protocol[q])?f.protocol[q](a,k,j):(k*=-1,d(a.requests[k])&&(l=j,j=a.requests[k],m=j[1],q="_on"+f.protocol.instructions[m],c(f.protocol[q])&&f.protocol[q](a,k,j,l),delete a.requests[k])))}}},f.core.emitOpen=function(a,b,c){var d;return a instanceof f.core.node?d=a:(d=new f.core.node,d.listener=a,d.try_connects=a.options.try_connects),d.transport=c,f.core.registerNode(d),a.emit("open",b),d},f.core.emitReconnect=function(a,b,c){a.listener&&(f.core.unregisterNode(c),a.listener.emit("reconnect",a,b)),a.emit("reconnect",b)},f.core.sendConnect=function(a){var b=f.core.createRequest(a,f.protocol.instructions.connect,a.token);f.core.storeRequest(a,b),f.core.sendRequests(a,JSON.stringify)},f.core.collector=function(a,b){this.active=!0,this.shallWeGenerateAction=!0,this.shallWeGenerateUnaction=!0,this.mutations=[],this.queue=a,a.splice(b,0,this)},f.core.collector.prototype.add=function(a){return!(!this.active||void 0!==this.filter&&this.filter(a)!==!0)&&(this.shallWeGenerateAction=!0,this.shallWeGenerateUnaction=!0,this.mutations.push(a),!0)},f.core.collector.prototype.emit=function(){var a=this.mutations;return f.emit(a,this.action),this.mutations=[],a},f.core.collector.prototype.destroy=function(){this.active=!1,this.queue.splice(this.queue.indexOf(this),1)},f.core.collector.prototype.emitAndDestroy=function(){return this.destroy(),this.emit()},f.core.collector.prototype.getAction=function(){return this.shallWeGenerateAction&&(this.shallWeGenerateAction=!1,this.action=f.getAction(this.mutations)),this.action},f.core.collector.prototype.getUnaction=function(){return this.shallWeGenerateUnaction&&(this.shallWeGenerateUnaction=!1,this.unaction=f.getUnaction(this.mutations)),this.unaction},f.core.listener=function(a){f.util.merge(this,new f.util.emitter),a.unshift(f,this),this.options=a[2],this.transport=this.options.transport,this.listener=this.options.transport.apply(this,a)},f.core.node=function(){f.util.merge(this,new f.util.emitter),this.connected=!1,this.request_inc=1,this.requests={},this.requests_queue=[],this.object_subscribed={},this.object_owner={};do this.token=f.util.uuid();while("object"==typeof f.data.node[this.token])},f.core.node.prototype.send=function(a){this.emit(f.cons.SEND,a)},f.core.node.prototype.disconnect=function(){this.emit(f.cons.DISCONNECT)},f.core.node.prototype.subscribe=function(){return f.protocol.subscribe(this,arguments)},f.core.error={warning:{TOKEN_REJECTED:"User disconnected because is rejecting too many times the token assigned"},reject:{OBJECT_NOT_FOUND:"Object not found to be subscribed"}},f.core.delete=function(a,b){var c=Object.getOwnPropertyDescriptor(a,b);if(c&&c.configurable){var d=f.getObjectTarget(a),e=f.getObjectProxy(a);if(d===e||a===e){var g={object:f.getObjectProxy(d),name:b,oldValue:d[b]};f.core.storeMutation(g)}return delete d[b]}},f.core.pop=function(a){if(0!==a.length){var b=f.core.splice(a,[a.length-1,1]);return b[0]}},f.core.push=function(a,b){if(0===b.length)return a.length;b.unshift(a.length,0);f.core.splice(a,b);return a.length},f.core.reverse=function(a){for(var b,c=f.getObjectTarget(a),d=f.getObjectProxy(a),e=c.length/2,g=0,h=[],i=c===d||a===d;g<e;++g)b=c.length-g-1,g!==b&&(tempItem=c[b],c[b]=c[g],c[g]=tempItem,i&&h.push(g,b),f.core.updatePathArray(c,g),f.core.updatePathArray(c,b));return i&&h.length>0&&f.core.storeMutation({object:d,swaps:h}),a},f.core.set=function(a,b,c){if(a[b]!==c){var d=Object.getOwnPropertyDescriptor(a,b);if(!d||d&&d.writable){var g=f.getObjectTarget(a),h=f.getObjectProxy(a),i=g[b],j=g.length,k=g.hasOwnProperty(b);if(g[b]=c,f.isObjectRegistrable(c)&&(g[b]=f.core.configureObject(c,f.getObjectDop(g).concat(b),g)),g===h||a===h){var l={object:h,name:b,value:c};return k&&(l.oldValue=i),e(g)&&(l.length=j),e(c)&&(l.valueOriginal=f.util.merge([],c)),f.core.storeMutation(l),l}}}},f.core.shift=function(a){if(0!==a.length){var b=f.core.splice(a,[0,1]);return b[0]}},f.core.sort=function(a,b){var c,d,e=f.getObjectTarget(a),g=f.getObjectProxy(a),h=e.slice(0);return c=Array.prototype.sort.call(e,b),d=f.core.sortDiff(e,h),d.length>1&&(e===g||a===g)&&f.core.storeMutation({object:g,swaps:d}),c},f.core.sortDiff=function(a,b){for(var c,d,e=b.length,g=[],h=0;h<e;++h)a[h]!==b[h]&&(c=b.indexOf(a[h]),d=b[h],b[h]=b[c],b[c]=d,g.push(h,c),f.core.updatePathArray(b,h),f.core.updatePathArray(b,c));return g},f.core.splice=function(a,b){var c,d=a.length,e=f.getObjectTarget(a),g=f.getObjectProxy(a);if(c=Array.prototype.splice.apply(e,b),e===g||a===g){var h,i,j,k=b.length,l=e.length,m=Number(b[0]),n=Number(b[1])>0?b[1]:0,o=b.length>2?b.length-2:0;for(isNaN(m)?m=0:m<0?m=l+m<0?0:l+m:m>d&&(m=d),h=1===k?0:k>2&&n===o?m+n:e.length;m<h;++m)i=e[m],f.isObjectRegistrable(i)&&(j=f.getObjectDop(i),void 0!==j&&j._===e?j[j.length-1]=m:e[m]=f.core.configureObject(i,f.getObjectDop(e).concat(m),e));if(d!==l||o>0){b[0]<0&&(b[0]=a.length+b[0]);var p={object:g,splice:b};c.length>0&&(p.spliced=c),f.core.storeMutation(p)}}return c},f.core.swap=function(a,b){if(b.length>1){for(var c,d,e,g=f.getObjectTarget(a),h=f.getObjectProxy(a),i=0,j=b.length-1;i<j;i+=2)d=b[i],e=b[i+1],c=g[d],g[d]=g[e],g[e]=c,f.core.updatePathArray(g,d),f.core.updatePathArray(g,e);return g!==h&&a!==h||f.core.storeMutation({object:h,swaps:b}),a}},f.core.unshift=function(a,b){if(0===b.length)return a.length;b.unshift(0,0);f.core.splice(a,b);return a.length};var g="function"==typeof Proxy;f.core.configureObject=function(a,b,c){if(f.isRegistered(a))return f.core.configureObject(f.util.merge(e(a)?[]:{},a),b,c);delete a[f.cons.DOP];var h,i,j;for(h in a)i=a[h],f.isObjectRegistrable(i)&&(a[h]=f.core.configureObject(i,b.concat(h),a));if(Object.defineProperty(a,f.cons.DOP,{value:b.slice(0)}),j=f.getObjectDop(a),j.m=[],j.o=[],j.op={},d(c)&&(j._=f.isRegistered(c)?f.getObjectTarget(c):c),g){var k=a;a=new Proxy(a,f.core.proxyObjectHandler),j.p=a,j.t=k}else j.p=j.t=a;return"array"==f.util.typeof(a)&&Object.defineProperties(a,f.core.proxyArrayHandler),a},f.core.createCollector=function(a,b,c){var d=new f.core.collector(a,b);return d.filter=c,d},f.core.emitObservers=function(a){for(var b,c,d,e,g,h,i,j=[],k=0,l=a.length,m=!1;k<l;++k){if(b=a[k],c=b.object,g=f.getObjectDop(c),m||(m=!0),h=g.op[b.name],"array"==f.util.typeof(h)&&h.length>0)for(d=0,e=h.length;d<e;++d)h[d](b);if(j.indexOf(c)===-1){for(j.push(c),i=g.o,d=0,e=i.length;d<e;++d)i[d](g.m.slice(0));g.m=[]}}return m},f.core.injectMutationInAction=function(a,b,c){var g,h=void 0!==b.splice||void 0!==b.swaps,i=f.getObjectDop(b.object).slice(0),j=b.name,k=c?b.oldValue:b.value,l=f.util.typeof(k),m=1;for(h||i.push(j);m<i.length-1;++m)g=a,j=i[m],a=d(a[j])?a[j]:a[j]={};if(j=i[m],h||e(b.object)){i.length>1&&(h&&!d(a[j])&&(a[j]={}),h&&(a=a[j])),d(a[f.cons.DOP])||(a[f.cons.DOP]=[]);var n=a[f.cons.DOP];if(void 0!==b.swaps){var o=b.swaps.slice(0);c&&o.reverse();var p=o[0]>0?0:1;o[p]=o[p]*-1,n.push(o)}else if(void 0!==b.splice){var q;c?(q=b.spliced?b.spliced.slice(0):[],q.unshift(b.splice[0],b.splice.length-2)):q=b.splice.slice(0),n.push(q)}else n.push([j,1,k]);c&&void 0!==b.length&&b.length!==b.object.length&&(a.length=b.length)}else a[j]="object"==l||"array"==l?f.util.merge("array"==l?[]:{},k):k},f.core.objectIsStillStoredOnPath=function(a){for(var b,c=f.getObjectDop(a),d=c.length-1;d>0;--d)if(d>1){if(b=f.getObjectParent(a),b[c[d]]!==a)return!1;a=f.getObjectProxy(b)}return!0},f.core.proxyArrayHandler={splice:{value:function(){return f.core.splice(this,Array.prototype.slice.call(arguments,0))}},shift:{value:function(){return f.core.shift(this,Array.prototype.slice.call(arguments,0))}},pop:{value:function(){return f.core.pop(this,Array.prototype.slice.call(arguments,0))}},push:{value:function(){return f.core.push(this,Array.prototype.slice.call(arguments,0))}},unshift:{value:function(){return f.core.unshift(this,Array.prototype.slice.call(arguments,0))}},reverse:{value:function(){return f.core.reverse(this)}},sort:{value:function(a){return f.core.sort(this,a)}}},f.core.proxyObjectHandler={set:function(a,b,c){return void 0!==f.core.set(f.getObjectProxy(a),b,c)},deleteProperty:function(a,b){return void 0!==f.core.delete(f.getObjectProxy(a),b)}},f.core.setAction=function(a,b){return f.util.path({a:b},null,{a:a},f.core.setActionMutator),a},f.core.setActionMutator=function(a,b,c,d,e){var g=f.util.typeof(a[b]);if("object"==d&&c.hasOwnProperty(f.cons.DOP)){var h,i=c[f.cons.DOP],j=0,k=i.length;for("array"!=g&&f.set(a,b,[]);j<k;++j)h=i[j],h[0]<0||h[1]<0?(h=h.slice(0),h[0]<0?h[0]=h[0]*-1:h[1]=h[1]*-1,f.core.swap(a[b],h)):(a[b].length<h[0]&&(f.getObjectTarget(a[b]).length=h[0]),3===h.length&&1===h[1]?void 0===h[2]?f.del(a[b],h[0]):f.set(a[b],h[0],h[2]):f.core.splice(a[b],h));return"number"==typeof c.length&&c.length>-1&&(a[b].length=c.length),!0}if("object"!=d||a.hasOwnProperty(b))if("undefined"==d)f.del(a,b);else{if("array"==d)return f.set(a,b,f.util.merge([],c)),!0;if("object"==d&&"object"!=g&&"array"!=g)return f.set(a,b,f.util.merge({},c)),!0;"object"!=d&&f.set(a,b,c)}else f.set(a,b,{})},f.core.storeMutation=function(a){var b,c=f.data.collectors,d=0,e=c.length,g=0;for(f.getObjectDop(a.object).m.push(a);d<e;d++)if(c[d].length>0)for(g=0,b=c[d].length;g<b;g++)if(c[d][g].add(a))return;return f.emit([a])},f.core.updatePathArray=function(a,b){var c=a[b];if(f.isRegistered(c)){var e=f.getObjectDop(c),g=e.length-1;e[g]!==b&&(e[g]=b,f.util.path(c,function(a,c,e){d(e)&&(f.getObjectDop(e)[g]=b)}))}return!1},f.core.connector=function(a){var b=new f.core.node;return a.unshift(f,b),b.options=a[2],b.transport=b.options.transport,b.options.transport.apply(this,a),b},f.core.createAsync=function(){var a,b,c=new Promise(function(c,d){a=c,b=d});return c.resolve=a,c.reject=b,c},f.core.createRequest=function(a,b){var c=a.request_inc++,d=Array.prototype.slice.call(arguments,1);return d.unshift(c),d.promise=f.core.createAsync(),d},f.core.createResponse=function(){return arguments[0]=arguments[0]*-1,Array.prototype.slice.call(arguments,0)};var h=/^\d\d\d\d-\d\d-\d\dT\d\d:\d\d:\d\d.\d\d\dZ$/,i=/\/(.+)\/([gimuy]{0,5})/;f.core.decode=function(a,b,c){if("string"==typeof b){if("~F"===b)return f.core.remoteFunction(this,a);if("~U"==b&&d(c))return void c.push([this,a]);if("~I"===b)return 1/0;if("~i"===b)return-(1/0);if("~N"===b)return NaN;if(h.exec(b))return new Date(b);if("~R"==b.substr(0,2)){var e=i.exec(b.substr(2));return new RegExp(e[1],e[2])}if("~"===b[0])return b.substring(1)}return b},f.core.emitNodes=function(a){},f.core.encodeProtocol=function(a,b){var c=typeof b;return"function"==c?"~F":"undefined"==c?"~U":b},f.core.encodeSpecial=function(a,b){return"string"==typeof b&&"~"==b[0]?"~"+b:b},f.core.encodeUtil=function(a,b){var c=typeof b;return b===1/0?"~I":b===-(1/0)?"~i":"number"==c&&isNaN(b)?"~N":"object"==c&&b instanceof RegExp?"~R"+b.toString():b},f.core.getRejectError=function(a){if("number"==typeof a&&void 0!==f.core.error.reject[a]){var b=Array.prototype.slice.call(arguments,1);return b.unshift(f.core.error.reject[a]),f.util.sprintf.apply(this,b)}return a},f.core.localProcedureCall=function(a,b,d,e,g){var h,i=f.core.createAsync();c(g)&&(i=g(i)),b.push(i),i.then(d).catch(e),h=a.apply(i,b),h!==i&&i.resolve(h)},f.core.multiEncode=function(){var a,b=arguments,c=b.length;return function d(e,f,g){return g>=c?f:(void 0===g&&(a=f,g=0),a=b[g](e,f),a!==f?a:d(e,f,g+1))}},f.core.registerNode=function(a){f.data.node[a.token]=a},f.core.registerObjectToNode=function(a,b){var c,d=f.getObjectId(b);return void 0===f.data.object[d]&&(f.data.object[d]={object:b,nodes_total:0,node:{}}),c=f.data.object[d],void 0===c.node[a.token]&&(c.nodes_total+=1,c.node[a.token]={subscribed:!1,owner:!1}),c},f.core.registerOwner=function(a,b,c){var d=f.core.registerObjectToNode(a,b),e=f.getObjectId(d.object);d.node[a.token].owner=!0,a.object_owner[c]=e},f.core.registerSubscriber=function(a,b){var c=f.core.registerObjectToNode(a,b),d=f.getObjectId(c.object);return a.object_subscribed[d]=!0,!c.node[a.token].subscribed&&(c.node[a.token].subscribed=!0,!0)},f.core.remoteFunction=function(a,b){return function(){console.log(f.getObjectDop(a),b,Array.prototype.slice.call(arguments,0))}},f.core.sendRequests=function(a,b){var c=a.requests_queue,d=c.length;if(d>0){"function"!=typeof b&&(b=f.encode);for(var e=0,g=b(d>1?c:c[0]);e<d;++e)a.requests[c[e][0]]=c[e];a.requests_queue=[],a.send(g)}},f.core.sendResponse=function(a,b,c){"function"!=typeof c&&(c=f.encode),a.send(c(b))},f.core.setSocketToNode=function(a,b){a.socket=b,b[f.cons.TOKEN]=a.token},f.core.storeRequest=function(a,b){a.requests_queue.push(b)},f.core.unregisterNode=function(a){var b,c,d;for(b in a.object_subscribed)d=f.data.object[b],void 0!==d.node[a.token]&&(d.nodes_total-=1,delete d.node[a.token]);for(c in a.object_owner)b=a.object_owner[c],d=f.data.object[b],void 0!==d.node[a.token]&&(d.nodes_total-=1,delete d.node[a.token]);void 0!==d&&0===d.nodes_total&&delete f.data.object[b],delete f.data.node[a.token]},f.protocol._onconnect=function(a,b,c,d){c[2];0===d[0]&&a.emit(f.cons.CONNECT,c,d)},f.protocol._onsubscribe=function(a,b,c,g){if(void 0!==g[0])if(0!==g[0])c.promise.reject(f.core.getRejectError(g[0],c[2]));else{var h,i="number"==typeof g[1]?[g[1]]:g[1],j=i[0],k=g[2];if(e(i)&&"number"==typeof j){if(void 0===a.object_owner[j]){var l=f.collectFirst();h=f.register(f.isObjectRegistrable(c.into)?f.core.setAction(c.into,k):k),f.core.registerOwner(a,h,j),l.emitAndDestroy()}else h=f.data.object[a.object_owner[j]].object;h=f.util.get(h,i.slice(1)),d(h)?c.promise.resolve(h):c.promise.reject(f.core.error.reject.OBJECT_NOT_FOUND)}else c.promise.reject(f.core.error.reject.OBJECT_NOT_FOUND)}},f.protocol.instructions={connect:0,subscribe:1,unsubscribe:2,call:3,mutation:4};for(var j in f.protocol.instructions)f.protocol.instructions[f.protocol.instructions[j]]=j;return f.protocol.merge=function(a,b,c){console.log(a.token,b,c)},f.protocol.onconnect=function(a,b,c){var d=c[1],e=f.core.createResponse(b,0);a.tokenServer=d,f.core.sendResponse(a,e,JSON.stringify),a.emit(f.cons.CONNECT),f.core.sendRequests(a)},f.protocol.onsubscribe=function(a,b,e){if(c(f.data.onsubscribe)){var g=Array.prototype.slice.call(e,1);f.core.localProcedureCall(f.data.onsubscribe,g,function(c){if(d(c)){var e=f.register(c),g=(f.getObjectId(e),f.getObjectRoot(e)),h=f.getObjectDop(e),i=f.core.createResponse(b,0,1==h.length?h[0]:h);return f.core.registerSubscriber(a,g)&&i.push(g),f.core.sendResponse(a,i),e}f.util.invariant(!1,"dop.onsubscribe callback must return or resolve a regular object")},function(c){response=f.core.createResponse(b),c instanceof Error?console.log(c.stack):response.push(c),a.send(JSON.stringify(response))},function(b){return b.node=a,b})}},f.protocol.subscribe=function(a,b){b=Array.prototype.slice.call(b,0),b.unshift(a,f.protocol.instructions.subscribe);var c=f.core.createRequest.apply(a,b);return c.promise.into=function(a){return f.isObjectRegistrable(a)&&(c.into=a),c.promise},f.core.storeRequest(a,c),a.connected&&f.core.sendRequests(a),c.promise},void 0===b?f:void("function"==typeof define&&define.amd?define([],function(){return f}):"object"==typeof module&&module.exports?module.exports=f:window&&"object"==typeof window?window.dop=f:b.dop=f)}(this);