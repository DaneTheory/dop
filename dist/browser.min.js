!function a(b){var c={version:"0.3.1",name:"dop",create:a,data:{node_inc:0,node:{},object_inc:1,object:{},object_data:{},collectors:[[],[]],lastGet:{}},util:{},core:{},protocol:{},transport:{listen:{},connect:{}}},d={socket_token:"~TOKEN_DOP",dop:"~dop"};c.connect=function(a){var b=Array.prototype.slice.call(arguments,0);return"object"!=c.util.typeof(b[0])&&(a=b[0]={}),"function"!=typeof a.transport&&(a.transport=e),c.core.connector(b)},c.util.emitter=function(){this._events={}},c.util.emitter.prototype.on=function(a,b,d){return"function"==typeof b&&(c.util.isObject(this._events)||(this._events={}),c.util.isObject(this._events[a])||(this._events[a]=[]),this._events[a].push(d===!0?[b,!0]:[b])),this},c.util.emitter.prototype.once=function(a,b){return this.on(a,b,!0)},c.util.emitter.prototype.emit=function(a){if(c.util.isObject(this._events[a])&&this._events[a].length>0){for(var b=0,d=[],e=Array.prototype.slice.call(arguments,1);b<this._events[a].length;b++)d.push(this._events[a][b][0]),this._events[a][b][1]===!0&&(this._events[a].splice(b,1),b-=1);for(b=0;b<d.length;b++)d[b].apply(this,e)}return this},c.util.emitter.prototype.removeListener=function(a,b){if(c.util.isObject(this._events[a])&&this._events[a].length>0)for(var d=0;d<this._events[a].length;d++)this._events[a][d][0]===b&&(this._events[a].splice(d,1),d-=1);return this};var e=function(a,b,c){var d="ws://localhost:4444/";if("string"==typeof c.url)d=c.url.replace("http","ws");else if("undefined"!=typeof window&&/http/.test(window.location.href)){var e=/(ss|ps)?:\/\/([^\/]+)\/?(.+)?/.exec(window.location.href),f=e[1]?"wss":"ws";d=f+"://"+e[2].toLocaleLowerCase()+"/"}var g=new c.transport.api(d),h=g.send,i=[];return g.send=function(a){1!==g.readyState?i.push(a):h.call(g,a)},g.addEventListener("open",function(){for(a.core.onopen(b,g);i.length>0;)h.call(g,i.shift())}),g.addEventListener("message",function(c){a.core.onmessage(b,g,c.data,c)}),g.addEventListener("close",function(){a.core.onclose(b,g)}),g};"undefined"==typeof c&&"object"==typeof module&&module.exports?module.exports=e:e.api=window.WebSocket,c.util.get=function(a,b){if(0===b.length)return a;for(var d=0,e=b.length;d<e;d++){if(!(d+1<e&&c.util.isObject(a[b[d]])))return a.hasOwnProperty(b[d])?a[b[d]]:void 0;a=a[b[d]]}return a[b[d]]},c.util.invariant=function(a){if(!a){var b=c.util.sprintf.apply(this,Array.prototype.slice.call(arguments,1));throw new Error("[dop] Invariant failed: "+b)}},c.util.isObject=function(a){return null!==a&&"object"==typeof a},c.util.isObjectRegistrable=function(a){var b=c.util.typeof(a);return"object"===b||"array"==b},c.util.merge=function(a,b){var d=arguments;return d.length>2?(Array.prototype.splice.call(d,0,2,c.util.merge.call(this,a,b)),c.util.merge.apply(this,d)):c.util.path(b,this,a,c.util.mergeMutator)},c.util.mergeMutator=function(a,b,c,d){"object"==d||"array"==d?a.hasOwnProperty(b)?a[b]:a[b]="array"==d?[]:{}:a[b]=c},c.util.path=function(a,b,d,e){var f="function"==typeof b,g=c.util.isObject(d);return c.util.pathRecursive(a,b,d,e,[],[],f,g),d},c.util.pathRecursive=function(a,b,d,e,f,g,h,i){var j,k,l,m;for(j in a)m=!1,k=a[j],g.push(j),h&&(m=b(a,j,k,d,g,this)),m!==!0&&(l=c.util.typeof(k),i&&(m=e(d,j,k,l,g)),"object"!=l&&"array"!=l||m===!0||k===a||f.indexOf(k)!=-1||(f.push(k),c.util.pathRecursive(k,b,i?d[j]:void 0,e,f,g,h,i)),g.pop())},c.util.sprintf=function(){var a,b=-1,c=arguments[0],d=Array.prototype.slice.call(arguments,1);return c.replace(/"/g,"'").replace(/%([0-9]+)|%s/g,function(){return a=d[void 0===arguments[1]||""===arguments[1]?++b:arguments[1]],void 0===a&&(a=arguments[0]),a})},c.util.typeof=function(a){var b=typeof a;return"object"==b&&(a?Array.isArray(a)?b="array":a instanceof Date?b="date":a instanceof RegExp&&(b="regexp"):b="null"),b},c.util.uuid=function(){for(var a,b=0,c="";b<32;b++)a=16*Math.random()|0,8!==b&&12!==b&&16!==b&&20!==b||(c+="-"),c+=(12===b?4:16===b?3&a|8:a).toString(16);return c},c.collect=function(a){return c.util.invariant(0===arguments.length||arguments.length>0&&"function"==typeof a,"dop.collect only accept one argument as function"),c.core.createCollector(c.data.collectors[0],c.data.collectors[0].length,a)},c.collectFirst=function(a){return c.util.invariant(0===arguments.length||arguments.length>0&&"function"==typeof a,"dop.collectFirst only accept one argument as function"),c.core.createCollector(c.data.collectors[0],0,a)},c.decode=function(a){var b,d=[],e=0,f=JSON.parse(a,function(a,b){return c.core.decode.call(this,a,b,d)});for(b=d.length;e<b;++e)d[e][0][d[e][1]]=void 0;return f},c.del=function(a,b){return c.isRegistered(a)?void 0!==c.core.delete(a,b):delete a[b]},c.emit=function(a,b){a.length>0&&c.core.emitObservers(a)&&(void 0===b&&(b=c.getAction(a)),c.core.emitNodes(b))},c.encode=function(a){return JSON.stringify(a,c.core.encode)},c.getAction=function(a){for(var b={},d=0,e=a.length;d<e;++d)c.core.objectIsStillStoredOnPath(a[d].object)&&c.util.injectMutationInAction(b,a[d]);return b},c.core.objectIsStillStoredOnPath=function(a){for(var b,d=c.getObjectDop(a),e=d.length-1;e>0;--e){if(b=e>1?c.getObjectDop(a)._:c.data.object[d[0]],b[d[e]]!==a)return!1;a=c.getObjectProxy(b)}return!0},c.getNodeBySocket=function(a){return c.data.node[a[d.socket_token]]},c.getObjectDop=function(a){return a[d.dop]},c.getObjectId=function(a){return c.getObjectDop(a)[0]},c.getObjectProperty=function(a){var b=c.getObjectDop(a);return b[b.length-1]},c.getObjectProxy=function(a){return c.getObjectDop(a).p},c.getObjectRoot=function(a){return c.data.object[c.getObjectId(a)]},c.getObjectRootById=function(a){return c.data.object[a]},c.getObjectTarget=function(a){return c.getObjectDop(a).t},c.isRegistered=function(a){return c.util.isObject(a)&&void 0!==c.getObjectDop(a)},c.getUnaction=function(a){for(var b={},d=a.length-1;d>-1;--d)c.util.injectMutationInAction(b,a[d],!0);return b},c.observe=function(a,b){if(c.util.invariant(c.isRegistered(a),"dop.observe needs a registered object as first parameter"),c.util.invariant("function"==typeof b,"dop.observe needs a callback as second parameter"),c.getObjectDop(a).o.indexOf(b)==-1)return c.getObjectDop(a).o.push(b),function(){return c.unobserve(a,b)}},c.observeProperty=function(a,b,d){c.util.invariant(c.isRegistered(a),"dop.observeProperty needs a registered object as first parameter"),c.util.invariant("function"==typeof d,"dop.observeProperty needs a callback as third parameter"),"object"!=c.util.typeof(c.getObjectDop(a).op)&&(c.getObjectDop(a).op={});var e="array"!=c.util.typeof(c.getObjectDop(a).op[b])?c.getObjectDop(a).op[b]=[]:c.getObjectDop(a).op[b];if(e.indexOf(d)==-1)return e.push(d),function(){return c.unobserveProperty(a,b,d)}},c.onsubscribe=function(a){c.util.invariant("function"==typeof a,"dop.onsubscribe only accept a function as parameter"),c.data.onsubscribe=a},c.register=function(a,b){if(c.util.invariant(c.util.isObjectRegistrable(a),"dop.register needs a regular object as first parameter"),c.isRegistered(a))return c.getObjectProxy(a);var d=c.data.object_inc++;return a=c.core.configureObject(a,[d]),c.data.object[d]=a,c.data.object_data[d]={node:{},nodes:0,options:b},a},c.set=function(a,b,d){return c.isRegistered(a)?c.core.set(a,b,d):a[b]=d,d},c.setAction=function(a){var b=c.collectFirst();return c.util.path(a,null,c.data.object,c.core.setAction),b},c.core.setAction=function(a,b,e,f,g){var h=c.util.typeof(a[b]);if("object"==f&&e.hasOwnProperty(d.dop)){var i,j=e[d.dop],k=0,l=j.length;for("array"!=h&&c.set(a,b,[]);k<l;++k)i=j[k],i[0]<0||i[1]<0?(i=i.slice(0),i[0]<0?i[0]=i[0]*-1:i[1]=i[1]*-1,c.core.swap(a[b],i)):(a[b].length<i[0]&&(c.getObjectTarget(a[b]).length=i[0]),3===i.length&&1===i[1]?void 0===i[2]?c.del(a[b],i[0]):c.set(a[b],i[0],i[2]):c.core.splice(a[b],i));return"number"==typeof e.length&&e.length>-1&&(a[b].length=e.length),!0}if("object"!=f||a.hasOwnProperty(b))if("undefined"==f)c.del(a,b);else{if("array"==f)return c.set(a,b,c.util.merge([],e)),!0;if("object"==f&&"object"!=h&&"array"!=h)return c.set(a,b,c.util.merge({},e)),!0;"object"!=f&&c.set(a,b,e)}else c.set(a,b,{})},c.unobserve=function(a,b){c.util.invariant(c.isRegistered(a),"dop.unobserve needs a registered object as first parameter"),c.util.invariant("function"==typeof b,"dop.unobserve needs a callback as second parameter");var d,e=c.getObjectDop(a).o;return"array"==c.util.typeof(e)&&(d=e.indexOf(b),d!=-1&&(e.splice(d,1),0==e.length&&delete c.getObjectDop(a).o,!0))},c.unobserveProperty=function(a,b,d){c.util.invariant(c.isRegistered(a),"dop.unobserveProperty needs a registered object as first parameter"),c.util.invariant("function"==typeof d,"dop.unobserveProperty needs a callback as second parameter");var e,f=c.getObjectDop(a).op;return"object"==c.util.typeof(f)&&"array"==c.util.typeof(f[b])&&(f=f[b],e=f.indexOf(d),e!=-1&&(f.splice(e,1),0==f.length&&delete c.getObjectDop(a).op[b],!0))},c.core.collector=function(a,b){this.active=!0,this.shallWeGenerateAction=!0,this.shallWeGenerateUnaction=!0,this.mutations=[],this.queue=a,a.splice(b,0,this)},c.core.collector.prototype.add=function(a){return!(!this.active||void 0!==this.filter&&this.filter(a)!==!0)&&(this.shallWeGenerateAction=!0,this.shallWeGenerateUnaction=!0,this.mutations.push(a),!0)},c.core.collector.prototype.emit=function(){var a=this.mutations;return c.emit(a,this.action),this.mutations=[],a},c.core.collector.prototype.destroy=function(){this.active=!1,this.queue.splice(this.queue.indexOf(this),1)},c.core.collector.prototype.emitAndDestroy=function(){return this.destroy(),this.emit()},c.core.collector.prototype.getAction=function(){return this.shallWeGenerateAction&&(this.shallWeGenerateAction=!1,this.action=c.getAction(this.mutations)),this.action},c.core.collector.prototype.getUnaction=function(){return this.shallWeGenerateUnaction&&(this.shallWeGenerateUnaction=!1,this.unaction=c.getUnaction(this.mutations)),this.unaction},c.core.listener=function(a){c.util.emitter.call(this),a.unshift(c,this),this.options=a[2],this.transport=this.options.transport.apply(this,a)},Object.assign(c.core.listener.prototype,c.util.emitter.prototype),c.core.node=function(){c.util.emitter.call(this),this.object_owned={},this.object_subscribed={},this.request_inc=1,this.requests={},this.requests_queue=[]},Object.assign(c.core.node.prototype,c.util.emitter.prototype),c.core.node.prototype.send=function(a){return this.socket.send(a)},c.core.node.prototype.subscribe=function(){return c.protocol.subscribe(node,arguments)},c.core.node.prototype.close=function(){return this.socket.close()},c.protocol.subscribe=function(a,b){b=Array.prototype.slice.call(b,0),b.unshift(a,c.protocol.instructions.subscribe);var d=c.core.createRequest.apply(a,b);return c.core.storeRequest(a,d),c.core.emitRequests(a),d.promise},c.core.error={warning:{TOKEN_REJECTED:"User disconnected because is rejecting too many times the token assigned"},reject:{}},c.core.delete=function(a,b){var d=Object.getOwnPropertyDescriptor(a,b);if(d&&d.configurable){var e=c.getObjectTarget(a),f=c.getObjectProxy(a);if(e===f||a===f){var g={object:c.getObjectProxy(e),name:b,oldValue:e[b]};c.core.storeMutation(g)}return delete e[b]}},c.core.pop=function(a){if(0!==a.length){var b=c.core.splice(a,[a.length-1,1]);return b[0]}},c.core.push=function(a,b){if(0===b.length)return a.length;b.unshift(a.length,0);c.core.splice(a,b);return a.length},c.core.reverse=function(a){for(var b,d=c.getObjectTarget(a),e=c.getObjectProxy(a),f=d.length/2,g=0,h=[],i=d===e||a===e;g<f;++g)b=d.length-g-1,g!==b&&(tempItem=d[b],d[b]=d[g],d[g]=tempItem,i&&h.push(g,b),c.core.updatePathArray(d,g),c.core.updatePathArray(d,b));return i&&h.length>0&&c.core.storeMutation({object:e,swaps:h}),a},c.core.set=function(a,b,d){if(a[b]!==d){var e=Object.getOwnPropertyDescriptor(a,b);if(!e||e&&e.writable){var f=c.getObjectTarget(a),g=c.getObjectProxy(a),h=f[b],i=f.length,j=f.hasOwnProperty(b);if(f[b]=d,c.util.isObjectRegistrable(d)&&(f[b]=c.core.configureObject(d,c.getObjectDop(f).concat(b),f)),f===g||a===g){var k={object:g,name:b,value:d};return j&&(k.oldValue=h),Array.isArray(f)&&(k.length=i),Array.isArray(d)&&(k.valueOriginal=c.util.merge([],d)),c.core.storeMutation(k),k}}}},c.core.shift=function(a){if(0!==a.length){var b=c.core.splice(a,[0,1]);return b[0]}},c.core.sort=function(a,b){var d,e,f=c.getObjectTarget(a),g=c.getObjectProxy(a),h=f.slice(0);return d=Array.prototype.sort.call(f,b),e=c.core.sortDiff(f,h),e.length>1&&(f===g||a===g)&&c.core.storeMutation({object:g,swaps:e}),d},c.core.sortDiff=function(a,b){for(var d,e,f=b.length,g=[],h=0;h<f;++h)a[h]!==b[h]&&(d=b.indexOf(a[h]),e=b[h],b[h]=b[d],b[d]=e,g.push(h,d),c.core.updatePathArray(b,h),c.core.updatePathArray(b,d));return g},c.core.splice=function(a,b){var d,e=a.length,f=c.getObjectTarget(a),g=c.getObjectProxy(a);if(d=Array.prototype.splice.apply(f,b),f===g||a===g){var h,i,j,k=b.length,l=f.length,m=Number(b[0]),n=Number(b[1])>0?b[1]:0,o=b.length>2?b.length-2:0;for(isNaN(m)?m=0:m<0?m=l+m<0?0:l+m:m>e&&(m=e),h=1===k?0:k>2&&n===o?m+n:f.length;m<h;++m)i=f[m],c.util.isObjectRegistrable(i)&&(j=c.getObjectDop(i),void 0!==j&&j._===f?j[j.length-1]=m:f[m]=c.core.configureObject(i,c.getObjectDop(f).concat(m),f));if(e!==l||o>0){b[0]<0&&(b[0]=a.length+b[0]);var p={object:g,splice:b};d.length>0&&(p.spliced=d),c.core.storeMutation(p)}}return d},c.core.swap=function(a,b){if(b.length>1){for(var d,e,f,g=c.getObjectTarget(a),h=c.getObjectProxy(a),i=0,j=b.length-1;i<j;i+=2)e=b[i],f=b[i+1],d=g[e],g[e]=g[f],g[f]=d,c.core.updatePathArray(g,e),c.core.updatePathArray(g,f);return g!==h&&a!==h||c.core.storeMutation({object:h,swaps:b}),a}},c.core.unshift=function(a,b){if(0===b.length)return a.length;b.unshift(0,0);c.core.splice(a,b);return a.length};var f="function"==typeof Proxy;c.core.configureObject=function(a,b,e){if(c.isRegistered(a))return c.core.configureObject(c.util.merge(Array.isArray(a)?[]:{},a),b,e);var g,h,i;for(g in a)h=a[g],c.util.isObjectRegistrable(h)&&(a[g]=c.core.configureObject(h,b.concat(g),a));if(Object.defineProperty(a,d.dop,{value:b.slice(0)}),i=c.getObjectDop(a),i.m=[],i.o=[],i.op={},c.util.isObject(e)&&(i._=c.isRegistered(e)?c.getObjectTarget(e):e),f){var j=a;a=new Proxy(a,c.core.proxyObjectHandler),i.p=a,i.t=j}else i.p=i.t=a;return"array"==c.util.typeof(a)&&Object.defineProperties(a,c.core.proxyArrayHandler),a},c.core.createAsync=function(a,b){var c,d,e=new Promise(function(a,b){c=a,d=b});return e.resolve=c,e.reject=d,e},c.core.createCollector=function(a,b,d){var e=new c.core.collector(a,b);return e.filter=d,e},c.core.emitObservers=function(a){for(var b,d,e,f,g,h,i,j=[],k=0,l=a.length,m=!1;k<l;++k){if(b=a[k],d=b.object,g=c.getObjectDop(d),!m&&c.data.object_data[g[0]].nodes>0&&(m=!0),h=g.op[b.name],"array"==c.util.typeof(h)&&h.length>0)for(e=0,f=h.length;e<f;++e)h[e](b);if(j.indexOf(d)===-1){for(j.push(d),i=g.o,e=0,f=i.length;e<f;++e)i[e](g.m.slice(0));g.m=[]}}return m},c.util.injectMutationInAction=function(a,b,e){var f,g=void 0!==b.splice||void 0!==b.swaps,h=c.getObjectDop(b.object).slice(0),i=c.data.object,j=b.name,k=e?b.oldValue:b.value,l=c.util.typeof(k),m=0,n=Array.isArray;for(g||h.push(j);m<h.length-1;++m)f=a,j=h[m],void 0!==i&&(i=i[j]),a=c.util.isObject(a[j])?a[j]:a[j]={};if(j=h[m],g||n(i)){g&&!c.util.isObject(a[j])&&(a[j]={}),g&&(a=a[j]),c.util.isObject(a[d.dop])||(a[d.dop]=[]);var o=a[d.dop];if(void 0!==b.swaps){var p=b.swaps.slice(0);e&&p.reverse();var q=p[0]>0?0:1;p[q]=p[q]*-1,o.push(p)}else if(void 0!==b.splice){var r;e?(r=b.spliced?b.spliced.slice(0):[],r.unshift(b.splice[0],b.splice.length-2)):r=b.splice.slice(0),o.push(r)}else o.push([j,1,k]);e&&void 0!==b.length&&b.length!==i.length&&(a.length=b.length)}else a[j]="object"==l||"array"==l?c.util.merge("array"==l?[]:{},k):k},c.core.localProcedureCall=function(a,b,d,e,f){var g,h=c.core.createAsync();"function"==typeof f&&(h=f(h)),b.push(h),h.then(d).catch(e),g=a.apply(h,b),g!==h&&h.resolve(g)},c.core.proxyArrayHandler={splice:{value:function(){return c.core.splice(this,Array.prototype.slice.call(arguments,0))}},shift:{value:function(){return c.core.shift(this,Array.prototype.slice.call(arguments,0))}},pop:{value:function(){return c.core.pop(this,Array.prototype.slice.call(arguments,0))}},push:{value:function(){return c.core.push(this,Array.prototype.slice.call(arguments,0))}},unshift:{value:function(){return c.core.unshift(this,Array.prototype.slice.call(arguments,0))}},reverse:{value:function(){return c.core.reverse(this)}},sort:{value:function(a){return c.core.sort(this,a)}}},c.core.proxyObjectHandler={set:function(a,b,d){return void 0!==c.core.set(c.getObjectProxy(a),b,d)},deleteProperty:function(a,b){return void 0!==c.core.delete(c.getObjectProxy(a),b)}},c.core.storeMutation=function(a){var b,d=c.data.collectors,e=0,f=d.length,g=0;for(c.getObjectDop(a.object).m.push(a);e<f;e++)if(d[e].length>0)for(g=0,b=d[e].length;g<b;g++)if(d[e][g].add(a))return;return c.emit([a])},c.core.updatePathArray=function(a,b){var d=a[b];if(c.isRegistered(d)){var e=c.getObjectDop(d),f=e.length-1;e[f]!==b&&(e[f]=b,c.util.path(d,function(a,d,e){c.util.isObject(e)&&(c.getObjectDop(e)[f]=b)}))}return!1},c.core.connector=function(a){var b=new c.core.node;return a.unshift(c,b),b.options=a[2],b.transport=b.options.transport,b.socket=b.options.transport.apply(this,a),b},c.core.createRequest=function(a,b){var d=a.request_inc++,e=Array.prototype.slice.call(arguments,1);return e.unshift(d),e.promise=c.core.createAsync(),e},c.core.createResponse=function(){return arguments[0]=arguments[0]*-1,Array.prototype.slice.call(arguments,0)};var g=/^\d\d\d\d-\d\d-\d\dT\d\d:\d\d:\d\d.\d\d\dZ$/,h=/\/(.+)\/([gimuy]{0,5})/;c.core.decode=function(a,b,d){if("string"==typeof b){if("~F"===b)return c.core.remoteFunction(this,a);if("~U"==b&&c.util.isObject(d))return void d.push([this,a]);if("~I"===b)return 1/0;if("~i"===b)return-(1/0);if("~N"===b)return NaN;if(g.exec(b))return new Date(b);if("~R"==b.substr(0,2)){var e=h.exec(b.substr(2));return new RegExp(e[1],e[2])}if("~"===b[0])return b.substring(1)}return b},c.core.emitNodes=function(a){var b,d,e;for(b in a)if(c.data.object_data[b].nodes>0)for(d in c.data.object_data[b].node)e=c.data.node[d],c.protocol.merge(e,b,a[b])},c.core.emitRequests=function(a,b){"function"!=typeof b&&(b=c.encode);for(var d=a.requests_queue,e=0,f=d.length;e<f;++e)a.requests[d[e][0]]=d[e];a.requests_queue=[],a.send(b(f>1?d:d[0]))},c.core.encode=function(a,b){var c=typeof b;return"function"==c?"~F":"undefined"==c?"~U":b===1/0?"~I":b===-(1/0)?"~i":"number"==c&&isNaN(b)?"~N":"object"==c&&b instanceof RegExp?"~R"+b.toString():"string"==c&&"~"===b[0]?"~"+b:b},c.core.getRejectError=function(a){if("number"==typeof a&&void 0!==c.core.error.reject[a]){var b=Array.prototype.slice.call(arguments,1);return b.unshift(c.core.error.reject[a]),c.util.sprintf.apply(this,b)}return a},c.core.onclose=function(a,b){var d=a.socket!==b,e=d?c.getNodeBySocket(b):a;a.emit("close",b),c.util.isObject(e)&&(a.emit("disconnect",e),c.core.unregisterNode(e))},c.core.onmessage=function(a,b,e,f){a.emit("message",b,e,f);var g,h=a.socket!==b,i=h?c.data.node[b[d.socket_token]]||{}:a;if("string"==typeof e&&"["==e.substr(0,1))try{g=c.decode(e)}catch(a){}else g=e;if("array"==c.util.typeof(g)){"number"==typeof g[0]&&(g=[g]);for(var j,k,l,m,n,o,p,q=0,r=g.length;q<r;q++)if(j=g[q],m=j[0],"number"==typeof m&&0!==m){p=c.util.typeof(j[1]),k="number"==p&&"array"!=p||m<0?[m,j.slice(1)]:k=j;for(var s,t=1,u=k.length;t<u;++t)l=k[t],"array"==c.util.typeof(l)&&("number"==typeof l[0]&&m>0||m<0)&&(o=l[0],s="on"+c.protocol.instructions[o],m>0&&"function"==typeof c.protocol[s]?c.protocol[s](i,m,l):(m*=-1,c.util.isObject(i.requests[m])&&(n=l,l=i.requests[m],o=l[1],s="_on"+c.protocol.instructions[o],"function"==typeof c.protocol[s]&&c.protocol[s](i,m,l,n),delete i.requests[m])))}}},c.core.onopen=function(a,b,d){if(a.emit("open",b),a.socket!==b){var e=new c.core.node;e.transport=d,e.socket=b,e.try_connects=a.options.try_connects,e.listener=a,c.protocol.connect(e)}},c.core.registerNode=function(a,b){a.token=b,a.socket[d.socket_token]=b,c.data.node[b]=a},c.core.registerObjectToNode=function(a,b){var d=c.getObjectId(b),e=c.data.object_data[d];return void 0===e.node[a.token]&&(e.node[a.token]=!0,e.nodes+=1,a.object_subscribed[d]=!0,!0)},c.core.remoteFunction=function(a,b){return function(){console.log(c.getObjectDop(a),b,Array.prototype.slice.call(arguments,0))}},c.core.storeRequest=function(a,b){a.requests_queue.push(b)},c.core.unregisterNode=function(a){var b,d;for(b in a.object_subscribed)d=c.data.object_data[b],d.nodes-=1,delete d.node[a.token];delete c.data.node[a.token]},c.protocol._onconnect=function(a,b,d,e){var f=d[2];0===e[0]?(a.listener.emit("connect",a,f),a.emit("connect",f)):a.try_connects-- >0?(delete c.data.node[f],c.protocol.connect(a)):(delete c.data.node[f],a.listener.emit("warning",c.core.error.warning.TOKEN_REJECTED),a.socket.close())},c.protocol._onsubscribe=function(a,b,d,e){if(void 0!==e[0])if(0!==e[0])d.promise.reject(c.core.getRejectError(e[0],d[2]));else{var f,g,h=e[1],i=h[0],j=e[2];void 0===a.object_owned[i]?(f=c.register(j),g=c.getObjectId(f),a.object_owned[i]=g):(g=a.object_owned[i],f=c.getObjectRootById(g)),d.promise.resolve(c.util.get(f,h.slice(1)))}},c.protocol.connect=function(a){var b,e;do b=c.util.uuid();while("object"==typeof c.data.node[b]);c.data.node[b]=a,a.token=b,a.socket[d.socket_token]=b,e=c.core.createRequest(a,c.protocol.instructions.connect,b),c.core.storeRequest(a,e),c.core.emitRequests(a,JSON.stringify)},c.protocol.instructions={connect:0,reconnect:1,subscribe:2,unsubscribe:3,call:4,update:5,merge:6};for(var i in c.protocol.instructions)c.protocol.instructions[c.protocol.instructions[i]]=i;return c.protocol.merge=function(a,b,c){console.log(a.token,b,c)},c.protocol.onconnect=function(a,b,d){var e,f=d[1];void 0===c.data.node[f]?(c.core.registerNode(a,f),e=c.core.createResponse(b,0),a.emit("connect",f)):e=c.core.createResponse(b,1),a.send(JSON.stringify(e))},c.protocol.onsubscribe=function(a,b,d){if("function"==typeof c.data.onsubscribe){var e,f,g=Array.prototype.slice.call(d,1);c.core.localProcedureCall(c.data.onsubscribe,g,function(d){if(c.util.isObject(d)){e=c.register(d);var g=c.getObjectId(e);return f=c.core.createResponse(b,0,c.getObjectDop(e)),c.core.registerObjectToNode(a,e)&&f.push(c.getObjectRootById(g)),a.send(c.encode(f)),e}c.util.invariant(!1,"dop.onsubscribe callback must return or resolve a regular object")},function(d){f=c.core.createResponse(b),d instanceof Error?console.log(d.stack):f.push(d),a.send(JSON.stringify(f))},function(b){return b.node=a,b})}},void 0===b?c:void("function"==typeof define&&define.amd?define([],function(){return c}):"object"==typeof module&&module.exports?module.exports=c:b.dop=c)}(this);