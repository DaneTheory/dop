"strict";var dop={version:"0.8.0",name:"dop",side:"api",key_object_path:"~PATH",stringify_function:"~F",stringify_undefined:"~U",stringify_regexp:"~R",name_remote_function:"$DOP_REMOTE_FUNCTION",util:{},on:{},_on:{},objects:{}};"object"==typeof module&&module&&(module.exports=dop),dop.util.arguments=function(a,b){for(var c=a;"function"==typeof c.callee.caller;){if(b(c.callee.caller.arguments))return a[0];c=c.callee.caller.arguments}return a[0]},dop.util.emitter=function(){this._events={}},dop.util.emitter.prototype.on=dop.util.emitter.prototype.addListener=function(a,b,c){return"function"==typeof b&&("object"!=typeof this._events&&(this._events={}),"object"!=typeof this._events[a]&&(this._events[a]=[]),this._events[a].push(c===!0?[b,!0]:[b])),this},dop.util.emitter.prototype.once=dop.util.emitter.prototype.addOnceListener=function(a,b){return this.on(a,b,!0)},dop.util.emitter.prototype.emit=function(a){if("object"==typeof this._events[a]&&this._events[a].length>0){for(var b=0,c=[],d=Array.prototype.slice.call(arguments,1);b<this._events[a].length;b++)c.push(this._events[a][b][0]),this._events[a][b][1]===!0&&(this._events[a].splice(b,1),b-=1);for(b=0;b<c.length;b++)c[b].apply(this,d)}return this},dop.util.emitter.prototype.removeListener=function(a,b){if("object"==typeof this._events[a]&&this._events[a].length>0)for(var c=0;c<this._events[a].length;c++)this._events[a][c][0]===b&&(this._events[a].splice(c,1),c-=1);return this},dop.util.get=function(a,b,c){for(var d,e=0,f=b.length;f>e;e++)if(d=dop.util["typeof"](a[b[e]]),f>e+1&&null!==a[b[e]]&&("object"==d||"array"==d))a=a[b[e]];else{if(a.hasOwnProperty(b[e]))return a[b[e]];if(!c||!c(a,b[e],e))return;a[b[e]]={}}return a[b[e]]},dop.util.merge=function(){return function a(b,c){var d,e,f,g,h=arguments;if(h.length<2)return b;if(h.length>2)return Array.prototype.splice.call(h,0,2,a(b,c)),a.apply(this,h);for(d in c)d in c&&(f=b[d],e=c[d],e!==b&&(null===e||"object"!=typeof e&&!Array.isArray(e)||e instanceof Date||e instanceof RegExp?b[d]=e:"object"==typeof f&&null!==f?(g=f,b[d]=a(g,e)):(g=Array.isArray(e)?[]:{},b[d]=a(g,e))));return b}}(),dop.util.path=function(a,b){dop.util.path.recursive.call({circular:[]},a,b,[])},dop.util.path.recursive=function(a,b,c){for(var d in a){if(c.push(d),0==this.stop)return;this.stop=b(c,a[d],d,a),a[d]&&"object"==typeof a[d]&&a[d]!==a&&-1==this.circular.indexOf(a[d])&&(this.circular.push(a[d]),dop.util.path.recursive.call(this,a[d],b,c)),c.pop()}},dop.util.promise=function(a){function b(a,b){f.length>0?c.call(h,0,a,b):setTimeout(function(){c.call(h,0,a,b)},0)}function c(a,b,e){var g=a+1;if("object"==typeof f[a]&&"function"==typeof f[a][h.type]){try{e=[f[a][h.type].apply(f[a][h.type].hasToGoUp?h:b,e)],h.type&&!d&&(h.type=0)}catch(i){h.type=1,e=[i]}if(e[0]===h)h.type=1,e[0]=new TypeError("Promise resolved by its own instance");else if(e[0]instanceof h.constructor){var j=function(){h.type=this.type,c.call(h,g,b,arguments)};return j.hasToGoUp=!0,void e[0].then(j,j)}}g<f.length&&c(g,b,e)}var d,e,f=[],g=0,h=this;this.state=g,this.then=function(a,b){return"function"==typeof a&&f.push([a]),"function"==typeof b&&f.push([void 0,b]),this},this["catch"]=function(a){return h.then(0,a)},this.completed=function(a){return e=a,h},this.resolve=function(){return 3===g?h:(g=h.state=1,d=h.type=0,void b(this,arguments))},this.reject=function(){return 3===g?h:(g=h.state=2,d=h.type=1,void b(this,arguments))},h.onCompleted=function(){g=h.state=3,"function"==typeof e&&e.apply(this,arguments)},"function"==typeof a&&a(h.resolve,h.reject)},dop.util["typeof"]=function(a){var b=typeof a;return"object"==b&&(a?Array.isArray(a)?b="array":a instanceof Date?b="date":a instanceof RegExp&&(b="regexp"):b="null"),b},dop.create=function(a){return new dop.api(a)},dop.api=function(a){"object"!=dop.util["typeof"](a)&&(a={}),"function"!=typeof a.connector&&(a.connector=dop.ws),"string"!=typeof a.url&&(a.url=window.location.href);var b=/(ps|ss)?:\/\/([^\/]+)?(?:\/([^\/]+))?/.exec(a.url);"string"==typeof b[3]&&(a.prefix=b[3]),"string"!=typeof a.prefix&&(a.prefix=dop.name),a.prefix+=a.connector.name_connector,"undefined"==typeof b[3]?("/"!==a.url[a.url.length-1]&&(a.url+="/"),a.url+=a.prefix):a.url+=a.connector.name_connector,a.host=b[2],a.ssl="string"==typeof b[1]&&("ps"===b[1].toLowerCase()||"ss"===b[1].toLowerCase()),this.options=a,this.options.stringify_function=dop.stringify_function,this.options.stringify_undefined=dop.stringify_undefined,this.options.stringify_regexp=dop.stringify_regexp,this.objects={},this.objects_name={},this.requests_inc=1,this.requests={},this.dop=this,this.observe=dop.observe.bind(this),this.send=function(a){this.connector.send(a)},this.close=function(){this.connector.close()},dop.util.emitter.call(this)},dop.api.prototype=Object.create("function"==typeof EventEmitter?EventEmitter.prototype:dop.util.emitter.prototype),dop.configure=function(a,b,c){var d=this;Object.defineProperty(a,dop.key_object_path,{value:b}),dop.util.path(a,function(a,c,e,f){var g=b.concat(a);c===d.options.stringify_function&&(f[e]=dop.remoteFunction.call(d,g)),null!==c&&"object"==typeof c&&"undefined"==typeof c[dop.key_object_path]&&Object.defineProperty(c,dop.key_object_path,{value:g})})},dop.error={SYNC_MUST_BE_OBJECT:'The property "object" of the method sync() only accept Objects',SYNC_NO_REPEAT_NAME:"You can not sync different objects with the same name",SYNC_NO_REPEAT:"You can not sync the same object more than once",REJECT_CALL_NOT_EXISTS:"You are trying to call a function does not exists",API_PARAMETER_CREATE_URL:"You must pass url as first parameter"},dop.manage=function(a,b){"object"!=typeof b[0]&&(b=[b]);for(var c,d,e,f=0,g=b.length;g>f;f++)c=b[f],d=c[0],e=c[1],"number"==typeof d&&(d>0&&"function"==typeof dop.on[dop.protocol_keys[e]]?dop.on[dop.protocol_keys[e]].call(this,a,c):(d*=-1,null!==this.requests[d]&&"object"==typeof this.requests[d]&&(e=this.requests[d].data[1],0===c[1]?dop._on[dop.protocol_keys[e]].call(this,a,c):dop.on.reject.call(this,a,c),0===--this.requests[d].users&&delete this.requests[d])))},dop.observe=function(a){for(var b=0;b<a.length;b++){var c=a[b].object[dop.key_object_path].slice(0);c.push(a[b].name),"update"!=a[b].type&&"add"!=a[b].type||null===a[b].object[a[b].name]||"object"!=typeof a[b].object[a[b].name]||dop.configure.call(this,a[b].object[a[b].name],c,!0)}},dop.parse=function a(b){var c=this;return JSON.parse(b,function(b,d){if("string"==typeof d){if(d==c.options.stringify_undefined)return;if(a.parse_type_date.exec(d))return new Date(d);if(d.substr(0,c.options.stringify_regexp.length)==c.options.stringify_regexp){var e=/\/(.+)\/([gimuy]{0,5})/.exec(d.substr(c.options.stringify_regexp.length));return new RegExp(e[1],e[2])}}return d})},dop.parse.parse_type_date=/^\d\d\d\d-\d\d-\d\dT\d\d:\d\d:\d\d.\d\d\dZ$/,dop.protocol={fulfilled:0,connect:0,sync:1,unsync:2,call:3,set:4,"delete":5,request:6},dop.protocol_keys={};for(var key in dop.protocol)dop.protocol_keys[dop.protocol[key]]=key;dop.reject=function(){return dop.response("reject",arguments)},dop.remoteFunction=function(a){var b=this;return function(){return b.call(a,Array.prototype.slice.call(arguments))}},dop.request=function(a){var b=this.requests_inc++;return a.unshift(b),this.requests[b]={id:b,data:a,promise:new dop.util.promise,users:1}},dop.resolve=function(){return dop.response("resolve",arguments)},dop.response=function(a,b){var c;return dop.util.arguments(b,function(d){return c=d[d.length-1],c&&"object"==typeof c&&"function"==typeof c.resolve&&"function"==typeof c.reject&&"object"==typeof c.response&&c.resolved!==!0?(c[a].apply(c,b),c.resolved=!0,!0):!1})},dop.response.resolve=function(){this.response.push(Array.prototype.slice.call(arguments,0)),this.user.send(dop.stringify.call(this.user.dop,this.response))},dop.response.reject=function(a){this.response[1]=a,this.user.send(dop.stringify.call(this.user.dop,this.response))},dop.stringify=function(a){var b,c=this;return JSON.stringify(a,function(a,d){return b=typeof d,"undefined"==b?c.options.stringify_undefined:"function"==b&&d.name!==dop.name_remote_function?c.options.stringify_function:"object"==b&&d instanceof RegExp?c.options.stringify_regexp+d.toString():d})},dop.api.prototype.call=function(a,b){var c=[dop.protocol.call,a,b],d=dop.request.call(this,c);return this.send(dop.stringify.call(this,d.data)),d.promise},dop.api.prototype.connect=function(){return this.connector=this[this.options.connector.name_connector]=this.options.connector(this.options,{open:dop.on.open.bind(this),message:dop.on.message.bind(this),close:dop.on.close.bind(this),error:dop.on.error.bind(this)}),this.connected=new dop.util.promise,this.connected},dop.api.prototype["delete"]=function(a,b){return this.set(a,b)},dop[dop.side].prototype.request=function(){var a=[dop.protocol.request,Array.prototype.slice.call(arguments,0)],b=dop.request.call(this.dop,a);return this.send(dop.stringify.call(this,b.data)),b.promise},dop.api.prototype.set=function(a,b,c){"array"!=dop.util["typeof"](a[dop.key_object_path]);var d=a[b],e=a[dop.key_object_path].slice(0),f=[dop.protocol.set,e,d];e.push(b),3==arguments.length&&f.push(c);var g=dop.request.call(this,f);return this.send(dop.stringify.call(this,g.data)),g.promise},dop.api.prototype.sync=function(a,b){var c=new dop.util.promise;if(a=a.trim(),!b||"object"!=typeof b)throw new TypeError(dop.error.SYNC_MUST_BE_OBJECT);if(b&&"object"==typeof b&&"array"==dop.util["typeof"](b[dop.key_object_path]))throw new TypeError(dop.error.SYNC_NO_REPEAT);if("undefined"==typeof this.objects_name[a])this.objects_name[a]={object:b,promise:c};else{if("object"!=typeof this.objects_name[a].request||"undefined"!=typeof this.objects_name[a].object)throw new TypeError(dop.error.SYNC_NO_REPEAT_NAME);this.objects_name[a].promise=c,dop.on.sync.resolve.call(this,this.objects_name[a].request,b)}return this.objects_name[a].promise},dop._on.call=function(a,b){this.requests[-1*b[0]].promise.resolve.apply(this,b[2])},dop._on.connect=function(a,b){this.token=b[2],"object"==typeof b[3]&&("string"==typeof b[3][dop.stringify_function]&&(this.options.stringify_function=b[3][dop.stringify_function]),"string"==typeof b[3][dop.stringify_undefined]&&(this.options.stringify_undefined=b[3][dop.stringify_undefined]),"string"==typeof b[3][dop.stringify_regexp]&&(this.options.stringify_regexp=b[3][dop.stringify_regexp])),this.connected.resolve(this.token)},dop._on.request=function(a,b){this.requests[-1*b[0]].promise.resolve.apply(this,b[2])},dop.on.call=function(a,b){var c=[-1*b[0]];if("array"==dop.util["typeof"](b[2])){var d=b[2],e=d.shift();if("object"==typeof this.objects[e]){var f=dop.util.get(this.objects[e].object,d);if("function"==typeof f){c.push(dop.protocol.fulfilled);var g=b[3],h={request:b,response:c,user:a};return h.resolve=dop.response.resolve.bind(h),h.reject=dop.response.reject.bind(h),g.push(h),f.apply(this.objects[e].object,g)}}}c.push(dop.error.REJECT_CALL_NOT_EXISTS),a.send(JSON.stringify(c))},dop.on.close=function(){this.emit("close")},dop.on.error=function(a){this.emit("error",a)},dop.on.message=function(a){var b;if("string"==typeof a)try{b=dop.parse.call(this,a)}catch(c){}else b=a;this.emit("message",b,a),"array"==dop.util["typeof"](b)&&dop.manage.call(this,this,b)},dop.on.open=function(){var a=dop.request.call(this,[]);a.data.push(dop.protocol.connect),this.send(JSON.stringify(a.data))},dop.on.reject=function(a,b){this.requests[-1*b[0]].promise.reject.call(this,b[1])},dop.on.request=function(a,b){var c=[-1*b[0],dop.protocol.fulfilled],d={request:b,response:c,user:a};d.resolve=dop.response.resolve.bind(d),d.reject=dop.response.reject.bind(d);var e=["request"];e=e.concat(b[2]),e.push(d),this.emit.apply(this,e)},dop.on.sync=function(a,b){var c=b[5],d=b[4];"object"==typeof this.objects_name[c]?("object"==typeof this.objects_name[c].object&&(d=this.objects_name[c].object),dop.on.sync.resolve.call(this,b,this.objects_name[c].object)):this.objects_name[c]={request:b},this.emit("sync",c,d,b[2],1===b[3])},dop.on.sync.resolve=function(a,b){var c,d=-1*a[0],e=a[2],f=1===a[3],g=a[4],h=a[5];b&&"object"==typeof b?(c=dop.stringify.call(this,[d,dop.protocol.fulfilled,b]),c=c.replace(/,\s*(({\s*}\s*])|(\[\s*\]\s*]))$/,"]"),b=dop.util.merge(b,g)):(b=g,c=dop.stringify.call(this,[d,dop.protocol.fulfilled])),dop.configure.call(this,b,[e],f),this.objects[e]={object:b,name:h,writable:f},this.objects_name[h].object=b,this.objects_name[h].promise.resolve(b,e,f),this.send(c)},dop.socketio=function(a,b){var c=dop.socketio.api(a.url);return c.on("connect",function(){b.open()}),c.on("message",function(a){b.message(a)}),c.on("disconnect",function(){b.close()}),c.on("error",function(a){b.error(a)}),c},dop.socketio.name_connector="socketio",dop.socketio.api=window.io,dop.SockJS=function(a,b){var c=new dop.SockJS.api(a.url,void 0,a);return c.addEventListener("open",function(){b.open()}),c.addEventListener("message",function(a){b.message(a.data)}),c.addEventListener("close",function(){b.close()}),c.addEventListener("error",function(a){b.error(a)}),c},dop.SockJS.name_connector="SockJS",dop.SockJS.api=window.SockJS,dop.ws=function(a,b){var c=a.ssl?"wss":"ws",d=new WebSocket(c+"://"+a.host+"/"+a.prefix);return d.addEventListener("open",function(){b.open()}),d.addEventListener("message",function(a){b.message(a.data)}),d.addEventListener("close",function(){b.close()}),d.addEventListener("error",function(a){b.error(a)}),d},dop.ws.name_connector="ws",dop.ws.api=WebSocket;