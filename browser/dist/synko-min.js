"strict";var synko={version:"0.7.1",name:"synko",side:"api",key_object_path:"~PATH",stringify_function:"~F",stringify_undefined:"~U",stringify_regexp:"~R",name_remote_function:"$SYNKO_REMOTE_FUNCTION",util:{},on:{},_on:{},objects:{}};"object"==typeof module&&module&&(module.exports=synko),synko.util.arguments=function(a,b){for(var c=a;"function"==typeof c.callee.caller;){if(b(c.callee.caller.arguments))return a[0];c=c.callee.caller.arguments}return a[0]},synko.util.emitter=function(){this._events={}},synko.util.emitter.prototype.on=synko.util.emitter.prototype.addListener=function(a,b,c){return"function"==typeof b&&("object"!=typeof this._events&&(this._events={}),"object"!=typeof this._events[a]&&(this._events[a]=[]),this._events[a].push(c===!0?[b,!0]:[b])),this},synko.util.emitter.prototype.once=synko.util.emitter.prototype.addOnceListener=function(a,b){return this.on(a,b,!0)},synko.util.emitter.prototype.emit=function(a){if("object"==typeof this._events[a]&&this._events[a].length>0){for(var b=0,c=[],d=Array.prototype.slice.call(arguments,1);b<this._events[a].length;b++)c.push(this._events[a][b][0]),this._events[a][b][1]===!0&&(this._events[a].splice(b,1),b-=1);for(b=0;b<c.length;b++)c[b].apply(this,d)}return this},synko.util.emitter.prototype.removeListener=function(a,b){if("object"==typeof this._events[a]&&this._events[a].length>0)for(var c=0;c<this._events[a].length;c++)this._events[a][c][0]===b&&(this._events[a].splice(c,1),c-=1);return this},synko.util.get=function(a,b,c){for(var d,e=0,f=b.length;f>e;e++)if(d=synko.util["typeof"](a[b[e]]),f>e+1&&null!==a[b[e]]&&("object"==d||"array"==d))a=a[b[e]];else{if(a.hasOwnProperty(b[e]))return a[b[e]];if(!c||!c(a,b[e],e))return;a[b[e]]={}}return a[b[e]]},synko.util.merge=function(){return function a(b,c){var d,e,f,g,h=arguments;if(h.length<2)return b;if(h.length>2)return Array.prototype.splice.call(h,0,2,a(b,c)),a.apply(this,h);for(d in c)d in c&&(f=b[d],e=c[d],e!==b&&(null===e||"object"!=typeof e&&!Array.isArray(e)||e instanceof Date||e instanceof RegExp?b[d]=e:"object"==typeof f&&null!==f?(g=f,b[d]=a(g,e)):(g=Array.isArray(e)?[]:{},b[d]=a(g,e))));return b}}(),synko.util.path=function(a,b){synko.util.path.recursive.call({circular:[]},a,b,[])},synko.util.path.recursive=function(a,b,c){for(var d in a){if(c.push(d),0==this.stop)return;this.stop=b(c,a[d],d,a),a[d]&&"object"==typeof a[d]&&a[d]!==a&&-1==this.circular.indexOf(a[d])&&(this.circular.push(a[d]),synko.util.path.recursive.call(this,a[d],b,c)),c.pop()}},synko.util.promise=function(a){function b(a,b){f.length>0?c.call(h,0,a,b):setTimeout(function(){c.call(h,0,a,b)},0)}function c(a,b,e){var g=a+1;if("object"==typeof f[a]&&"function"==typeof f[a][h.type]){try{e=[f[a][h.type].apply(f[a][h.type].hasToGoUp?h:b,e)],h.type&&!d&&(h.type=0)}catch(i){h.type=1,e=[i]}if(e[0]===h)h.type=1,e[0]=new TypeError("Promise resolved by its own instance");else if(e[0]instanceof h.constructor){var j=function(){h.type=this.type,c.call(h,g,b,arguments)};return j.hasToGoUp=!0,void e[0].then(j,j)}}g<f.length&&c(g,b,e)}var d,e,f=[],g=0,h=this;this.state=g,this.then=function(a,b){return"function"==typeof a&&f.push([a]),"function"==typeof b&&f.push([void 0,b]),this},this["catch"]=function(a){return h.then(0,a)},this.completed=function(a){return e=a,h},this.resolve=function(){return 3===g?h:(g=h.state=1,d=h.type=0,void b(this,arguments))},this.reject=function(){return 3===g?h:(g=h.state=2,d=h.type=1,void b(this,arguments))},h.onCompleted=function(){g=h.state=3,"function"==typeof e&&e.apply(this,arguments)},"function"==typeof a&&a(h.resolve,h.reject)},synko.util["typeof"]=function(a){var b=typeof a;return"object"==b&&(a?Array.isArray(a)?b="array":a instanceof Date?b="date":a instanceof RegExp&&(b="regexp"):b="null"),b},synko.create=function(a){return new synko.api(a)},synko.api=function(a){"object"!=synko.util["typeof"](a)&&(a={}),"function"!=typeof a.connector&&(a.connector=synko.ws),"string"!=typeof a.url&&(a.url=window.location.href);var b=/(ps|ss)?:\/\/([^\/]+)?(?:\/([^\/]+))?/.exec(a.url);"string"==typeof b[3]&&(a.prefix=b[3]),"string"!=typeof a.prefix&&(a.prefix=synko.name),a.prefix+=a.connector.name_connector,"undefined"==typeof b[3]?("/"!==a.url[a.url.length-1]&&(a.url+="/"),a.url+=a.prefix):a.url+=a.connector.name_connector,a.host=b[2],a.ssl="string"==typeof b[1]&&("ps"===b[1].toLowerCase()||"ss"===b[1].toLowerCase()),this.options=a,this.options.stringify_function=synko.stringify_function,this.options.stringify_undefined=synko.stringify_undefined,this.options.stringify_regexp=synko.stringify_regexp,this.objects={},this.objects_name={},this.requests_inc=1,this.requests={},this.synko=this,this.observe=synko.observe.bind(this),this.send=function(a){this.connector.send(a)},this.close=function(){this.connector.close()},synko.util.emitter.call(this)},synko.api.prototype=Object.create("function"==typeof EventEmitter?EventEmitter.prototype:synko.util.emitter.prototype),synko.configure=function(a,b,c){var d=this;Object.defineProperty(a,synko.key_object_path,{value:b}),synko.util.path(a,function(a,c,e,f){var g=b.concat(a);c===d.options.stringify_function&&(f[e]=synko.remoteFunction.call(d,g)),null!==c&&"object"==typeof c&&"undefined"==typeof c[synko.key_object_path]&&Object.defineProperty(c,synko.key_object_path,{value:g})})},synko.error={SYNC_MUST_BE_OBJECT:'The property "object" of the method sync() only accept Objects',SYNC_NO_REPEAT_NAME:"You can not sync different objects with the same name",SYNC_NO_REPEAT:"You can not sync the same object more than once",REJECT_CALL_NOT_EXISTS:"You are trying to call a function does not exists",API_PARAMETER_CREATE_URL:"You must pass url as first parameter"},synko.observe=function(a){for(var b=0;b<a.length;b++){var c=a[b].object[synko.key_object_path].slice(0);c.push(a[b].name),"update"!=a[b].type&&"add"!=a[b].type||null===a[b].object[a[b].name]||"object"!=typeof a[b].object[a[b].name]||synko.configure.call(this,a[b].object[a[b].name],c,!0)}},synko.osp=function(a,b){"object"!=typeof b[0]&&(b=[b]);for(var c,d,e,f=0,g=b.length;g>f;f++)c=b[f],d=c[0],e=c[1],"number"==typeof d&&(d>0&&"function"==typeof synko.on[synko.protocol_keys[e]]?synko.on[synko.protocol_keys[e]].call(this,a,c):(d*=-1,null!==this.requests[d]&&"object"==typeof this.requests[d]&&(e=this.requests[d].data[1],0===c[1]?synko._on[synko.protocol_keys[e]].call(this,a,c):synko.on.reject.call(this,a,c),0===--this.requests[d].users&&delete this.requests[d])))},synko.parse=function a(b){var c=this;return JSON.parse(b,function(b,d){if("string"==typeof d){if(d==c.options.stringify_undefined)return;if(a.parse_type_date.exec(d))return new Date(d);if(d.substr(0,c.options.stringify_regexp.length)==c.options.stringify_regexp){var e=/\/(.+)\/([gimuy]{0,5})/.exec(d.substr(c.options.stringify_regexp.length));return new RegExp(e[1],e[2])}}return d})},synko.parse.parse_type_date=/^\d\d\d\d-\d\d-\d\dT\d\d:\d\d:\d\d.\d\d\dZ$/,synko.protocol={fulfilled:0,connect:0,request:1,sync:2,unsync:3,call:4,set:5},synko.protocol_keys={};for(var key in synko.protocol)synko.protocol_keys[synko.protocol[key]]=key;synko.reject=function(){return synko.response("reject",arguments)},synko.remoteFunction=function(a){var b=this;return function(){return b.call(a,Array.prototype.slice.call(arguments))}},synko.request=function(a){var b=this.requests_inc++;return a.unshift(b),this.requests[b]={id:b,data:a,promise:new synko.util.promise,users:1}},synko.resolve=function(){return synko.response("resolve",arguments)},synko.response=function(a,b){var c;return synko.util.arguments(b,function(d){return c=d[d.length-1],c&&"object"==typeof c&&"function"==typeof c.resolve&&"function"==typeof c.reject&&"object"==typeof c.response&&c.resolved!==!0?(c[a].apply(c,b),c.resolved=!0,!0):!1})},synko.response.resolve=function(){this.response.push(Array.prototype.slice.call(arguments,0)),this.user.send(synko.stringify.call(this.user.synko,this.response))},synko.response.reject=function(a){this.response[1]=a,this.user.send(synko.stringify.call(this.user.synko,this.response))},synko.stringify=function(a){var b,c=this;return JSON.stringify(a,function(a,d){return b=typeof d,"undefined"==b?c.options.stringify_undefined:"function"==b&&d.name!==synko.name_remote_function?c.options.stringify_function:"object"==b&&d instanceof RegExp?c.options.stringify_regexp+d.toString():d})},synko.api.prototype.call=function(a,b){var c=[synko.protocol.call,a,b],d=synko.request.call(this,c);return this.send(synko.stringify.call(this,d.data)),d.promise},synko.api.prototype.connect=function(){return this.connector=this[this.options.connector.name_connector]=this.options.connector(this.options,{open:synko.on.open.bind(this),message:synko.on.message.bind(this),close:synko.on.close.bind(this),error:synko.on.error.bind(this)}),this.connected=new synko.util.promise,this.connected},synko.api.prototype["delete"]=function(a,b){return this.set(a,b)},synko[synko.side].prototype.request=function(){var a=[synko.protocol.request,Array.prototype.slice.call(arguments,0)],b=synko.request.call(this.synko,a);return this.send(synko.stringify.call(this,b.data)),b.promise},synko.api.prototype.set=function(a,b,c){"array"!=synko.util["typeof"](a[synko.key_object_path]);var d=a[b],e=a[synko.key_object_path].slice(0),f=[synko.protocol.set,e,d];e.push(b),3==arguments.length&&f.push(c);var g=synko.request.call(this,f);return this.send(synko.stringify.call(this,g.data)),g.promise},synko.api.prototype.sync=function(a,b){var c=new synko.util.promise;if(a=a.trim(),!b||"object"!=typeof b)throw new TypeError(synko.error.SYNC_MUST_BE_OBJECT);if(b&&"object"==typeof b&&"array"==synko.util["typeof"](b[synko.key_object_path]))throw new TypeError(synko.error.SYNC_NO_REPEAT);if("undefined"==typeof this.objects_name[a])this.objects_name[a]={object:b,promise:c};else{if("object"!=typeof this.objects_name[a].request||"undefined"!=typeof this.objects_name[a].object)throw new TypeError(synko.error.SYNC_NO_REPEAT_NAME);this.objects_name[a].promise=c,synko.on.sync.resolve.call(this,this.objects_name[a].request,b)}return this.objects_name[a].promise},synko._on.call=function(a,b){this.requests[-1*b[0]].promise.resolve.apply(this,b[2])},synko._on.connect=function(a,b){this.token=b[2],"object"==typeof b[3]&&("string"==typeof b[3][synko.stringify_function]&&(this.options.stringify_function=b[3][synko.stringify_function]),"string"==typeof b[3][synko.stringify_undefined]&&(this.options.stringify_undefined=b[3][synko.stringify_undefined]),"string"==typeof b[3][synko.stringify_regexp]&&(this.options.stringify_regexp=b[3][synko.stringify_regexp])),this.connected.resolve(this.token)},synko._on.request=function(a,b){this.requests[-1*b[0]].promise.resolve.apply(this,b[2])},synko.on.call=function(a,b){var c=[-1*b[0]];if("array"==synko.util["typeof"](b[2])){var d=b[2],e=d.shift();if("object"==typeof this.objects[e]){var f=synko.util.get(this.objects[e].object,d);if("function"==typeof f){c.push(synko.protocol.fulfilled);var g=b[3],h={request:b,response:c,user:a};return h.resolve=synko.response.resolve.bind(h),h.reject=synko.response.reject.bind(h),g.push(h),f.apply(this.objects[e].object,g)}}}c.push(synko.error.REJECT_CALL_NOT_EXISTS),a.send(JSON.stringify(c))},synko.on.close=function(){this.emit("close")},synko.on.error=function(a){this.emit("error",a)},synko.on.message=function(a){var b;if("string"==typeof a)try{b=synko.parse.call(this,a)}catch(c){}else b=a;this.emit("message",b,a),"array"==synko.util["typeof"](b)&&synko.osp.call(this,this,b)},synko.on.open=function(){var a=synko.request.call(this,[]);a.data.push(synko.protocol.connect),this.send(JSON.stringify(a.data))},synko.on.reject=function(a,b){this.requests[-1*b[0]].promise.reject.call(this,b[1])},synko.on.request=function(a,b){var c=[-1*b[0],synko.protocol.fulfilled],d={request:b,response:c,user:a};d.resolve=synko.response.resolve.bind(d),d.reject=synko.response.reject.bind(d);var e=["request"];e=e.concat(b[2]),e.push(d),this.emit.apply(this,e)},synko.on.sync=function(a,b){var c=b[5],d=b[4];"object"==typeof this.objects_name[c]?("object"==typeof this.objects_name[c].object&&(d=this.objects_name[c].object),synko.on.sync.resolve.call(this,b,this.objects_name[c].object)):this.objects_name[c]={request:b},this.emit("sync",c,d,b[2],1===b[3])},synko.on.sync.resolve=function(a,b){var c,d=-1*a[0],e=a[2],f=1===a[3],g=a[4],h=a[5];b&&"object"==typeof b?(c=synko.stringify.call(this,[d,synko.protocol.fulfilled,b]),c=c.replace(/,\s*(({\s*}\s*])|(\[\s*\]\s*]))$/,"]"),b=synko.util.merge(b,g)):(b=g,c=synko.stringify.call(this,[d,synko.protocol.fulfilled])),synko.configure.call(this,b,[e],f),this.objects[e]={object:b,name:h,writable:f},this.objects_name[h].object=b,this.objects_name[h].promise.resolve(b,e,f),this.send(c)},synko.socketio=function(a,b){var c=synko.socketio.api(a.url);return c.on("connect",function(){b.open()}),c.on("message",function(a){b.message(a)}),c.on("disconnect",function(){b.close()}),c.on("error",function(a){b.error(a)}),c},synko.socketio.name_connector="socketio",synko.socketio.api=window.io,synko.SockJS=function(a,b){var c=new synko.SockJS.api(a.url,void 0,a);return c.addEventListener("open",function(){b.open()}),c.addEventListener("message",function(a){b.message(a.data)}),c.addEventListener("close",function(){b.close()}),c.addEventListener("error",function(a){b.error(a)}),c},synko.SockJS.name_connector="SockJS",synko.SockJS.api=window.SockJS,synko.ws=function(a,b){var c=a.ssl?"wss":"ws",d=new WebSocket(c+"://"+a.host+"/"+a.prefix);return d.addEventListener("open",function(){b.open()}),d.addEventListener("message",function(a){b.message(a.data)}),d.addEventListener("close",function(){b.close()}),d.addEventListener("error",function(a){b.error(a)}),d},synko.ws.name_connector="ws",synko.ws.api=WebSocket;